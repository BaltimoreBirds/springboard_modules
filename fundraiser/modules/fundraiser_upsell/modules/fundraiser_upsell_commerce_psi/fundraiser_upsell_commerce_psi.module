<?php
/**
 * @file
 * Handles immediate offsite recurring for the PSI gateway..
 */

/**
 * Implements hook_upsell_master_donation_alter().
 *
 * Remove the sustainers table record since we will be processing the donation
 * immediately.
 *
 * Processes the donation, which will eventually get to the charge function.
 * It will see that this is a master donation in an upsell and hand it off
 * to the SendUpsell API call instead of the normal charging.
 *
 * Then the donation will get updated and normal success or declien hooks will
 * get called.
 */
function fundraiser_upsell_commerce_psi_upsell_master_donation_alter(&$donation) {
  _fundraiser_sustainers_delete_recurring($donation->did);

  // Process the donation.  Since it references the original donation,
  // we don't need payment info.
  fundraiser_donation_process($donation);
  if (!isset($donation->result['message'])) {
    $donation->result['message'] = '';
  }
  // The results should be at $donation->result.
  if (isset($donation->result['success']) && $donation->result['success']) {
    fundraiser_donation_success($donation);
  }
  else {
    fundraiser_donation_decline($donation);
  }

  // Refresh the donation with new transaction data.
  $donation = fundraiser_donation_get_donation($donation->did, TRUE);
}
