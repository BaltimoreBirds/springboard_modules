<?php

/**
 * @file
 * Data warehousing functionality for Fundraiser.
 */

/**
 * Implements hook_cron_queue_info()
 */
function fundraiser_data_warehousing_cron_queue_info() {
  $queues['data_warehouse_donation_ids'] = array(
    'worker callback' => 'fundraiser_data_warehousing_send_donation_data',
    'time' => 120,
  );

  $queues['data_warehouse_sustainer_donation_ids'] = array(
    'worker callback' => 'fundraiser_data_warehousing_send_sustainer_donation_data',
    'time' => 120,
  );

  return $queues;
}

/**
 * Implements hook_cron()
 */
function fundraiser_data_warehousing_cron() {
  $last_update_time = variable_get('fundraiser_data_warehousing_last_update', 0);

  $query = db_select('fundraiser_sustainers', 's');
  $query->fields('s', array('did'));
  $query->join('fundraiser_donation', 'd', 's.did = d.did');
  $query->condition('d.created', $last_update_time, '>');
  $query->orderBy('s.did', 'ASC');

  $result = $query->execute();

  $sustainer_queue = DrupalQueue::get('data_warehouse_sustainer_donation_ids');

  $sustainer_ids = array();

  while ($record = $result->fetchAssoc()) {
    $sustainer_ids[] = $record['did'];
    $sustainer_queue->createItem($record['did']);
  }

  $donation_queue = DrupalQueue::get('data_warehouse_donation_ids');

  $result = db_select('fundraiser_donation')
      ->fields('fundraiser_donation', array('did'))
      ->condition('created', $last_update_time, '>')
      ->condition('did', $sustainer_ids, 'NOT IN')
      ->orderBy('did', 'ASC')
      ->execute();

  while ($record = $result->fetchAssoc()) {
    $donation_queue->createItem($record['did']);
  }

  variable_set('fundraiser_data_warehousing_last_update', time());
}

/**
 * Sends an array of formatted donation data to the data warehouse.
 *
 * @param int $donation_id
 *   The ID of the donation to send.
 */
function fundraiser_data_warehousing_send_donation_data($donation_id) {
  $donation = fundraiser_donation_get_donation($donation_id);

  if (!empty($donation)) {
    $donation_data = fundraiser_data_warehousing_get_formatted_donation_data($donation);
    springboard_data_warehousing_send_data($donation_data, '/one-time');
  }
}

/**
 * Sends an array of formatted sustainer donation data to the data warehouse.
 *
 * @param int $donation_id
 *   The ID of the donation to send.
 */
function fundraiser_data_warehousing_send_sustainer_donation_data($donation_id) {
  $donation = fundraiser_donation_get_donation($donation_id);

  if (!empty($donation)) {
    $sustainer_donation = _fundraiser_sustainers_get_recurring_by_did($donation_id);

    $donation_data = fundraiser_data_warehousing_get_formatted_donation_data($donation);

    $donation_data['master_did'] = $sustainer_donation->master_did;
    $donation_data['next_charge'] = $sustainer_donation->next_charge;
    $donation_data['sustainer_key'] = $sustainer_donation->sustainer_key;

    springboard_data_warehousing_send_data($donation_data, '/one-time');
  }
}

/**
 * Creates an array of donation data to send to the data warehouse.
 *
 * @param object $donation
 *   The donation object to use as a data source.
 *
 * @return array
 *   Array of donation data.
 */
function fundraiser_data_warehousing_get_formatted_donation_data($donation) {
  $donation_data = array(
    'nid' => $donation->nid,
    'sid' => $donation->sid,
    'uid' => $donation->uid,
    'did' => $donation->did,
    'amount' => $donation->amount,
    'currency' => $donation->currency,
    'first_name' => $donation->donation['first_name'],
    'last_name' => $donation->donation['last_name'],
    'mail' => $donation->donation['mail'],
    'address' => $donation->donation['address'],
    'address_line_2' => $donation->donation['address_line_2'],
    'city' => $donation->donation['city'],
    'country' => $donation->donation['country'],
    'state' => $donation->donation['state'],
    'zip' => $donation->donation['zip'],
    'gateway' => $donation->gateway['id'],
    'txn_id' => isset($donation->data['txn_id']) ? $donation->data['txn_id'] : NULL,
    'status' => $donation->status,
  );

  drupal_alter('fundraiser_data_housing_donation_data', $donation_data);

  return $donation_data;
}
