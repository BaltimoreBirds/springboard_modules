<?php
/**
 * @file
 * Data warehousing functionality for Fundraiser.
 */

/**
 * Implements hook_menu()
 */
function fundraiser_data_warehousing_menu() {
  $items = array();

  $items['admin/springboard/options/fundraiser/data_warehousing'] = array(
    'title' => 'Data warehousing settings',
    'description' => 'Administer data warehousing settings.',
    'access arguments' => array('administer fundraiser data warehousing'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fundraiser_data_warehousing_admin_settings_form'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/fundraiser_data_warehousing.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_permission()
 */
function fundraiser_data_warehousing_permission() {
  return array(
    'administer fundraiser data warehousing' => array(
      'title' => t('Administer fundraiser data warehousing'),
      'description' => t('Perform administration tasks for fundraiser data warehousing.'),
    ),
  );
}

/**
 * Implements hook_fundraiser_donation_success()
 */
function fundraiser_data_warehousing_fundraiser_donation_success($donation) {
  $donation_data = fundraiser_data_warehousing_get_formatted_donation_data($donation);

  fundraiser_data_warehousing_send_data($donation_data);
}

/**
 * Implements hook_fundraiser_sustainers_create_recurring()
 */
function fundraiser_data_warehousing_fundraiser_sustainers_create_recurring($recurring_data) {
  $original_recurring = _fundraiser_sustainers_get_recurring_by_did($recurring_data['did']);
  $recurring_donation = fundraiser_donation_get_donation($recurring_data['did']);

  if (!empty($original_recurring->master_did)) {
    $master_donation = fundraiser_donation_get_donation($original_recurring->master_did);

    $donation_data = fundraiser_data_warehousing_get_formatted_donation_data($master_donation);

    // Overwrite original donation data with of recurring donation data.
    $donation_data['did'] = $recurring_donation->did;
    $donation_data['status'] = $recurring_donation->status;

    // Add sustainer-specific data.
    $donation_data['master_did'] = $original_recurring->master_did;
    $donation_data['next_charge'] = $recurring_data['next_charge'];
    $donation_data['sustainer_key'] = isset($recurring_data['sustainer_key']) ? $recurring_data['sustainer_key'] : NULL;

    fundraiser_data_warehousing_send_data($donation_data);
  }
}

/**
 * Implements hook_fundraiser_sustainers_update_recurring()
 */
function fundraiser_data_warehousing_fundraiser_sustainers_update_recurring($recurring_donation) {
  // TODO: Remove original record from data warehouse?

  fundraiser_data_warehousing_fundraiser_sustainers_create_recurring($recurring_donation);
}

function fundraiser_data_warehousing_send_data($donation_data) {
  $donation_json = json_encode($donation_data);

  watchdog('fundraiser_data_warehousing', 'Sending data: ' . $donation_json);

  $post_fields = array(
    'donation' => $donation,
  );

  // TODO: Put data warehouse URL into admin page.
  $url = '';

  $ch = curl_init($url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
  curl_setopt($ch, CURLOPT_POST, 1);
  curl_setopt($ch, CURLOPT_POST, $post_fields);

  $response = curl_exec($ch);
  curl_close($ch);

  watchdog('fundraiser_data_warehousing', 'Data warehouse response: ' . $response);
}

function fundraiser_data_warehousing_get_formatted_donation_data($donation) {
  $donation_data = array(
    'nid' => $donation->nid,
    'sid' => $donation->sid,
    'uid' => $donation->uid,
    'did' => $donation->did,
    'amount' => $donation->amount,
    'currency' => $donation->currency,
    'first_name' => $donation->donation['first_name'],
    'last_name' => $donation->donation['last_name'],
    'mail' => $donation->donation['mail'],
    'address' => $donation->donation['address'],
    'address_line_2' => $donation->donation['address_line_2'],
    'city' => $donation->donation['city'],
    'country' => $donation->donation['country'],
    'state' => $donation->donation['state'],
    'zip' => $donation->donation['zip'],
    'gateway' => $donation->gateway['id'],
    'txn_id' => $donation->data['txn_id'],
    'remote_id' => $donation->data['remote_id'],
    'status' => $donation->status,
  );

  return $donation_data;
}

