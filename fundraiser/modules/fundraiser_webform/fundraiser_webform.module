<?php

/**
 * @file
 * Field management functions for the fundraiser module
 */

// Include the user related code for fundraiser_webform.
// This code duplicates much of the behavior of webform_user.
// Future development should merge the two.
include('fundraiser_webform.user.inc');

/**
 * Implements hook_menu().
 */
function fundraiser_webform_menu() {
  // Future updates should merge this code with webform_user.
  // Which would eliminate the need for this mapping page.
  $items['node/%node/webform/mapping'] = array(
    'title' => 'User map',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fundraiser_webform_mapping_form', 1),
    'access callback' => 'fundraiser_webform_mapping_form_access',
    'access arguments' => array(1),
    'weight' => 30,
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function fundraiser_webform_menu_alter(&$items) {
  // Move fundraisers confirmation paths to webform menu paths, for UI.
  $items['node/%node/webform/confirmations'] = $items['node/%node/fundraiser/confirmations'];
  $items['node/%node/webform/confirmations']['type'] = MENU_LOCAL_TASK; 
  unset($items['node/%node/fundraiser']);
  unset($items['node/%node/fundraiser/confirmations']);
  // Alter some built-in webform menu items.
  $items['node/%webform_menu/webform/configure']['access callback'] = 'fundraiser_webform_configure_access';
  $items['node/%webform_menu/webform/configure']['access arguments'] = array('update', 1);
}

/**
 * Menu access callback, returns TRUE if current node is a donation form.
 */
function fundraiser_webform_mapping_form_access($node) {
  return _fundraiser_is_donation_type($node->type); // From fundraiser.module.
}

/**
 * Menu access callback. Permission check for donation form settings tab.
 */
function fundraiser_webform_configure_access($perm, $node) {
  // Don't show the 'Form settings' tab on donation forms.
  if (_fundraiser_is_donation_type($node->type)) { // From fundraiser.module.
    return FALSE;
  }
  else {
    return node_access($perm, $node);
  }
}

/**
 * Implementation of hook_webform_select_options_info() from Webform.
 * From http://drupalcontrib.org/api/drupal/contributions!webform!webform_hooks.php/function/hook_webform_select_options_info/7
 */
//TODO - this will take a lot more thought. These options should ultimately come from ubercart, but webform is to be blind to
// UC, and this concept is something fundraiser ought to be blind to as well.
function fundraiser_webform_webform_select_options_info() {
  $items = array();
  $items['fundraiserstates'] = array(
    'title' => t('Fundraiser defined states'),
    'options callback' => 'fundraiser_webform_options_states',
  );
  $items['fundraiser_countries'] = array(
    'title' => t('Fundraiser defined countries'),
    'options callback' => 'fundraiser_webform_options_countries',
  );
  return $items;
}

/**
 * Implements hook_webform_submission_presave().
 */
function fundraiser_webform_webform_submission_presave($node, &$submission) {
  // Remove any non-component form fields from the submitted data.
  unset($submission->data['']);
  // Remove senstive form data before the submission is saved to the database.
  if ($node->type == 'donation_form') {
    $results = _fundraiser_webform_get_cid_by_keys($node->nid, array('card_number', 'card_cvv', 'card_expiration_date'));
    foreach ($results as $result) {
     // $submission->data[$result->cid]['value'][0] = NULL;
      // TODO find out why this is commented out.
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
// Alter the webform component delete form to prevent the deletion of required fundraiser fields
// Why not handle this by remving delete options from the interface? Because edit/delete operations are added at theme layer.
// Unfortunately the theme layer adds the values and immediately renders, negating any chance for us to make changes.
// In order to remove delete properly, we will need a patch in webform addressing this issue.
function fundraiser_webform_form_webform_component_delete_form_alter(&$form, &$form_state, $form_id) {
  // Make sure we are dealing with a donation form.
  if (_fundraiser_is_donation_type($form['node']['#value']->type)) { // From fundraiser.module.
    // Check vs. required fields to make sure we can't delete them.
    $required_fields = _fundraiser_webform_required_fields();
    $cid = $form['component']['#value']['cid'];
    $component = $form['node']['#value']->webform['components'][$cid];
    // Check to see if the form_key is in our required fields array
    if (in_array($component['form_key'], $required_fields)) {
      $message = t('<strong>!name</strong> is a required fundraiser field and cannot be deleted from this form.',
        array('!name' => $component['name']));
      $form['description']['#markup'] = $message;
      unset($form['actions']['submit']);
    }
  }
}

/**
 * Implements hook_form_alter().
 * Why hook_form_alter and not hook_form_FORM_ID_alter? Because webform's form id varies: webform_client_form_NID.
 */
function fundraiser_webform_form_alter(&$form, $form_state, $form_id) {
  // Alter the webform client form.
  if (strstr($form_id, 'webform_client_form') !== FALSE) {
    // Handle donation form edit submission pg.
    if (_fundraiser_is_donation_type($form['#node']->type) && arg(2) == 'submission') { // From fundraiser.module.
      fundraiser_webform_submission_display($form, $form_state);
    }
    // Handle the donation form display.
    if (_fundraiser_is_donation_type($form['#node']->type)  && arg(2) != 'submission') { // From fundraiser.module.
      // From fundraiser.module, calls hooks to create form and submission paths.
      $form = fundraiser_donation_form($form, $form_state); // From fundraiser.module.
    }
  }
  return $form;
}

/**
 * Form, alters the display of webform submissions.
 */
function fundraiser_webform_submission_display(&$form, &$form_state) {
  // Set up a view only display of the donation amount.
  if ('other' != $form['submitted']['donation']['amount']['#default_value']) {
    $amount = $form['submitted']['donation']['amount']['#default_value'];
  }
  else {
    $amount = $form['submitted']['donation']['other_amount']['#default_value'];
  }
  // Add new fields.
  $form['submitted']['donation']['display_amount'] = array(
    '#markup' => '<div class="form-item"><label>' . t('Donation Amount') .
      ':</label>' . '$' . number_format($amount, 2) . '</div>',
  );
  // Show whether or not it's a recurring donation
  if (isset($form['submitted']['credit_card_information']['recurs_monthly'])) {
    $recurs = t('No');
    if (isset($form['submitted']['credit_card_information']['recurs_monthly']['#default_value'][0])
      && ($form['submitted']['credit_card_information']['recurs_monthly']['#default_value'][0] == 'recurs')) {
      $recurs = t('Yes'); 
    }
    $form['submitted']['donation']['recurring'] = array(
      '#markup' => '<div class="form-item"><label>' . t('Recurring Donation?') .
        ':</label>' . $recurs . '</div>',
    );
  }

  // Clean up the donor info section - replace the form fields with read only info
  $form['submitted']['donor_information']['#title'] = t('Donor Information');
  $form['submitted']['donor_information']['first_name_readonly'] = array(
    '#markup' => '<div class="form-item"><label>' . t('First Name') . ':</label>' .
      $form['submitted']['donor_information']['first_name']['#default_value'] . '</div>',
  );
  $form['submitted']['donor_information']['last_name_readonly'] = array(
    '#markup' => '<div class="form-item"><label>' . t('Last Name') . ':</label>' .
      $form['submitted']['donor_information']['last_name']['#default_value'] . '</div>',
  );
  $form['submitted']['donor_information']['email_readonly'] = array(
    '#markup' => '<div class="form-item"><label>' . t('Email') . ':</label>' .
      $form['submitted']['donor_information']['email']['#default_value'] . '</div>',
  );
  $form['submitted']['donor_information']['first_name']['#prefix'] =
    $form['submitted']['donor_information']['last_name']['#prefix'] =
      $form['submitted']['donor_information']['email']['#prefix'] = '<div style="display:none">';
  $form['submitted']['donor_information']['first_name']['#suffix'] =
    $form['submitted']['donor_information']['last_name']['#suffix'] =
      $form['submitted']['donor_information']['email']['#suffix'] = '</div>';

  // Remove sections no one really needs to see here.
  unset($form['submitted']['donation']['amount']);
  unset($form['submitted']['donation']['other_amount']);
  unset($form['submitted']['credit_card_information']);
}

/**
 * Implements hook_fundraiser_donation_form().
 */
function fundraiser_webform_fundraiser_donation_form($form, $form_state, $context) {
  // Loads profile fields in addition to base user data, and de-couples logged in user object.
  global $user;
  $this_user = user_load($user->uid);
  $node = node_load($form['#node']->nid);

  // Create a data structure that will tell us exactly where each webform component lives in the FAPI array.
  $components = $node->webform['components'];
  $component_hierarchy = _fundraiser_webform_parse_components($node->nid, $components);

  $base = drupal_get_path('module', 'fundraiser_webform');
  drupal_add_js( $base . '/js/jquery.alphanumeric.js', 'file');
  drupal_add_js( $base . '/js/fundraiser.js', 'file');
  drupal_add_css( $base . '/css/fundraiser-donation-form.css', 'file');

  // Preload any fields if the user is logged in.
  // TODO move to another module for fundraiser_profile and hook here??
  if (user_is_logged_in()) {
    // Load up any mapped profile fields.
    $map = _fundraiser_webform_get_user_map($node->nid);
    foreach ($map as $field_key => $profile_key) {
      $field =& _fundraiser_webform_find_field($form, $component_hierarchy[$field_key]);
      if (empty($field['#default_value'])) {
        if (property_exists($this_user, $profile_key)) {
          switch ($field['#type']) {
            case 'checkboxes':
              $field['#default_value'] = array($this_user->$profile_key);
              break;
            default:
              $field['#default_value'] = $this_user->$profile_key;
          }
        }
      }
    }
  }

  // Combine expiration month and year into a single component.
  $cc_exp_month_field =& _fundraiser_webform_find_field($form, $component_hierarchy['card_expiration_month']);
  $cc_exp_year_field =& _fundraiser_webform_find_field($form, $component_hierarchy['card_expiration_year']);
  $cc_info_field =& _fundraiser_webform_find_field($form, $component_hierarchy['credit_card_information']);
  $cc_exp_month_field['#default_value'] = date('n');
  $cc_exp_year_field['#default_value'] = date('Y');

  // Make sure the year field always has a good range of years.
  $this_year = date('Y');
  $years = array($this_year => $this_year);
  for ($i = 1; $i <= 5; $i++) {
    $years[$this_year + $i] = $this_year + $i;
  }
  $cc_exp_year_field['#options'] = $years;

  // Check to see if the credit card information fieldset still exists because it may have been removed.
  if (is_array($cc_info_field)) {
    $cc_info_field['expiration_date'] = array();
    $cc_info_field['expiration_date']['card_expiration_month'] = $cc_exp_month_field;
    $cc_info_field['expiration_date']['card_expiration_year'] = $cc_exp_year_field;
    $cc_info_field['expiration_date']['#weight'] = $cc_exp_month_field['#weight'];
    $cc_info_field['expiration_date']['#theme'] = 'fundraiser_credit_card_expiration_date';
  }
  else {
    // Add the new expiration_date directly to the form with the same weight as the cc_exp_month field.
    $form['expiration_date'] = array();
    $form['expiration_date']['card_expiration_month'] = $cc_exp_month_field;
    $form['expiration_date']['card_expiration_year'] = $cc_exp_year_field;
    $form['expiration_date']['#weight'] = $cc_exp_month_field['#weight'];
    $form['expiration_date']['#theme'] = 'fundraiser_credit_card_expiration_date';
  }
  // Remove old fields from form layout after moving them to their new location.
  $cc_exp_month_field = NULL;
  $cc_exp_year_field = NULL;

  // Alter country drop down to populate zone drop down.
  if (isset($component_hierarchy['country'])) {
    $country_field =& _fundraiser_webform_find_field($form, $component_hierarchy['country']);
    $country_field['#ajax'] = array(
      'callback' => '_fundraiser_webform_client_state_ajax_submit',
      'wrapper' => 'zone-select-wrapper',
      'method' => 'replace',
      'effect' => 'fade',
    );
    // Set default country value from user profile setting if it exists.
    if (isset($this_user->profile_country)) {
      foreach ($context->countries as $country_id => $country) {
        if ($country->country_iso_code_2 == $this_user->profile_country) {
          $country_field['#default_value'] = $country_id;
        }
      }
    }
  }

  // Add a wrapper around the state field so it can be replaced via ajax.
  if (isset($component_hierarchy['state'])) {
    $state_field =& _fundraiser_webform_find_field($form, $component_hierarchy['state']);
    // Set default zone value from user profile setting if it exists.
    if (isset($this_user->profile_state)) {
      foreach ($context->zones as $zone_id => $zone) {
        if ($zone->zone_code == $this_user->profile_state) {
          $state_field['#default_value'] = $zone_id;
        }
      }
    }
    // Add the wrapper for AJAX to react to.
    $state_field['#prefix'] = '<div id="zone-select-wrapper">';
    $state_field['#suffix'] = '</div>';
    // Flatten form state array so we can get the user selection easier.
    $fields = _fundraiser_array_flatten($form_state); // From fundraiser.module.
    // Country/state dependant drop down code
    $available_zones = $context->zones;
    if (array_key_exists('country', $fields)) {
      // Grab the selected country from $form_state, and set default.
      $country_field['#default_value'] = $fields['country'];
      // Filter options down to just the zones available for this country.
      if (isset($context->countries[ $country_field['#default_value'] ])) {
        $available_zones = $context->countries[ $country_field['#default_value'] ]->zones;
      }
    }
    // Given available zones, filter the dropdown to match.
    if (!empty($available_zones)) {
      $new_zone_options = array();
      foreach ($available_zones as $zone_id => $zone) {
        $new_zone_options[$zone_id] = $zone->zone_name;
      }
      $state_field['#options'] = $new_zone_options;
    }
  }

  // And lastly add a user facing message for submit.
  $form['submit']['#suffix'] = '<div class="fundraiser_submit_message">' .
    theme('image', array('path' =>  drupal_get_path('module', 'fundraiser_webform') . '/images/padlock.gif' )) .
    t('By clicking SUBMIT DONATION your credit card will be securely processed.') .
    '</div>';

  // Add a submit handler in advance of the webform_client_form_submit to cleanup after our move.
  // Important: It needs to run before webform runs, so it's getting put at the fornt of the array.
  array_unshift($form['#submit'], '_fundraiser_webform_pre_submit_cleanup');
  return $form;
}

/**
 * Submit callback, this moves the expiration month and year back into the structure where they
 * are expected, and removes 'expiration_date' from the list. If 'expiration_date' remained in the
 * submission, webform will try to look up a cid for it and reference it as if the component exists.
 * (Aka: there's no check to make sure a cid was recieved before acting on it.
 * So: We put everything back after we're done so that webform never knows the difference.
 */
function _fundraiser_webform_pre_submit_cleanup($form, &$form_state) {
  $form_state['values']['submitted']['credit_card_information']['card_expiration_month'] = 
      $form_state['values']['submitted']['credit_card_information']['expiration_date']['card_expiration_month'];
  $form_state['values']['submitted']['credit_card_information']['card_expiration_year'] = 
      $form_state['values']['submitted']['credit_card_information']['expiration_date']['card_expiration_year'];
  // Remove 'expiration_date' so webform doesn't get confused when it tries to process.
  unset($form_state['values']['submitted']['credit_card_information']['expiration_date']);
}

/**
 * AJAX callback for dealing with changes to the donation form.
 */
function _fundraiser_webform_client_state_ajax_submit($form, $form_state) {
  // Get the form item we want to render.
  $form_item = _fundraiser_webform_find_field($form, _fundraiser_webform_parse_component($form['#node']->nid, 'state'));
  return $form_item;
}

/**
 * Implements hook_fundraiser_donation_validate().
 */
function fundraiser_webform_fundraiser_donation_validate($form, $form_state) {
  $fundraiser_fields = _fundraiser_array_flatten($form_state['values']['submitted']); // From fundraiser.module.
  $node_id = $form_state['values']['details']['nid'];
  $errors = FALSE;
  $donation_amount = $fundraiser_fields['amount'];
  $email = $fundraiser_fields['email'];
  // Look for other amount.
  if ($donation_amount == "other") {
    $donation_amount = preg_replace("/[^\d\.]/i", "", $fundraiser_fields['other_amount']);
    // make sure other amount is numeric
    if (!is_numeric($donation_amount)) {
      form_set_error('other_amount', "You must enter a valid donation amount.");
      $errors = TRUE;
    }
  }
  // Check for minimum amount.
  $fundraiser = _fundraiser_get_fundraiser_by_nid($node_id);
  $minimum_donation_amount = isset($fundraiser->minimum_donation_amount) ? $fundraiser->minimum_donation_amount : 10;
  $minimum_donation_amount = number_format($minimum_donation_amount, 2);
  if ($donation_amount < $minimum_donation_amount) {
    form_set_error('submitted][donation][other_amount', 
      'Your donation amount must be greater than or equal to $minimum_donation_amount.');
    $errors = TRUE;
  }
  //TODO move cc number stuff to Ubercart. Fundraiser doesn't know this stuff, and neither should webform.
  $cc_number = $fundraiser_fields['card_number'];
  $cc_cvv = $fundraiser_fields['card_cvv'];
  $cc_expiration_month = $fundraiser_fields['card_expiration_month'];
  $cc_expiration_year = $fundraiser_fields['card_expiration_year'];

  // Validate the card number. By Ubercart. TODO yank this out.
  $valid_card = module_invoke_all('fundraiser_validate_card', $cc_number);
  if (!empty($cc_number) && ( !$valid_card[0]|| !ctype_digit($cc_number) )) {
    form_set_error('submitted][credit_card_information][card_number',
      'You have entered an invalid credit card number.');
    $errors = TRUE;
  }
  // Validate the card expiration date. By Ubercart.
  $valid_date = module_invoke_all('fundraiser_validate_card_expiration', $cc_expiration_month, $cc_expiration_year);
  if (!empty($cc_expiration_month) && !empty($cc_expiration_year) && !$valid_date[0]) {
    form_set_error('submitted][credit_card_information][expiration_date][card_expiration_month',
      t('The credit card you entered has expired.'));
    form_set_error('submitted][credit_card_information][expiration_date][card_expiration_year', ' ');
    $errors = TRUE;
  }
  // Validate the CVV Number.  By Ubercart.
  $valid_cvv = module_invoke_all('fundraiser_validate_card_cvv', $cc_cvv);
  if (!empty($cc_cvv) && !$valid_cvv[0]) {
    form_set_error('submitted][credit_card_information][card_cvv', t('You have entered an invalid CVV number.'));
    $errors = TRUE;
  }

  // Validate email address.
  if (!_fundraiser_validate_email($email)) {
    form_set_error('email', t('You must enter a valid email address.'));
    $errors = TRUE;
  }

  // Create watchdog entry on validation errors.
  if ($errors) {
    $base = drupal_get_path('module', 'fundraiser_webform');
    drupal_add_js($base . '/js/jquery.alphanumeric.js');
    drupal_add_js($base . '/js/fundraiser.js');
    drupal_add_css($base . '/css/fundraiser-donation-form.css');

    $message = "The following donation form fields failed local validation:\n\n";
    $check_errors = form_get_errors();
    $validation_errors = is_array($check_errors) ? array_keys($check_errors) : array();
    foreach ($validation_errors as $field) {
      $keys = explode('][', $field);
      $message .= array_pop($keys) . "\n";
    }

    $fundraiser_fields['card_number'] = substr_replace($fundraiser_fields['card_number'],
      str_repeat('*', strlen($fundraiser_fields['card_number'])), 0);
    $fundraiser_fields['card_cvv'] = substr_replace($fundraiser_fields['card_cvv'],
      str_repeat('*', strlen($fundraiser_fields['card_cvv'])), 0);

    $message .= "\n\nSubmitted Values:\n\n";
    foreach ($fundraiser_fields as $key => $value) {
      $message .= $key . ': ' . $value . "\n";
      watchdog('fundraiser_webform', $message, NULL, WATCHDOG_DEBUG, NULL);
    }
    // Provide data to fundraiser about the node that failed to validate.
    // TODO check if returning the nid is enough or if other context information will be needed.
    $errors = array();
    $errors['nid'] = $form_state['values']['details']['nid'];
    return $errors; // So fundraiser can pick up on the failure.
  }
}

/**
 * Implements hook_fundraiser_donation_submit().
 */
function fundraiser_webform_fundraiser_donation_submit($form, $form_state, $donation) {
  // Retrieve data from the submission.
  $sid = $form_state['values']['details']['sid'];
  $donation->sid = $sid;
  $fundraiser_fields = _fundraiser_array_flatten($form_state['values']['submitted_tree']); // From fundraiser.module.
/**
 * The values returned here are:
 *  amount, card_number, card_expiration_month, card_expiration_year, first_name, last_name, email, address,
 *  address_line_2, city, state, zip, quantity, other_amount.
 *
 * In the future should this change, a mapping function to map the keywords from one to the other would be good.
 */
  $donation->submission = $fundraiser_fields;

  // Set if this was a recurring donation.
  $recurs = FALSE;
  $results = _fundraiser_webform_get_cid_by_keys($nid, array('recurs_monthly'));
  foreach ($results as $result) {
    $recurs_cid = $result->cid;
  }
  if (!empty($recurs_cid)) {
    $value = $form_state['values']['submitted'][$recurs_cid];
    if (is_array($value)) {
      // If this is an array, then it is a single item checkbox
      if (isset($value[0])) {
        $recurs = $value[0] == 'recurs' ? TRUE : FALSE;
      }
    }
    else {
      $recurs = $value == 'recurs' ? TRUE : FALSE;
    }
  }
  $donation->donation->recurs = $recurs ? DONATION_RECURRING : DONATION_NON_RECURRING;
  // TODO is there any other information about the submission I can grab at this point for use down the line?
}

/**
 * Implements hook_fundraiser_donation_post_submit().
 */
function fundraiser_webform_fundraiser_donation_post_submit($form, $form_state, $donation, $result) {
  // Relate the donation id to webform before we try to process the payment. //TODO change terminology
  $webform_order = array(
    'webform_nid' => $donation->nid,
    'order_id' => $donation->donation->did,
    'sid' => $donation->sid,
    'recurring_status' => $donation->donation->recurs,
  );
  drupal_write_record('fundraiser_webform_order', $webform_order);
  // Handle behavior if it was a failure.
  if (!$donation->result['success']) {
    // Tell webform we're not done and rebuild the form.
    unset($form_state['values']['details']['sid']);
    form_set_error('credit_card_information][card_number', $donation->result['message']);
    $form_state['values']['details']['finished'] = 0;
    $form_state['rebuild'] = TRUE;
  }
}

/**
 * Implements hook_fundraiser_donation_success().
 */
function fundraiser_webform_fundraiser_donation_success($donation) {
  // Record that the donation was successful for the webform submission.
  // Update the order/webform relationship // TODO update this to write record -SeH
  // TODO for some reason the transaction id isn't coming back on test gateway.
  // So this is set by default at the moment to '-'.
  $txn_id = '-';
  if (isset($donation->result['data']['txn_id'])) {
    $txn_id = $donation->result['data']['txn_id'];
  }
  db_query('UPDATE {fundraiser_webform_order} ' .
    'SET gateway = :gateway, txn_id = :txn_id ' .
    'WHERE order_id = :order_id',
    array(
      ':gateway' => $donation->node->gateway,
      ':txn_id' => $txn_id,
      ':order_id' => $donation->donation->did,  //TODO rename terminology here.
    )
  );

  // Update the uid on the webform submission
  db_query('UPDATE {webform_submissions} SET ' .
    'uid = :uid '.
    'WHERE sid = :sid',
    array(':uid' => $donation->donation->uid, ':sid' => $donation->sid));

  // Update the recurring status, if it was changed by the payment gateway module
  if ($donation->donation->recurs != $donation->donation->data['recurring_status']) {
    db_query('UPDATE {fundraiser_webform_order} SET recurring_status = :recurring_status WHERE order_id = :order_id',
    array(':recurring_status' => $donation->donation->data['recurring_status'], ':order_id' => $donation->donation->did));
  }
}
//TODO because the decline checked donation for the sid, make sure it's set on retrieval
// USE:
//   $sid = db_query('SELECT sid FROM {fundraiser_webform_order} WHERE order_id = :order_id',
//   array(':order_id' => $order_id))->fetchColumn();
//

/**
 * Implements hook_fundraiser_donation_decline().
 */
function fundraiser_webform_fundraiser_donation_decline($donation) {
  // Clean up.
  // TODO move this out into a DB function for this stuff.
  db_delete('fundraiser_webform_order')->condition('order_id', $donation->donation->did)->execute();
  db_delete('webform_submitted_data')->condition('sid', $donation->sid)->execute();
  db_delete('webform_submissions')->condition('sid', $donation->sid)->execute();
}

/**
 * Implements hook_fundraiser_donation_get_donation().
 */
function fundraiser_webform_fundraiser_donation_get_donation($donation) {
  $submission = _fundraiser_webform_get_webform_order_by_did($donation->donation->did);
  $donation->sid = $submission->sid;
  $donation->donation->recurs = $submission->recurring_status;
}

/**
 * Implements hook_fundraiser_replace_tokens().
 */
function fundraiser_webform_fundraiser_replace_tokens($message, $donation) {
  module_load_include('inc', 'webform', 'includes/webform.submissions');
  // TODO This line should be in fundraiser_webform_fundraiser_donation_get_donation
  // but is not b/c there is no gurantee at that point in the load sequence that
  // $donation->nid will be set, because it is currently set in another glue module.
  // When tracking information pulls out of that glue module, then we can properly
  // set and pull submission information out of the donation object itself.
  // See: fundraiser_ubercart.module for additional notes re: setting nid.
  $donation->submission = webform_get_submission($donation->nid, $donation->sid);
  // Replace the message with webform psuedo-tokens.
  $message = _webform_filter_values($message, $donation->node, $donation->submission, NULL, FALSE);
  return $message;
}

/**
 * Implements hook_fundraiser_get_fundraiser_alter().
 */
function fundraiser_webform_fundraiser_get_fundraiser_alter($fundraiser) {
  // Get the webform map of values.
  $components = _fundraiser_webform_get_component_map_by_nid($fundraiser->nid);
  $map = array();
  foreach($components as $component) {
    $map[$component->cid] = $component->map_id;
  }
  $fundraiser->map = $map;
  // Get the webform data for this node. This overrides the saved amount values in fundraiser itself.
  // Add the amount_values for the fundraiser information on load.
  if (is_numeric($fundraiser->nid)) {
    $amounts = _fundraiser_webform_get_extra_by_key($fundraiser->nid, 'amount');
    if (isset($amounts['items'])) {
      $amounts = preg_split('/\n/', trim($amounts['items']));
      $amounts = array_unique($amounts);
      $donation_amounts = array();
      for ($i = 0; $i < count($amounts); ++$i) {
        $donation_amounts[] = explode('|', $amounts[$i]);
      }
      $fundraiser->donation_amounts = $donation_amounts;
    }
  }
}

/**
 * Implements hook_fundraiser_create_fundraiser_alter().
 */
function fundraiser_webform_fundraiser_create_fundraiser_alter($fundraiser) {
  module_load_include('inc', 'fundraiser_webform', 'fundraiser_webform.crud');
  $donation_amounts = array();
  if (isset($fundraiser->donation_amounts)) {
    $amount_sets = explode(',', $fundraiser->donation_amounts);
    $amount_sets = array_unique($amount_sets);
    foreach ($amount_sets as $amount_set) {
      $amount_set = explode('|', $amount_set);
      if (count($amount_set) == 2) {
        $donation_amounts[$amount_set[0]] = $amount_set[1];
      }
    }
    ksort($donation_amounts, SORT_NUMERIC);
  }
  $components = _fundraiser_webform_create_webform_components($fundraiser->nid, $donation_amounts, 
    $fundraiser->show_other_amount, $fundraiser->minimum_donation_amount);

  // Create the user profile map. TODO when this is de-coupled, this will be it's own hook.
  _fundraiser_webform_create_user_map($fundraiser->nid, $components); // From fundraiser_webform.user.inc
}

/**
 * Implements hook_fundraiser_update_fundraiser_alter().
 */
function fundraiser_webform_fundraiser_update_fundraiser_alter($fundraiser) {
  module_load_include('inc', 'fundraiser_webform', 'fundraiser_webform.crud');
  $donation_amounts = array();
  if (isset($fundraiser->donation_amounts)) {
    $amount_sets = explode(',', $fundraiser->donation_amounts);
    $amount_sets = array_unique($amount_sets);
    foreach ($amount_sets as $amount_set) {
      $amount_set = explode('|', $amount_set);
      if (count($amount_set) == 2) {
        $donation_amounts[$amount_set[0]] = $amount_set[1];
      }
    }
    ksort($donation_amounts, SORT_NUMERIC);
    $keys = array_keys($donation_amounts);
  }
  _fundraiser_webform_update_amount_component($fundraiser, $donation_amounts, $keys[0]); // In fundraiser_webform.crud.inc.
  // Update the label on the minimum donation amount.
  if ($fundraiser->show_other_amount == 1) {
    $other_amount = _fundraiser_webform_get_extra_by_key($fundraiser->nid, 'other_amount');
    $other_amount['description'] = 'Minimum payment $' . $fundraiser->minimum_donation_amount . '.';
    _fundraiser_webform_set_extra_by_key($fundraiser->nid, 'other_amount', $other_amount);
  }
}

/**
 * Implements hook_get_donation_gateway().
 */
function fundraiser_webform_get_donation_gateway($did, $gateway) {
// TODO move this out to it's own DB call.
  // Get details on the original payment so we can load the payment gateway details
  $webform_gateway = db_query('SELECT gateway FROM {fundraiser_webform_order} '.
    'WHERE order_id = :order_id ',
    array(':order_id' => $did))->fetchObject();
  if (!$webform_gateway)) {
    $gateway = $webform_gateway;
  }
}

/**
 * Helper functions below.
 */

/**
 * Helper function.
 * Creates a nested array of where a component exists in the FAPI array.
 */
function _fundraiser_webform_parse_component($nid, $form_key) {
  $results = _fundraiser_webform_get_cid_by_keys($nid, array($form_key));
  foreach ($results as $result) {
    $cid = $result->cid;
  }
  $component_path = 'submitted[' . implode('][', _fundraiser_webform_walk_component_hierarchy($nid, $cid)) . ']';
  parse_str($component_path, $output); // Convert. string to a nested array
  return $output;
}

/**
 * Helper function.
 * Creates a nested array of where components exist in the FAPI array for all components in a webform.
 * This is needed because the webform module allows the user to move components around. Therefore
 * we must be able to find them if they are not in their usual spot.
 */
function _fundraiser_webform_parse_components($nid, $components) {
  $component_hierarchy = array();
  foreach ($components as $cid => $component) {
    $component_path = 'submitted[' . implode('][', _fundraiser_webform_walk_component_hierarchy($nid, $cid)) . ']';
    parse_str($component_path, $output); // Convert string to a nested array.
    $component_hierarchy[$component['form_key']] = $output;
  }
  return $component_hierarchy;
}

/**
 * Helper function.
 * Builds a path from the webform component to it's topmost parent.
 * Recursion is here. Be careful.
 */
function _fundraiser_webform_walk_component_hierarchy($nid, $cid, &$path = array()) { 
  // Store all the components for this node in a static cache to reduce the number of duplicated database hits.
  static $component_hierarchy = array();
  if (empty($component_hierarchy[$nid])) {
    $component_hierarchy[$nid] = array();
    // TODO remove this table thing here.
    $results = _fundraiser_webform_get_component_data($nid);
    foreach ($results as $data) {
      $cid = $data->cid;
      $component_hierarchy[$nid][$cid][] = $data;
    }
  }
  // Build a path from the webform component to its topmost parent.
  foreach ($component_hierarchy[$nid][$cid] as $data) {
    array_unshift($path, $data->form_key);
    if ($data->pid > 0) {
      _fundraiser_webform_walk_component_hierarchy($nid, $data->pid, $path);
    }
  }
  return $path;
}

/**
 * Helper function, returns a reference to an element of a FAPI array based on a known path.
 * This returns a reference to the form variable, allowing for manipulation into the form array.
 */
function &_fundraiser_webform_find_field(&$form, $path) {
  foreach (array_keys($path) as $v) {
    if (is_array($path[$v]) && count($path[$v])) {
      // Recurse if there are more keys.
      return _fundraiser_webform_find_field($form[$v], $path[$v]);
    }
    else {
      return $form[$v];
    }
  }
}

/**
 * Helper function, these are the fields we can't delete.
 */
// This is only used in webform_token_selector/webform_token_selector.module
// Should it be moved to that module?
function _fundraiser_field_blacklist() {
  return array(
    'card_number',
    'card_cvv',
    'recurs_monthly',
    'card_expiration_month',
    'card_expiration_year',
  );
}

/**
 * Helper function, return a list of fields that are required for webform fundraiser.
 */
function _fundraiser_webform_required_fields() {
  return array(
    'ms',
    'cid',
    'referrer',
    'initial_referrer',
    'amount',
    'first_name',
    'last_name',
    'email',
    'address',
    'address_line_2',
    'city',
    'country',
    'state',
    'zip',
    'card_number',
    'card_expiration_year',
    'card_expiration_month',
    'card_cvv',
  );
}

/**
 * DB functions.
 */

/**
 * CRUD style DB function for fundraiser_webform_order.
 */
function _fundraiser_webform_create_webform_order($webform_order) {
  // Cast donation just in case.
  $webform_order = (array) $webform_order;
  // Check for old data.
  $webform_order_data = FALSE;
  if (isset($webform_order['webform_nid']) && isset($webform_order['order_id'])) {
    $webform_order_data = _fundraiser_webform_get_webform_order_by_nid_did($webform_order['webform_nid'], $webform_order['order_id']);
  }
  if (!$webform_order_data) {
    $record = $webform_order;
    drupal_write_record('fundraiser_webform_order', $record);
  }
  else {
    _fundraiser_webform_update_webform_order($webform_order);
  }
}

/**
 * CRUD style DB function for fundraiser_webform_order.
 */
function _fundraiser_webform_get_webform_order_by_nid_did($nid, $did) {
  return db_query('SELECT * FROM {fundraiser_webform_order} ' .
    'WHERE webform_nid = :nid ' .
    'AND order_id = :did', // TODO change this terminology.
    array(':nid' => $nid, ':did' => $did))->fetchObject();
}

/**
 * CRUD style DB function for fundraiser_webform_order.
 */
function _fundraiser_webform_update_webform_order($webform_order) {
  // Cast donation just in case.
  $webform_order = (array) $webform_order;
  // Check for old data.
  $webform_order_data = FALSE;
  if (isset($webform_order['webform_nid']) && isset($webform_order['order_id'])) {
    $webform_order_data = _fundraiser_webform_get_webform_order_by_nid_did($webform_order['webform_nid'], $webform_order['order_id']);
  }
  if (!$webform_order_data) {
    _fundraiser_webform_create_webform_order($webform_order);
  }
  else {
    $record = array_merge((array) $webform_order_data, $webform_order); // Merge data together so we get everything in the record.
    drupal_write_record('fundraiser_webform_order', $webform_order, array('webform_nid', 'order_id'));
  }
}

/**
 * CRUD style DB function for fundraiser_webform_order.
 */
function _fundraiser_webform_delete_webform_order($nid, $did) {
  db_delete('fundraiser_webform_order')->condition('webform_nid', $nid)->condition('order_id', $did)->execute();
}

/**
 * DB function, get submission from a donation form.
 */
function _fundraiser_webform_get_webform_order_by_did($did) {
  return db_query('SELECT * FROM {fundraiser_webform_order} ' .
    'WHERE order_id = :did', // TODO change this terminology.
    array(':did' => $did))->fetchObject();
    // For now, there can be only one. TODO change this later.
}

/**
 * CRUD style DB function for fundraiser_component_map.
 */
function _fundraiser_webform_create_component_map($component_map) {
  // Cast donation just in case.
  $component_map = (array) $component_map;
  // Check for old data.
  $component_map_data = FALSE;
  if (isset($component_map['nid']) && isset($component_map['cid'])) {
    $component_map_data = _fundraiser_webform_get_component_map_by_nid_cid($component_map['nid'], $component_map['cid']);
  }
  if (!$component_map_data) {
    $record = $component_map;
    drupal_write_record('fundraiser_component_map', $record);
  }
  else {
    _fundraiser_webform_update_component_map($component_map);
  }
}

/**
 * CRUD style DB function for fundraiser_component_map.
 */
function _fundraiser_webform_get_component_map_by_nid_cid($nid, $did) {
  return db_query('SELECT * FROM {fundraiser_component_map} ' .
    'WHERE nid = :nid ' .
    'AND cid = :cid',
    array(':nid' => $nid, ':cid' => $cid))->fetchObject();
}

/**
 * CRUD style DB function for fundraiser_component_map.
 */
function _fundraiser_webform_update_component_map($component_map) {
  // Cast donation just in case.
  $component_map = (array) $component_map;
  // Check for old data.
  $component_map_data = FALSE;
  if (isset($component_map['nid']) && isset($component_map['cid'])) {
    $component_map_data = _fundraiser_webform_get_component_map_by_nid_cid($component_map['nid'], $component_map['cid']);
  }
  if (!$component_map_data) {
    _fundraiser_webform_create_component_map($component_map);
  }
  else {
    $record = array_merge((array) $component_map_data, $component_map); // Merge data together so we get everything in the record.
    drupal_write_record('fundraiser_component_map', $component_map, array('nid', 'cid'));
  }
}

/**
 * CRUD style DB function for fundraiser_component_map.
 */
function _fundraiser_webform_delete_component_map($nid, $cid) {
  db_delete('fundraiser_component_map')->condition('nid', $nid)->condition('cid', $cid)->execute();
}

/**
 * DB function, get submission from a donation form.
 */
function _fundraiser_webform_get_component_map_by_nid($nid) {
  return db_query('SELECT * FROM {fundraiser_component_map} ' .
    'WHERE nid = :nid ',
    array(':nid' => $nid))->fetchAll();
}

/**
 * DB function, get webform component form elements.
 */
function _fundraiser_webform_get_component_data($nid) {
  return db_query('SELECT * FROM {webform_component} WHERE nid = :nid',
    array(':nid'=>$nid));
}

/**
 * DB function, given a nid and field key, get and *unserialize* the extra field from webform component.
 */
function _fundraiser_webform_get_extra_by_key($nid, $form_keys) {
  if (!is_array($form_keys)) {
    $form_keys = array($form_keys);
  }
  $results =  db_query('SELECT extra FROM {webform_component} WHERE nid = :nid AND form_key IN(:form_keys)',
    array(':nid'=>$nid, ':form_keys' => $form_keys));
  foreach ($results as $result) {
    return unserialize($result->extra);
  }
  return FALSE;
}

/**
 * DB function, get webform component form elements.
 */
function _fundraiser_webform_get_cid_by_keys($nid, $form_keys) {
  if (!is_array($form_keys)) {
    $form_keys = array($form_keys);
  }
  return db_query('SELECT * FROM {webform_component} WHERE nid = :nid AND form_key IN(:form_keys)',
    array(':nid'=>$nid, ':form_keys' => $form_keys));
}

/**
 * DB function, get webform component form elements.
 */
function _fundraiser_webform_get_amount_count($nid) {
  $results = db_query('SELECT COUNT(nid) as count FROM {webform_component} WHERE nid = :nid AND form_key LIKE \'amount\' AND type = \'select\'',
    array(':nid'=>$nid, ':form_keys' => $form_keys));
  foreach ($results as $result) {
    return $result->count;
  }
}

/**
 * DB function, given a nid and field key, *serialize* and set the extra field from webform component.
 */
function _fundraiser_webform_set_extra_by_key($node, $form_key, $new_value) {
  if (!isset($node->nid)) {
    $node = node_load($node);
  }
  $record['nid'] = $node->nid;
  $record['form_key'] = $form_key;
  $record['extra'] = serialize($new_value);
  drupal_write_record('webform_component', $record, array('nid', 'form_key'));
}

