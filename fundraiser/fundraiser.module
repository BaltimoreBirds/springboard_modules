<?php
// $Id: fundraiser.module$ a.k.a kashgiser

define('FUNDRAISER_SINGLE_DONATION_TYPE',  'donation');
define('FUNDRAISER_RECURRING_DONATION_TYPE',  'recurring_donation');
define('RECURRING_DONATION_STATUS', 'pending_future_payment');

define('DONATION_NON_RECURRING', 0);
define('DONATION_RECURRING', 1);
define('DONATION_CANCELLED', 2);

/**
 * Implementaion of hook_nodeapi().
 */
function fundraiser_nodeapi(&$node, $op, $teaser, $page) {
	
	if ($node->type == 'webform') {
		switch ($op) {
			case 'insert':
		  	fundraiser_node_insert($node);
				break;
		     
			case 'load':
				$array = fundraiser_node_load($node->nid);
				$node->is_donation_form = $array['is_donation_form'];
				$node->donation_amounts = $array['donation_amounts'];
				$node->show_other_amount = $array['show_other_amount'];
				$node->minimum_donation_amount = $array['minimum_donation_amount'];
				$node->gateway = $array['gateway'];
				$node->confirmation_email_from_name = $array['confirmation_email_from_name'];
				$node->confirmation_email_from_email = $array['confirmation_email_from_email'];
				$node->confirmation_email_message = $array['confirmation_email_message'];
				$node->confirmation_email_subject = $array['confirmation_email_subject'];
				$node->internal_name = $array['internal_name'];
				
				// if we're on the mapping tab, load up the map too
				if (arg(0) == 'node' && arg(2) == 'webform' && arg(3) == 'mapping') {
					$result = db_query("SELECT cid, map_id FROM {fundraiser_component_map} WHERE nid = %d", $node->nid);
					while($row = db_fetch_array($result)){
						$map[$row['cid']] = $row['map_id'];
					}
					$node->map = $map;
				}
				break;
			
			case 'update':
				fundraiser_node_update($node);
				break;
			
			case 'delete':
				fundraiser_node_delete($node->nid);
				break;	
				
		  case 'view':
		    if ($page && $node->is_donation_form) {
		      if (!fundraiser_is_secure() && !variable_get('fundraiser_development_mode', 0)) {
		        // return a 404
		        watchdog('fundraiser', 'The donation form <em>!title</em> is not protected with SSL.', array('!title' => $node->title), WATCHDOG_CRITICAL, l('View the donation form', 'node/' . $node->nid));
		        drupal_not_found();
		        exit();
		      }
		      // set a reminder to turn off development mode
		      if (variable_get('fundraiser_development_mode', 0)) {
		        drupal_set_message(t('Fundraiser is currently running in development mode. Remember to !link this feature on production websites.', array('!link' => l('turn off', 'admin/settings/fundraiser'))));
		      }
		    }
		    break;
		}

	}
	
	if ($node->type =='page') {
		switch ($op) {
			case 'view':				
				if (isset($_GET['sid']) && is_numeric($_GET['sid'])) {
					
					global $user;
					$sql = "select max(order_id) as order_id
							from {uc_orders}
							where uid=$user->uid";
					$result = db_query($sql);
					$row = db_fetch_array($result);
					$order_id = $row['order_id'];
					
					$order = uc_order_load($order_id);
					$node->content['body']['#value'] = token_replace($node->content['body']['#value'], $type = 'order', $order,
	                $leading = '[', $trailing = ']');
				}
				break;
		}
	}
}

/**
 * Check if the current page is SSL
 */
function fundraiser_is_secure() {
  return (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on') ? TRUE : FALSE;
}

/** 
 * Alter the webform component delete form to prevent the deletion of required fundraiser fields
 */
function fundraiser_form_webform_component_delete_form_alter(&$form, &$form_state) {
  module_load_include('inc', 'fundraiser', 'fundraiser.fields');
  $required_fields = fundraiser_required_fields();
  
  $cid = arg(4);
  $component = $form['node']['#value']->webform['components'][$cid];
  // check to see if the form_key is in our required fields array
  if (in_array($component['form_key'], $required_fields)) {
    $message = t('<strong>!name</strong> is a required fundraiser field and cannot be deleted from this form.', array('!name' => $component['name']));
    $form['description']['#value'] = $message;
    unset($form['actions']['submit']);
  }
}

/**
 * Implementation of hook_form_alter().
 */
function fundraiser_form_alter(&$form, $form_state, $form_id) {

	switch ($form_id) {
			
		case 'webform_node_form':
			
			$form['fundraiser'] = array(
				'#type' => 'fieldset',
				'#title' => t('Fundraising'),
				'#collapsible' => TRUE,
				'#collapsed' => TRUE,
			);

			$options = _payment_gateway_list('',TRUE);
			$options2 = array();
			foreach($options as $key=>$value){
				$options2[$value['id']] = $value['title'];
			}
			
			$is_donation_form = $form['#node']->is_donation_form;
			
			if (!$form['#node']->nid && !$is_donation_form) {
				$can_make_donation_form = true;
			}
			else {
				$can_make_donation_form = false;
			}
			
			// add exception for cloning
			if (arg(2) == 'clone') {
				$can_make_donation_form = true;
			}
			
			if ($can_make_donation_form) {
				$form['fundraiser']['is_donation_form'] = array (
					'#type' => 'checkbox',
					'#title' => t('Render this webform as a donation form'),
					'#description' => t('Selecting this option will output billing and credit card information fields on your webform.'),
					'#default_value' => $form['#node']->is_donation_form,
				);
			}
			else {
				$form['fundraiser']['donation_form_message'] = array(
					'#value' => t('<h3>This webform has been converted to a donation form.</h3><div class="description">You can change the options below, but you cannot make this a non-donation form again.</div>'),
				);
			}
			
			$form['fundraiser']['internal_name'] = array(
				'#type' => 'textfield',
				'#title' => t('Internal Name'),
				'#description' => t('An internal name to help distinguish this donation form from others. This value is never shown to the public.'),
				'#default_value' => $form['#node']->internal_name,
				'#required' => FALSE,
			);
		
			if ($can_make_donation_form) {
				$form['fundraiser']['donation_amounts'] = array (
					'#type' => 'textfield',
					'#title' => t('Donation Amounts'),
					'#description' => t('If you want the user to choose from a predetermined list donation amounts, enter them here. Seperate each amount by a comma. If no amounts are entered, a textbox will be displayed for the user to enter a custom amount.'),
					'#default_value' => $form['#node']->donation_amounts,
				);
			}
			else {
				$form['fundraiser']['donation_amounts'] = array(
					'#type' => 'item',
					'#title' => t('Donation Amounts'),
					'#description' => t('Donation amounts can be changed by editing the webform component directly.'),
				);
			}
			
			$form['fundraiser']['show_other_amount'] = array (
				'#type' => 'checkboxes',
				//'#title' => t('Show other amount option'),
				'#options' => array("1"=>"Show other amount option"),
				'#description' => t('Use this option if you want to provide an "Other Amount" field in conjuntion with the list of Donation Amounts.'),
				'#default_value' => array($form['#node']->show_other_amount),
			);
			
			$form['fundraiser']['minimum_donation_amount'] = array(
				'#type' => 'textfield',
				'#title' => t('Minimum donation amount'),
				'#description' => t('The minimum acceptable donation amount.'),
				'#default_value' => number_format($form['#node']->minimum_donation_amount, 2),
			);
			
			$form['fundraiser']['gateway'] = array(
				'#type' => 'select',
		  		'#title' => t('Select Payment Gateway'),
		  		'#options' => $options2,
		  		'#default_value' => $form['#node']->gateway,
			);
			
			$form['fundraiser']['confirmation_email_from_name'] = array(
				'#type' => 'textfield',
				'#title'=> t('Confirmation Email From Name'),
				'#description' => t("Example: Fundraising Team"),
				'#default_value' => $form['#node']->confirmation_email_from_name,
			);
			$form['fundraiser']['confirmation_email_from_email'] = array(
				'#type' => 'textfield',
				'#title'=> t('Confirmation Email From'),
				'#description' => t("Example: info@store.com."),
				'#default_value' => $form['#node']->confirmation_email_from_email,
			);
			$form['fundraiser']['confirmation_email_subject'] = array(
				'#type' => 'textfield',
				'#title'=> t('Confirmation Email Subject Line'),
				'#description' => t("Example: Thank you for your donation"),
				'#default_value' => $form['#node']->confirmation_email_subject,
			);
			$form['fundraiser']['confirmation_email_message'] = array(
				'#type' => 'textarea',
				'#title'=> t('Confirmation Email Message'),
				'#default_value' => $form['#node']->confirmation_email_message,
			);
			
			if (module_exists('token')) {
		    $form['fundraiser']['view']['token_help'] = array(
		      '#title' => t('Replacement patterns'),
		      '#type' => 'fieldset',
		      '#collapsible' => TRUE,
		      '#collapsed' => TRUE,
     		  '#description' => t('You can use any of the tokens below in the Confirmation Email Content'),
		      );
		
		    $form['fundraiser']['view']['token_help']['help'] = array(
		      '#value' => theme('token_help', 'order'),
		      );
		  }
			
		break;
		
	}
	
	if (strstr($form_id, 'webform_client_form')) {

		global $user;
    profile_load_profile($user); /* explicitly load profile as of Drupal 6.19 */

		// get fundraiser info 
		$fundraiser = fundraiser_node_load($form['#parameters'][2]->nid);

		// don't do anything if this isn't a donation webform
		if ($fundraiser['is_donation_form'] && arg(2) != 'submission')
		{
			$base = drupal_get_path('module', 'fundraiser');
			drupal_add_js($base .'/jquery.alphanumeric.js');
			drupal_add_js($base .'/fundraiser.js');
	
			$nid = $form['#parameters'][2]->nid;
			$components = $form['#parameters'][2]->webform['components'];
      // create an data structure that will tell us exactly where each webform component lives in the FAPI array
      $component_hierarchy = fundraiser_parse_components($nid, $components);     			
			
			// preload any fields if the user is logged in
      if (user_is_logged_in()) {
				// load up map
				$map = fundraiser_user_map($nid);
				// load up any mapped profile fields
				foreach($map as $field_key => $profile_key) {
				  $field =& fundraiser_find_field($form, $component_hierarchy[$field_key]);
				  if (empty($field['#default_value'])) {
				    if (property_exists($user, $profile_key)) {
				      $field['#default_value'] = $user->$profile_key;
				    }
				  }
				}
			}
			
			// combine expiration month and year into a single component
			$cc_exp_month_field =& fundraiser_find_field($form, $component_hierarchy['card_expiration_month']);
			$cc_exp_year_field =& fundraiser_find_field($form, $component_hierarchy['card_expiration_year']);
			$cc_info_field =& fundraiser_find_field($form, $component_hierarchy['credit_card_information']);

      $cc_exp_month_field['#default_value'] = date('n');
      $cc_exp_year_field['#default_value'] = date('Y');
      
      // make sure the year field always has a good range of years
    	$this_year = date('Y');
    	$years = array($this_year => $this_year);
    	for ($i = 1; $i <= 5; $i++) {
        $years[$this_year + $i] = $this_year + $i;
      }
      $cc_exp_year_field['#options'] = $years;
      
      // check to see if the credit card information fieldset still exists because it may have been removed
      if (is_array($cc_info_field)) {
        $cc_info_field['expiration_date'] = array();
        $cc_info_field['expiration_date']['card_expiration_month'] = $cc_exp_month_field;
        $cc_info_field['expiration_date']['card_expiration_year'] = $cc_exp_year_field;
        $cc_info_field['expiration_date']['#theme'] = 'fundraiser_credit_card_expiration_date';
      }
      else {
        // add the new expiration_date directly to the form with the same weight as the cc_exp_month field
        $form['expiration_date'] = array();
        $form['expiration_date']['card_expiration_month'] = $cc_exp_month_field;
        $form['expiration_date']['card_expiration_year'] = $cc_exp_year_field;
        $form['expiration_date']['#weight'] = $cc_exp_month_field['#weight'];
        $form['expiration_date']['#theme'] = 'fundraiser_credit_card_expiration_date';
      }
			// remove old fields after moving them
			$cc_exp_month_field = NULL;
			$cc_exp_year_field = NULL;
			
			// alter country drop down to populate zone drop down via ahah
			$country_field =& fundraiser_find_field($form, $component_hierarchy['billing_country']);
			$country_field['#ahah'] = array('path' => 'zones/js', 'wrapper' => 'zone-select-wrapper');

      // add a wrapper around the state field so it can be replaced via ajax			
			$state_field =& fundraiser_find_field($form, $component_hierarchy['billing_state']);
			$state_field['#prefix'] = '<div id="zone-select-wrapper">'; 
			$state_field['#suffix'] = '</div>'; 
      
      // flatten form state array so that it is easier to work with			
			$fields = array_flatten($form_state);
			// country/state dependant drop down code
			if (array_key_exists('billing_country', $fields)) {
				$country_field['#default_value'] = $fields['billing_country']; // user selected country
				// populate via Ahah!
				$state_field['#options'] = get_country_zones($fields['billing_country']);
			}
			else {
        $state_field['#options'] = get_country_zones($country_field['#default_value']); // default country as defined in the component definition
			}

			// add an additional submit and validation handler
			array_unshift($form['#submit'], 'fundraiser_webform_submit'); // creates order
			$form['#validate'][] = 'fundraiser_webform_validate';
      $form['submit']['#suffix'] = '<div class="fundraiser_submit_message">' . theme('image', drupal_get_path('module', 'fundraiser') . '/padlock.gif') . t('By clicking SUBMIT DONATION your credit card will be securely processed.') . '</div>';
		}
	}

	return $form;
}

/**
 * Theme the credit card expiration date form field.
 */
function theme_fundraiser_credit_card_expiration_date($element) {
  $element['card_expiration_month']['#title'] = t('Expiration Date');
  $month = drupal_render($element['card_expiration_month']);
  $element['card_expiration_year']['#title'] = '';
  $year = drupal_render($element['card_expiration_year']);
  
  preg_match('#<select.*/select>#ms', $year, $matches);
  $month = str_replace('</select>', "</select>$matches[0]", $month);
  
  $expiration_date = "<div class='expiration-date-wrapper clear-block'>$month</div>";
  return $expiration_date . drupal_render($element); // Always end any form theming with drupal_render() for cleanup.
}

/**
 * Creates an array to map webform component fields to user profile fields.
 */
function fundraiser_user_map($nid) {
  $map = array();
  $result = db_query(
    "
      SELECT w.form_key, f.cid, f.map_id, w.type
      FROM {webform_component} w
      INNER JOIN {fundraiser_component_map} f ON f.cid = w.cid AND f.nid = w.nid
      WHERE f.nid = %d 
      ORDER BY f.cid
    ",
    $nid
  );
  
  while ($row = db_fetch_array($result)) {
    $map[$row['form_key']] = $row['map_id'];
  }
  
  return $map;
}

/**
 * Returns a reference to an element of a FAPI array based on a known path.
 */
function &fundraiser_find_field(&$form, $path) {
  foreach(array_keys($path) as $v) {
    if (is_array($path[$v]) && count($path[$v])) { // if there are more keys
      return fundraiser_find_field($form[$v], $path[$v]);
    }
    else {
      return $form[$v];
    }
  }
}

/**
 * Creates a nested array of where components exist in the FAPI array for all components in a weblform. 
 * This is needed because the fundraiser module allows the user to move components around. Therefore
 * we must be able to find them if they are not in their usual spot.
 */
function fundraiser_parse_components($nid, $components) {
  $component_hierarchy = array();
  foreach($components as $cid => $component) {
    $component_path = 'submitted[' . implode('][', fundraiser_walk_component_hierarchy($nid, $cid)) . ']';
    parse_str($component_path, $output); // convert string to a nested array
    $component_hierarchy[$component['form_key']] = $output;
  }
  return $component_hierarchy;
}

/**
 * Creates a nested array of where a component exists in the FAPI array.
 */
function fundraiser_parse_component($nid, $form_key) {
  $cid = db_result(db_query("SELECT cid FROM {webform_component} WHERE nid = %d and form_key = '%s'", $nid, $form_key));
  $component_path = 'submitted[' . implode('][', fundraiser_walk_component_hierarchy($nid, $cid)) . ']';
  parse_str($component_path, $output); // convert string to a nested array
  return $output;
}

/**
 * Builds a path from the webform component to it's topmost parent.
 */
function fundraiser_walk_component_hierarchy($nid, $cid, &$path = array()) {
  $result = db_query("SELECT cid, pid, form_key FROM {webform_component} WHERE nid = %d and cid = %d", $nid, $cid);
  while ($data = db_fetch_object($result)) {
    array_unshift($path, $data->form_key);
    if ($data->pid > 0) {
      fundraiser_walk_component_hierarchy($nid, $data->pid, $path);
    }
  }
  return $path;
}

/**
 * Ahah callback for populating the state drop down list based on the selected country.
 */
function zones_ahah_render() {
	$form_state    = array('storage' => NULL, 'submitted' => FALSE);
	$form_build_id = $_POST['form_build_id'];

	$form    = form_get_cache($form_build_id, $form_state);
	$args    = $form['#parameters'];
	$form_id = array_shift($args);

	$form['#post']       = $_POST;
	$form['#redirect']   = FALSE;
	$form['#programmed'] = FALSE;
	$form_state['post']  = $_POST;

	// Prevents _form_builder_ie_cleanup() from incorrectly assigning the
	// first button in the form as the clicked button.
	// Wim Leers' AHAH Helper Module has more in-depth information.
	// @see the ahah_helper project
	$form_state['submitted'] = TRUE;
	if (!isset($_POST['op'])) {
    // For the default "{$form_id}_validate" and "{$form_id}_submit" handlers.
    $form['#validate'] = NULL;
    $form['#submit'] = NULL;
    // For customly set #validate and #submit handlers.    $form_state['submit_handlers'] = NULL;
    $form_state['validate_handlers'] = NULL;
    // Disable #required and #element_validate validation.

    _ahah_helper_disable_validation($form);
  }

	drupal_process_form($form_id, $form, $form_state);

	// Once drupal_rebuild_form is called, we no longer have access to
	// $form_state['values'], so we merge it into $form_state['storage'].
	if (isset($form_state['values'])) {
	  if (!isset($form_state['storage'])) {
	    $form_state['storage'] = array();
	  }
	  $storage = $form_state['storage'];
	  $values  = $form_state['values'];
	  $form_state['storage'] = array_smart_merge($storage, $values);
	}

	// Rebuild the form.
	$form = drupal_rebuild_form($form_id, $form_state, $args, $form_build_id);
  
  // figure out the path to the billing state drop down component
  $nid = $form['#parameters'][2]->nid;
	$field = fundraiser_find_field($form, fundraiser_parse_component($nid, 'billing_state'));
	unset($field['#prefix'], $field['#suffix']); // prevent duplicate wrappers
	$output = $field;
	
	// Get the JS settings so we can merge them.
	$javascript = drupal_add_js(NULL, NULL, 'header');
	$settings = call_user_func_array('array_merge_recursive', $javascript['setting']);

	drupal_json(array(
	  'status'    => TRUE,
	  'data'      => drupal_render($output),
	  'settings'  => array('ahah' => $settings['ahah']),
	));
}

function _ahah_helper_disable_validation(&$form) {
  foreach (element_children($form) as $child) {
    $form[$child]['#validated'] = TRUE;
    _ahah_helper_disable_validation($form[$child]);
  }
}


/**
* Smarter version of array_merge_recursive: overwrites scalar values.
*
* This also came (like a God send) from Wim's AHAH helper module. Really, that's the
* easiest way to go, and the module works like a charm - but I wanted to get my
* head around the whole AHAH thing, and maybe you do to, or maybe you can't or don't
* want to be dependant on a different module.
*
* @see PHP Manual on: array-merge-recursive comment #82976.
*/
function array_smart_merge($array, $override) {
  if (is_array($array) && is_array($override)) {
    foreach ($override as $k => $v) {
      if (isset($array[$k]) && is_array($v) && is_array($array[$k])) {
        $array[$k] = array_smart_merge($array[$k], $v);
      }
      else {
        $array[$k] = $v;
      }
    }
  }
  return $array;
}

/**
 * Implementation of hook_webform_submission_insert().
 */
function fundraiser_webform_submission_insert($node, $submission) {
  // insert a record to relate the webform submission to the ubercart order
  if ($node->is_donation_form) {
    db_query("INSERT INTO {fundraiser_webform_order} (webform_nid, order_id, sid, gateway, txn_id, recurring_status) VALUES (%d, %d, %d, '%s', '%s', %d)", $node->nid, $node->order_id, $submission->sid, $node->gateway, $node->txn_id, empty($node->recurring_order) ? DONATION_NON_RECURRING : DONATION_RECURRING);
  }
}

/**
 * Implementation of hook_webform_submission_presave(). 
 */
function fundraiser_webform_submission_presave($node, &$submission) {
  // remove senstive form data before the submission is saved to the database
  if ($node->is_donation_form) {
    $result = db_query("SELECT cid FROM {webform_component} WHERE nid = %d AND form_key IN ('card_number', 'card_cvv', 'card_expiration_date')", $node->nid);
    while ($data = db_fetch_object($result)) {
      $submission->data[$data->cid]['value'][0] = NULL;
    }
  }
}

function mapping_form_access() {
	$is_donation_form = db_result(db_query("select is_donation_form from {fundraiser_gateway} where nid = %d", arg(1)));
	return $is_donation_form;
}

/**
 * Implementation of hook_menu().
 */
function fundraiser_menu() {

	$items['admin/settings/fundraiser'] = array(
		'title' => 'Fundraiser settings',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('fundraiser_admin_settings'),
		'access arguments' => array("access content"),
		'type' => MENU_NORMAL_ITEM,
		'file' => 'fundraiser.admin.inc',
	);
	
	$items['admin/store/reports/fundraiser'] = array(
		'title' => t('Donation report'),
		'page callback' => 'fundraiser_monthly_report',
		'access arguments' => array('view store reports'),
		'type' => MENU_NORMAL_ITEM,
		'file' => 'fundraiser.admin.inc',
	);
	
	$items['node/%webform_menu/webform/mapping'] = array(
	    'title' => 'User map',
	    'page callback' => 'drupal_get_form',
	    'page arguments' => array('fundraiser_mapping_form', 1),
	    'access callback' => 'mapping_form_access',
	    'file' => 'fundraiser_components.inc',
	    'weight' => 30,
	    'type' => MENU_LOCAL_TASK,
	);
	
	$items['fundraiser_changestate/js'] = array(
		'page callback' => 'fundraiser_changestate',
	    'type' => MENU_CALLBACK,
	    'access arguments' => array("access content"),	
	);
	
	$items['zones/js'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'zones_ahah_render',
    'access callback' => TRUE,
  );
	
	$items['admin/fundraiser/recurring'] = array(
		'title' => 'Current Fundraiser Recurring Payments',
	    'page callback' => 'fundraiser_recurring_admin',
	    'access callback' => 'node_access',
	    'access arguments' => array('update', 1),
	    'file' => 'fundraiser_components.inc',
	    'weight' => 2,
	    'type' => MENU_CALLBACK,
	);
	
	$items['admin/fundraiser/recurring/test'] = array(
		'title' => 'Fundraiser Recurring Payment Tester',
	    'page callback' => 'fundraiser_recurring_test',
	    'access callback' => 'node_access',
	    'access arguments' => array('update', 1),
	    'file' => 'fundraiser_components.inc',
	    'weight' => 2,
	    'type' => MENU_CALLBACK,
		);
	
	$items['admin/store/orders/%uc_order/recurring/edit'] = array(
		'title' => 'Edit Recurring Donations',
		'page callback' => 'fundraiser_recurring_edit_forms',
    'access callback' => 'node_access',
    'access arguments' => array('update', 1),
    'file' => 'fundraiser_components.inc',
    'weight' => 2,
    'type' => MENU_NORMAL_ITEM,
	);
	/*	
	$items['user/%user/recurring/edit/%uc_order'] = array(
		'title' => 'My Recurring Payments',
		'page callback' => 'fundraiser_recurring_user_edit_forms',
    'access callback' => user_access('edit own recurring payments'),
    'file' => 'fundraiser_sustainer.inc',
    'page arguments' => array(arg(1), 'shithead'),
    'weight' => 2,
    'type' => MENU_CALLBACK,
	);
	*/
	$items['user/%user/recurring_overview'] = array(
		'title' => 'My Recurring Payments',
    'page callback' => 'fundraiser_recurring_user_overview',
    'access callback' => 'fundraiser_user_has_recurring_orders',
    'access arguments' => array(1),
    'page arguments' => array(1),
    'file' => 'fundraiser.sustainer.inc',
    'weight' => 2,
    'type' => MENU_LOCAL_TASK,
	);
	
	$items['user/%user/recurring_overview/%'] = array(
		'title' => 'My Recurring Payments',
    'page callback' => 'fundraiser_recurring_user_edit_forms',
    'access callback' => 'fundraiser_user_has_recurring_orders',
    'access arguments' => array(1),
    'page arguments' => array(1, 3),
    'file' => 'fundraiser.sustainer.inc',
    'weight' => 2,
    'type' => MENU_LOCAL_TASK,
	);
	
	$items['admin/fundraiser/recurring/logs'] = array(
		'title' => 'Fundraiser Recurring Logs',
    'page callback' => 'fundraiser_recurring_admin_logs',
    'access arguments' => array("access content"),
    'weight' => 2,
    'type' => MENU_CALLBACK,
	);
	
	$items['admin/store/orders/%uc_order/recurring/overview'] = array(
    'title' => 'Recurring Info',
    'page callback' => 'fundraiser_recurring_master_order_overview',
    'access arguments' => array('view all orders'),
    'access callback' => 'fundraiser_recurring_check_access',
    'type' => MENU_LOCAL_TASK,
    'weight' => 11,
    'file' => 'fundraiser_components.inc',
  );

	$items['admin/content/donation-forms'] = array(
		'title' => 'Donation Forms',
		'page callback' => 'fundraiser_donation_form_list',
		'access arguments' => array('create donation forms'),
		'type' => MENU_NORMAL_ITEM,
		'weight' => 20,
		'file' => 'fundraiser.admin.inc',
	);
	
	$items['admin/content/clone-form/%'] = array(
		'title' => 'Clone donation form',
		'page callback' => 'fundraiser_clone_donation_form',
		'page arguments' => array(3),
		'access arguments' => array('create donation forms'),
		'type' => MENU_CALLBACK,
		'file' => 'fundraiser.admin.inc',
	);

	// FUTURE CONFIRMATION PAGE
	/*
	$items['node/%webform_menu/confirmation/%webform_submission'] = array(
    'title' => 'Webform submission',
    'load arguments' => array(1),
    'page callback' => 'fundraiser_donation_confirmation',
    'page arguments' => array(1, 3),
    'access arguments' => array("access content"),
    'type' => MENU_CALLBACK,
  );
	*/

  return $items;
}

/**
 * Implemenation of hook_menu_alter().
 */
function fundraiser_menu_alter(&$items) {
	// workaround for douchebaggy bug where only uid 1 can see custom triggers
	$items['admin/build/trigger/fundraiser']['access callback'] = TRUE;
}

/**
 * Determines if a user has any recurring donations.
 */
function fundraiser_user_has_recurring_orders($user) {
  $count = db_result(db_query(
    "
      SELECT count(u.order_id) FROM uc_orders u
      INNER JOIN fundraiser_recurring f on f.master_order_id = u.order_id
      WHERE u.uid = %d
    ",
    $user->uid
  ));
  
  if ($count > 0) {
    return TRUE;
  }
  return FALSE;
}

// FUTURE CONFIRMATION PAGE
/*
function fundraiser_donation_confirmation($node, $submission) {
	return "booya!";
}
*/

function fundraiser_perm() {
	return array('edit own recurring payments', 'create donation forms');
}

function fundraiser_recurring_check_access() {
	$resource = db_query("select order_id from {fundraiser_recurring} where master_order_id=%d or order_id=%d",arg(3),arg(3));
	$array = db_fetch_array($resource);
	$bool = FALSE;
	if(!empty($array)){
		$bool = TRUE;
	}
	return $bool;
}


function fundraiser_recurring_admin_logs(){
	$resource = db_query("select fundraiser_recurring_log.*, {users}.name
			from {fundraiser_recurring_log} 
			inner join {users} on {fundraiser_recurring_log}.customer_uid = {users}.uid
			order by timestamp desc");
	
	$output = "
	<h3><a href='/admin/fundraiser/recurring'>Return to Fundraising Overview</a></h3>
	<table border=1>
	<tr><th>Order ID</th><th>Customer</th><th>Message</th><th>Date</th></tr>";
	for($i=0;$row = db_fetch_array($resource); $i++){
		$output .= "<tr>
		<td><a href='/admin/store/orders/$row[order_id]'>$row[order_id]</a></td>
		<td><a href='/user/$row[customer_uid]'>$row[name]</a></td>
		<td>User <a href='/user/$row[who_cancelled_uid]'>$row[who_cancelled_uid]</a>: $row[action]</td>
		<td>$row[timestamp]</td>
		</tr>";
	}
	$output .= "</table>";
	
	return $output;
}

function get_country_zones($country_id) {
	$zones = uc_zone_select(uc_get_field_name('zone'), NULL, NULL, $country_id, 'name', uc_address_field_required('zone'));
	$zone_array = array();
	foreach ($zones['#options'] as $key => $value) {
		$zone_array[$key] = $value;
	}
	return $zone_array;
}

function fundraiser_node_insert($node){
	if ($node->type == 'webform' && $node->is_donation_form) {
		db_query("insert into {fundraiser_gateway}
		 	(nid, is_donation_form, gateway, confirmation_email_from_name, confirmation_email_from_email, confirmation_email_subject, confirmation_email_message, donation_amounts, show_other_amount, minimum_donation_amount, internal_name)
			values
			(%d, %d, '%s', '%s', '%s', '%s', '%s', '%s', %d, %d, '%s')",
			$node->nid,
			$node->is_donation_form,
			$node->gateway,
			$node->confirmation_email_from_name,
			$node->confirmation_email_from_email,
			$node->confirmation_email_subject,
			$node->confirmation_email_message,
			$node->donation_amounts,
			$node->show_other_amount,
			$node->minimum_donation_amount,
			$node->internal_name
			);
	}

	if ($node->is_donation_form && (!$node->is_being_cloned && arg(2) != 'clone')) {
		// call create_webform_donation_components
		$components = create_webform_donation_components($node->nid, $node->donation_amounts, $node->show_other_amount, $node->minimum_donation_amount);
		// map the user profile fields
		fundraiser_user_map_create($node->nid, $components);
		
		// fire a hook that other modules can utilize to add additional processing when a donation form is created
		module_invoke_all('fundraiser_form_insert', $node, $components);
	}
}

function fundraiser_node_update($node) {
	if ($node->type == 'webform') 
	{
		// see if this webform is already a donation form
		$is_donation_form = db_result(db_query("select is_donation_form from {fundraiser_gateway} where nid = %d", $node->nid));
		//print_r($node);die();
		// see if we just need to update the fundraiser info
		if ($is_donation_form) {
			db_query("update fundraiser_gateway set internal_name = '%s', show_other_amount=%d, minimum_donation_amount=%d, gateway='%s',confirmation_email_from_name='%s',
				confirmation_email_from_email='%s',confirmation_email_subject='%s',confirmation_email_message='%s' where nid=$node->nid",
				$node->internal_name, $node->show_other_amount, $node->minimum_donation_amount, $node->gateway,$node->confirmation_email_from_name,
				$node->confirmation_email_from_email,$node->confirmation_email_subject,$node->confirmation_email_message);
				
			if ($node->show_other_amount) {
				$extra = db_result(db_query("SELECT extra FROM {webform_component} WHERE nid = %d and form_key = 'other_amount'", $node->nid));
				$extra = unserialize($extra);
				$extra['description'] = 'Minimum payment $' . $node->minimum_donation_amount . '.';
				db_query("UPDATE {webform_component} SET extra = '%s' WHERE nid = %d AND form_key = 'other_amount'", serialize($extra), $node->nid);
			}
		}
	}
}

// Creates a webform specific string of donations amount to be used in the amount component
function _create_amount_options($donation_amounts, $show_other_amount) {
	$amounts = explode(',', $donation_amounts);
	
	$formatted_amounts = '';
	// convert to nice dollar format
	foreach($amounts as $amount) {
		$amount = explode('|', $amount);
		$formatted_amounts .= $amount[0] .'|$'. $amount[0];
		if (!empty($amount[1])) {
			$formatted_amounts .= " - " . $amount[1];
		}
		$formatted_amounts .= "\n";
	}
	
	if ($show_other_amount) {
		$formatted_amounts .= 'other|Other';
	}
	
	return $formatted_amounts;
}

/**
 * Automatically maps predefined webform components to user profile fields.
 */
function fundraiser_user_map_create($nid, $components) {
  foreach($components as $cid => $component) {
    if (array_key_exists('maps_to', $component)) {
      db_query("INSERT INTO {fundraiser_component_map} (nid, cid, map_id) VALUES (%d, %d, '%s')", $nid, $cid, $component['maps_to']);
    }
  }
  drupal_set_message(t('User profile fields have been mapped. Use the User Map tab to edit the map.'));
}

/** 
 * Creates the neccessary webform components to support fundraising
 */
function create_webform_donation_components($nid, $donation_amounts, $show_other_amount, $min_donation_amount) {
	// include the field definition file
	module_load_include('inc', 'fundraiser', 'fundraiser.fields');
	return fundraiser_create_webform_components($nid, $donation_amounts, $show_other_amount, $min_donation_amount);
}

function delete_webform_donation_components($node) {
	$component_names = array("donation", "amount", "other_amount", "billing_information", "first_name", "last_name", "donor_information", "billing_address", "billing_address_2", "billing_city", "billing_country", "billing_state", "billing_zipcode", "credit_card_information", "card_number", "card_expiration_date", "card_cvv", "recurs_monthly", "ms", "cid");
	module_load_include('inc', 'webform', 'webform_components');
	foreach ($node->webform['components'] as $cid => $component) {
		if (in_array($component['form_key'], $component_names)) {
			webform_component_delete($node, $component);
		}
	}
}

function fundraiser_node_load($nid) {
	$result = db_query("SELECT * FROM {fundraiser_gateway} WHERE nid = %d", $nid);
	$row = db_fetch_array($result);
	return $row;
}

function fundraiser_node_delete($nid){
	db_query("DELETE FROM {fundraiser_gateway} WHERE nid = %d", $nid);
}

function fundraiser_node_validate($node){
	$options = _payment_gateway_list('',TRUE);
	$options2 = array();
	foreach($options as $key=>$value){
		$options2[] = $value['id'];
	}
	if(in_array($node->gateway,$options2)){
		
	}
	else{
		form_set_error("fundraiser][gateway", t('There was a problem validating your payment gateway'));
	}
	
}

function theme_fundraiser_mapping_form($form) {
	if ($form['mapping']['cid']) {
		foreach ($form['mapping']['cid'] as $key=>$cid) {
			if (is_numeric($key)) {
				//dprint_r($form['mapping']['type'][$key]); die();
				$row = array();
				$row[] = drupal_render($form['mapping']['cid'][$key]);
				$row[] = drupal_render($form['mapping']['type'][$key]);
				$rows[] = $row;
			}
		}
		$row = array();
		$row[] = drupal_render($form['submit']);
		$row[] = '&nbsp;';
		$rows[] = $row;
	
		$header = array("Webform Component","Profile Field");
		$output = drupal_render($form['info']);
		$output .= theme('table', $header, $rows, array('id' => 'fundraiser_mapping_form'));
		$output .= drupal_render($form);
	}
	else {
		$output = "<p>You must add some fields to the webform before you can map them.</p>";
	}
	return $output;
}

/**
* Implementation of hook_theme().
*/
function fundraiser_theme() {
  return array(
    'fundraiser_mapping_form' => array(
    'arguments' => array(),
    ),
    'sustainer_management_page' => array(
      'template' => 'sustainer-management-page',
      'arguments' => array('order_id' => null, 'orders' => null, 'payment_info' => null, 'billing_info' => null, 'amount_form' => null, 'billing_form' => null, 'cancel_form' => null, 'payment_schedule' => null, 'cancelled' => FALSE),
    ),
    'fundraiser_credit_card_expiration_date' => array(
      'arguments' => array(),
    ),
  );
}

function fundraiser_preprocess_sustainer_management_page(&$vars) {
  global $user;
  // convert the array of orders to a nice data table
  $header = array('Amount', 'Start Date', 'Next Charge Date', 'Expire Date', 'Status');
  $rows = array();
  
  //print "<pre>".print_r($vars['orders'], TRUE)."</pre>";
  
  // format the dates 
  $class = '';
  foreach($vars['orders'] as $id => &$order) {
    $edit_link = l('$' . money_format('%i', $order['amount']), 'user/' . $user->uid . '/recurring_overview/' . $id);
    if ($id == $vars['order_id']) {
      $class = 'recurring-order active';
    }
    else {
      $class = 'recurring-order';
    }
    $rows[] = array(
      'data' => array(
        'amount' => $edit_link,
        'start_date' => date('m/d/y', $order['start_date']),
        'next_charge_date' => date('m/d/y', $order['next_charge_date']),
        'expire_date' => date('m/d/y', $order['expire_date']),
        'status' => $order['status'] == DONATION_CANCELLED ? 'cancelled' : 'active',
      ),
      'class' => $class,
    );
  }
  
  $vars['orders'] = theme('table', $header, $rows);
  
  // format payment schedule into a data table
  $payment_schedule_header = array('Amount', 'Charge Date', 'Processed Status');
  // format some of the data in the array before output
  foreach($vars['payment_schedule'] as &$payment_schedule) {
    $payment_schedule['amount'] = '$' . money_format('%i', $payment_schedule['amount']); 
    $payment_schedule['charge_date'] = date('m/d/y', $payment_schedule['charge_date']);
    $payment_schedule['status'] = empty($payment_schedule['status']) ? 'pending' : $payment_schedule['status'];
  }
  $vars['payment_schedule'] = theme('table', $payment_schedule_header, $vars['payment_schedule']);
}

/**
 * Validate donation form submissions.
 */
function fundraiser_webform_validate($form, &$form_state) {
	$fundraiser_fields = array_flatten($form_state['values']['submitted']);
	
	$node_id = $form_state['values']['details']['nid'];
	$errors = false;
	// collect all of our donation fields
	$donation_amount = $fundraiser_fields['amount'];
	$cc_number = $fundraiser_fields['card_number'];
	$cc_cvv = $fundraiser_fields['card_cvv'];
	$cc_expiration_month = $fundraiser_fields['card_expiration_month'];
	$cc_expiration_year = $fundraiser_fields['card_expiration_year'];
	$email = $fundraiser_fields['email'];
	
	// look for other amount
	if ($donation_amount == "other") {
		$donation_amount = preg_replace("/[^\d\.]/i", "", $fundraiser_fields['other_amount']);
		// make sure other amount is numeric
		if (!is_numeric($donation_amount)) {
			form_set_error('other_amount', "You must enter a valid donation amount.");
			$errors = true;
		}
	}
	
	// check for minimum amount
	$minimum_donation_amount = db_result(db_query("select minimum_donation_amount from {fundraiser_gateway} where nid = %d", $node_id));
	$minimum_donation_amount = number_format($minimum_donation_amount, 2);
	if ($donation_amount < $minimum_donation_amount) {
		form_set_error('submitted][donation][other_amount', "Your donation amount must be greater than or equal to $minimum_donation_amount.");
		$errors = true;
	} 
	
	//validate cc number
	if ((variable_get('uc_credit_validate_numbers', TRUE) && !_valid_card_number($cc_number))
 		|| !ctype_digit($cc_number)) {
   	form_set_error('submitted][credit_card_information][card_number',"You have entered an invalid credit card number.");
		$errors = true;
 	}
    
 	// Validate the card expiration date.
  if (!_valid_card_expiration($cc_expiration_month, $cc_expiration_year)) {
  	form_set_error('submitted][credit_card_information][expiration_date][card_expiration_month', t('The credit card you entered has expired.'));
  	form_set_error('submitted][credit_card_information][expiration_date][card_expiration_year', ' ');
		$errors = true;
  }

	// Validate the CVV Number
	if (variable_get('uc_credit_cvv_enabled', TRUE) && !_valid_cvv($cc_cvv)) {
		form_set_error('submitted][credit_card_information][card_cvv',t('You have entered an invalid CVV number.'));
		$errors = true;
	}
	
	// Validate email address
	if (!_validate_email($email)) {
		form_set_error('email', t('You must enter a valid email address.'));
		$errors = true;
	}
	
	// create watchdog entry on validation errors
	if ($errors) {
		$base = drupal_get_path('module', 'fundraiser');
		drupal_add_js($base .'/jquery.alphanumeric.js');
		drupal_add_js($base .'/fundraiser.js');
		$message = "The following donation form fields failed local validation:\n\n";
		$validation_errors = array_keys(form_get_errors());
		foreach($validation_errors as $field) {
			$keys = explode('][', $field);
			$message .= array_pop($keys) . "\n";
		}
	
		$fundraiser_fields['card_number'] = substr_replace($fundraiser_fields['card_number'], str_repeat('*', strlen($fundraiser_fields['card_number'])), 0);
		$fundraiser_fields['card_cvv'] = substr_replace($fundraiser_fields['card_cvv'], str_repeat('*', strlen($fundraiser_fields['card_cvv'])), 0);
	
		$message .= "\n\nSubmitted Values:\n\n";
		foreach($fundraiser_fields as $key => $value) {
			$message .= $key . ': ' . $value . "\n";
		}
	
		watchdog('fundraiser', $message, NULL, WATCHDOG_DEBUG, NULL);
	}
}

/**
 * Submission handler for donation forms.
 */
function fundraiser_webform_submit($form, &$form_state) {
	$fundraiser_fields = array_flatten($form_state['values']['submitted']);
	$node_id = $form_state['values']['details']['nid'];
	$map = _get_map($form_state['values']['details']['nid'], $form_state['values']['submitted']);
	
	// collect all of our donation fields
	$donation_amount = $fundraiser_fields['amount'];
	$cc_number = $fundraiser_fields['card_number'];
	$cc_cvv = $fundraiser_fields['card_cvv'];
	$cc_expiration_month = $fundraiser_fields['card_expiration_month'];
	$cc_expiration_year = $fundraiser_fields['card_expiration_year'];
	$recurs = $fundraiser_fields['recurs'];
	$first_name = $fundraiser_fields['first_name'];
	$last_name = $fundraiser_fields['last_name'];
	$email = $fundraiser_fields['email'];
	$billing_address = $fundraiser_fields['billing_address'];
	$billing_address_2 = $fundraiser_fields['billing_address_2'];
	$billing_city = $fundraiser_fields['billing_city'];
	$billing_country = $fundraiser_fields['billing_country'];
	$billing_state = $fundraiser_fields['billing_state'];
	$billing_zipcode = $fundraiser_fields['billing_zipcode'];
	$quantity = $fundraiser_fields['quantity'];
	
	// add an additional check for recurs_monthly. this value will be set when the recurring options are
	// set to display as radio buttons
	if (!empty($fundraiser_fields['recurs_monthly'])) {
		$recurs = $fundraiser_fields['recurs_monthly'];
	}
	
	// look for other amount
	if ($donation_amount == "other") {
		$donation_amount = preg_replace("/[^\d\.]/i", "", $fundraiser_fields['other_amount']);
	}

	global $user;

 	$order = uc_order_new($user->uid);
 	
 	$order->products[0] = uc_product_load($node);	  	
 	$order->products[0]->price = $donation_amount;
 	$order->products[0]->qty = empty($quantity) ? 1 : $quantity;
 	$order->products[0]->title = $form['#parameters'][2]->title;
	$order->products[0]->nid = $node_id;
	$order->products[0]->data = array(
		'shippable' => $order->products[0]->shippable,
		'model' =>  $order->products[0]->model,
		'varprice' => $donation_amount,
		'module' => 'uc_product',
	); 
	// multiple amount by quantity if available
	if (!empty($quantity)) {
		$donation_amount = $donation_amount * $quantity;
	}
 	$order->primary_email = $email;
 	$order->order_total = $donation_amount;
 	$order->billing_first_name = $first_name;
 	$order->billing_last_name = $last_name;
 	$order->billing_city = $billing_city;
 	$order->billing_street1 = $billing_address;
 	$order->billing_street2 = $billing_address_2;
 	$order->billing_postal_code = $billing_zipcode;
 	$order->billing_zone = $billing_state;
 	$order->billing_country = $billing_country;
 	$order->payment_method = 'credit';
 	$order->payment_details = array(
 		'cc_type' => _get_cc_type($cc_number),
 		'cc_owner' => '',
 		'cc_number' => $cc_number,
 		'cc_start_month' => '',
 		'cc_start_year' => '',
 		'cc_exp_month' => $cc_expiration_month,
 		'cc_exp_year' => $cc_expiration_year,
 		'cc_issue' => '',
 		'cc_cvv' => $cc_cvv,
 		'cc_bank' => '',
 	);

 	$order->line_items = array();

 	// Cache the CC details stored by the handler.
  uc_credit_cache('save', $order->payment_details, FALSE);
 	// save the order
 	uc_order_save($order);

 	$transaction_type = array(
 		'txn_type' => 'auth_capture'
 	);
 	
 	//go get the Payment Gateway assigned to this node
 	$sql = "SELECT gateway FROM {fundraiser_gateway} WHERE nid = %d";
 	$result = db_query($sql, $form['#parameters'][2]->nid);
 	$row = db_fetch_array($result);
 	$gateway_key = $row['gateway'];
 	
 	$gateways = _payment_gateway_list('', TRUE);
 	
 	foreach ($gateways as $key => $gateway) {
 		if ($gateway['id'] == $gateway_key) {
 			$charge_function = $gateway['credit'];
 		}
 	}
 	
 	$result = $charge_function($order->order_id, $donation_amount, $transaction_type);

 	if ($result['success']) {
 		$form_state['values']['details']['txn_id'] = $result['data']['txn_id'];
 		
		// complete the sale		
		uc_cart_complete_sale($order, variable_get('uc_new_customer_login', FALSE));
		// update the vault if needed
		if (variable_get('uc_sage_vault_status', FALSE) && variable_get('uc_sage_vault_checkout', 'none') == 'insert') {
			db_query("update {uc_sage_vault} set uid = %d where guid = '%s'", $order->uid, $result['ref_id']);
		}

		// enter the payment
		uc_payment_enter($order->order_id, 'fundraiser', $order->order_total, 0, NULL, 'Payment processed by the fundraiser module.');
	
		// mark payment as received
		db_query("update {uc_orders} set order_status='payment_received' where order_id = %d", $order->order_id);
 		
		// save any mapped profile fields
		_save_profile_map($order->uid, $map);

    // save some additional information so it can be utilized later
  	$form['#node']->order_id = $order->order_id;
    $form['#node']->gateway = $gateway_key;
    $form['#node']->txn_id = $result['data']['txn_id'];
    
 		// determine if the donation should be added to the queue
 		$add_to_queue = (module_exists('queue_api')) ? TRUE : FALSE;
 		
 		//if monthly recurring checkbox is set, do the insert into the fundraiser_recurring_users table
 		if ($recurs) {
      $form['#node']->recurring_order = 1;
 			fundraiser_create_future_orders($order->order_id, $gateway_key);
 			// add to queue as a recurring donation
 			if ($add_to_queue) {
	 			sf_queue_insert($order->order_id, FUNDRAISER_RECURRING_DONATION_TYPE, 'create');
	 		}
 		}
 		else {
 			if ($add_to_queue) {
	 			// add to queue as a donation
	 			sf_queue_insert($order->order_id, FUNDRAISER_SINGLE_DONATION_TYPE, 'create');
			} 			
 		}
 		
 		drupal_set_message($result['message'],'status');
 	}
 	else { 
		// failed to process credit cart
 		db_query("update uc_orders set order_status='failed' where order_id = $order->order_id");
		$log_error = 'Order ' . $order->order_id . ' failed gateway validation. Reason: ' . $result['message'];
		watchdog('fundraiser', $log_error, NULL, WATCHDOG_DEBUG, NULL);
		drupal_set_message($result['message']);
		$form_state['rebuild'] = TRUE;
		$form_state['values']['abort'] = TRUE;
 	}
}

/*
 * Saves mapped profile data
 */ 
function _save_profile_map($uid, &$map) {
	if ($map) {
		global $user;
		
		if ($user->uid == 0) {
			$user_to_update = user_load($uid);
		}
		else {
			$user_to_update = $user;
		}

		if(module_exists('profile')){
			$cat_array = profile_categories();
		
			foreach ($cat_array as $cat) {
				$updates = array(); // array for storing updates to each profile category
				$result = _fundraiser_profile_get_fields($cat['name']);
				while ($row = db_fetch_array($result)) {
					if (array_key_exists($row['name'], $map)) {
						$updates[$row['name']] = $map[$row['name']];
					}
				}
				// save profile
				_fundraiser_profile_save_profile($updates, $user_to_update, $cat['name']);
			}				
		}
		// update last_updated date so user will be re-synced on next cron run
		user_save($user_to_update, array('last_updated' => time()));

		// insert user back into queue
		$action = 'update';
		if (empty($user_to_update->salesforce_contact_id)) {
			$action = 'upsert';
		}
		sf_queue_insert($user_to_update->uid, 'user', $action);
	}
}

/** 
 * Extends a current recurring donation series out to a new credit card expiration date.
 */
function fundraiser_extend_future_orders($order_id, $exp_month, $exp_year) {
  // determine the date of the last order, and the number of orders to create out to the new expiration date
  $exp = $exp_year . sprintf("%02d", $exp_month)  ;
  $result = db_query("SELECT max(order_id) as last_order_id, max(next_charge) as last_charge_date, period_diff(%d, date_format(from_unixtime(max(next_charge)),'%Y%m')) as new_order_count FROM {fundraiser_recurring} WHERE master_order_id = %d", $exp, $order_id);
  
  while ($data = db_fetch_object($result)) {
    $last_order_id = $data->last_order_id;
    $last_charge_date = $data->last_charge_date;
    $new_order_count = $data->new_order_count; 
  }

  // load up the last order since it will have the most recent changes
  $order = uc_order_load($last_order_id);
  $gateway = db_result(db_query("SELECT gateway FROM {fundraiser_recurring} WHERE order_id = %d", $last_order_id));
  for ($i = 1; $i <= $new_order_count; $i++) {
    $new_order_id = fundraiser_clone_order($order);
    $charge_date = strtotime("+$i months", $last_charge_date);
		db_query("INSERT INTO {fundraiser_recurring} (master_order_id, order_id, next_charge, gateway) VALUES (%d, %d, '%s', '%s')", $order_id, $new_order_id, $charge_date, $gateway);
		uc_order_comment_save($new_order_id, 0, t('Payment will be processed on !date.', array('!date' => date('n/j/Y', $charge_date))), 'admin');
		// add these new orders to the queue
		if (module_exists('sf_donation') && module_exists('queue_api')) {
      sf_queue_insert($new_order_id, FUNDRAISER_SINGLE_DONATION_TYPE, 'create');
      sf_queue_insert($order_id, FUNDRAISER_RECURRING_DONATION_TYPE, 'update');
    }
  }
}

/**
 * Returns a duplicate of a given order
 */
function fundraiser_clone_order($order) {
  $cloned_order = uc_order_new($order->uid);
  $id = $cloned_order->order_id;
  $cloned_order = clone $order;
  $cloned_order->order_id = $id;
  $cloned_order->order_status = RECURRING_DONATION_STATUS;
  unset($cloned_order->products[0]->order_product_id);
  uc_order_save($cloned_order);
  return $cloned_order->order_id;
}

/**
 * Creates future order based on the the order's credit card expiration date. 
 */
function fundraiser_create_future_orders($order_id, $gateway = NULL) {
	global $user;
	
	// reload the original order so we get any changes that have been made by the payment gateways
	$order = uc_order_load($order_id);

	// determine the number of future donations (Salesforce hard limit is 50. Set as 49 because original order is 1)
	$counter = min(_months_between_dates($order->payment_details['cc_exp_month'], $order->payment_details['cc_exp_year']), 49);
	
	for($i = 1; $i <= $counter; $i++) {
		$next_order = uc_order_new($user->uid);
		// copy all values to new order
		$new_id = $next_order->order_id;
		$next_order = clone $order;
		$next_order->order_id = $new_id;
		$next_order->order_status = 'pending_future_payment';
		
		unset($next_order->products[0]->order_product_id);
		uc_order_save($next_order);
		$next_charge = strtotime("+$i months");
		
		// make a record of the recurring order
		db_query("INSERT INTO {fundraiser_recurring} (master_order_id, order_id, next_charge, gateway) VALUES (%d, %d, '%s', '%s')", $order_id, $new_id, $next_charge, $gateway);
		
		// add a comment to the order stating when it will be charged
		uc_order_comment_save($new_id, 0, t('Payment will be processed on !date.', array('!date' => date('n/j/Y', $next_charge))), 'admin');
	}
	
}

/**
 * Function returns months between today's datestamp and $exp_date -1
 */
function _months_between_dates($exp_month, $exp_year){
	$startDate = strtotime("now");
  $stopDate = mktime(0,0,0, $exp_month, 1, $exp_year);
   
  $nrmonths = ((idate('Y', $stopDate) * 12) + idate('m', $stopDate)) - ((idate('Y', $startDate) * 12) + idate('m', $startDate));
	return  $nrmonths;
}

/**
 * Gets the gateway associated with a given order. First it looks to see if the gateway has been
 * stored with the individual order. If it hasn't it uses the gateway that was assigned to the
 * donation form where the order originated.
 */
function _fundraiser_charge_function($order_id, $nid) {
  // first, see if the gateway is stored with the order
  $gateway = db_result(db_query("SELECT gateway FROM {fundraiser_recurring} WHERE order_id = %d", $order_id));
  
  if (empty($gateway)) {
    // get the gateway from the original donation form
    $gateway = db_result(db_query("SELECT gateway FROM {fundraiser_gateway} WHERE nid = %d", $nid));
  }

  $gateways = _payment_gateway_list('', TRUE);
	// get the charge function for the given gateway
	foreach ($gateways as $k => $v){
		if ($v['id'] == $gateway) {
			return $v['credit'];
		}
	}
	
  return FALSE;
}

/**
 * Implementation of hook_cron().
 */
function fundraiser_cron() {
  // TODO: Add a check for a file key before processing donations
  if (fundraiser_processor_key_match()) {
    fundraiser_process_recurring_donations();
  }
  else {
    $message = t('The fundraiser sustainer key has not been configured correctly. Recurring donations will not be processed.');
    drupal_set_message($message, 'warning');
    watchdog('fundraiser', $message, NULL, WATCHDOG_CRITICAL);
  }
}

/**
 * Submits recurring donations for payment
 */
function fundraiser_process_recurring_donations() {
  
  $successes = 0;
  $fails = 0;

	$orders_to_process = db_query("SELECT * FROM {fundraiser_recurring} WHERE next_charge < %d AND 
		(gateway_resp IS NULL OR gateway_resp = 'failed') AND attempts < 3", time());
	
	// loop over the found orders
	while ($order_info = db_fetch_array($orders_to_process)) {
		$order_id = $order_info['order_id'];
		$order = uc_order_load($order_id);
		$total = $order->order_total;

    $charge_function = _fundraiser_charge_function($order_id, $order->products[0]->nid);

		// get the id of the reference to the customers cc data
		$ref_id = array_shift(array_keys($order->data['cc_txns']['references']));
		$data = array(
  		'txn_type' => 'reference_txn',
			'ref_id' => $ref_id,
  	);

		// process the order
	  $result = $charge_function($order_id, $total, $data);
		if ($result['success']) {
			$successes++;
			uc_payment_enter($order_id, 'fundraiser_recurring', $total, 0, NULL, 'Submitted for payment via cron run.');
			uc_order_comment_save($order_id, 0, t('Submitted for payment via cron run. Transaction Id: @txn_id', array('@txn_id' => $result['data']['txn_id'])), 'admin'); 
		  db_query("UPDATE {uc_orders} SET order_status = 'payment_received' WHERE order_id = %d", $order_id);
			db_query("UPDATE {fundraiser_recurring} SET gateway_resp = 'success', txn_id = '%s' WHERE order_id = %d", $result['data']['txn_id'], $order_id);

      // Send credit card notification email when only a single payment is left
      if (fundraiser_recurring_payments_remaining($order_info['master_order_id']) == 1) {
        fundraiser_send_cc_notification($order_info['master_order_id'], $order->uid);
      }
 
			// Check for Salesforce Fundraiser module and update order status
			if (module_exists('sf_donation')) {
				sf_queue_insert($order->order_id, FUNDRAISER_SINGLE_DONATION_TYPE, 'update');
			}
		}
		else {
			$fails++;
			db_query("UPDATE {uc_orders} SET order_status = 'failed' WHERE order_id = %d", $order->order_id);
			db_query("UPDATE {fundraiser_recurring} SET 
				gateway_resp = 'failed', 
				attempts = attempts + 1,
				next_charge = unix_timestamp(timestampadd(DAY, 1, from_unixtime(next_charge)))
				WHERE order_id = %d", $order_id
			);
			// get the number of times this order has been attempted
			$attempt_count = db_result(db_query("SELECT attempts FROM {fundraiser_recurring} WHERE order_id = %d", $order->order_id));
			if ($attempt_count == 3) {
				// final attempt. add debug alert
				watchdog('fundraiser', t('Payment for recurring donation !id has failed 3 times. The order will not be submitted for payment again. Gateway message: !message', array('!id' => $order->order_id, '!message' => $result['message'])), NULL, WATCHDOG_DEBUG);
			}
			else {
				// log this failure
				watchdog('fundraiser', t('Payment for recurring donation !id has failed !attempts times. It will be processed again in 1 day. Gateway message: !message', array('!id' => $order->order_id, '!attempts' => $attempt_count, '!message' => $result['message'])), NULL, WATCHDOG_DEBUG);
			}
			// fire sustainer payment failure trigger
			module_invoke_all('fundraiser', 'sustainer_payment_declined', $order);
		}
		// clear the credit card cache between orders
		uc_credit_cache('clear');
	}

    if ($successes > 0 || $fails > 0) {
      watchdog('fundraiser', '!successes recurring fees processed successfully; !fails failed.', array('!successes' => $successes, '!fails' => $fails));
    }
}

/**
 * Returns the number of unprocessed payments for a recurring donation series.
 */
function fundraiser_recurring_payments_remaining($master_order_id) {
  return db_result(db_query("SELECT count(order_id) FROM fundraiser_recurring WHERE master_order_id = %d AND gateway_resp IS NULL", $master_order_id));
}

/**
 * Kicks of an email to a sustainer to remind them their credit card is about to expire.
 */
function fundraiser_send_cc_notification($master_order_id, $uid) {
  $user = user_load($uid);
  // load the last remaining order so we can get some info for the email
  $order_id = db_result(db_query("SELECT order_id FROM fundraiser_recurring WHERE master_order_id = %d AND gateway_resp IS NULL", $master_order_id));
  $order = uc_order_load($order_id);
  
  // set up some params that can be used in the email
  $params['exp_month'] = $order->payment_details['cc_exp_month'];
  $params['exp_year'] = $order->payment_details['cc_exp_year'];
  $params['cc_last_4'] = substr($order->payment_details['cc_number'], -4);
  $params['cc_type'] = $order->payment_details['cc_type'];
  $params['amount'] = $order->order_total;
  $params['order_id'] = $order_id;
  $params['user'] = $user;
  $params['master_order_id'] = $master_order_id;
  
  watchdog('fundraiser', t('Credit card expiration email sent to @mail', array('@mail' => $user->mail)), NULL, WATCHDOG_INFO);
  drupal_mail('fundraiser', 'fundraiser_cc_notification', $user->mail, user_preferred_language($user), $params);
}

function _get_map($nid, $array1) {
	$form_values = array_flatten($array1);
	
	// override numeric state and country values
	$form_values['billing_state'] = db_result(db_query("select zone_code from {uc_zones} where zone_id = %d", $form_values['billing_state']));
	$form_values['billing_country'] = db_result(db_query("select country_iso_code_2 from {uc_countries} where country_id = %d", $form_values['billing_country']));

	$sql = "select w.form_key, f.cid, f.map_id from webform_component w inner join 
		fundraiser_component_map f on f.cid = w.cid and f.nid = w.nid where f.nid = %d order by f.cid";
	$result = db_query($sql, $nid);
	while($row = db_fetch_array($result)){
		$map[$row['form_key']] = $row['map_id'];
	}

	if ($map) {
		foreach($map as $key=>$value){
			$map2[$value] = $form_values[$key];
		}
		return $map2;
	}
	return array();
}

/** 
 * Implemenation of hook_mail().
 */
function fundraiser_mail($key, &$message, &$params) {
  switch ($key) {
    case 'fundraiser_cc_notification':
      $body = variable_get('fundraiser_cc_exp_body', 'Your card ending in [cc_last_4] is about to expire on [exp_month]/[exp_year].');
      // do some token replacements
      $tokens = array('[exp_month]', '[exp_year]', '[cc_type]', '[cc_last_4]', '[amount]');
      $replaces = array($params['exp_month'], $params['exp_year'], $params['cc_type'], $params['cc_last_4'], $params['amount']);
      $body = str_replace($tokens, $replaces, $body);
       // replace any user tokens via the token module
      $body = token_replace($body, 'user', $params['user']);
      
      $message['subject'] = variable_get('fundraiser_cc_exp_subject', 'Your credit card is about to expire');
      $message['body'] = $body;
      break;
  }
}

/**
 * Implementation of hook_order().
 */
function fundraiser_order($op, &$arg1, $arg2) {
  switch ($op) {
    case 'delete':
      // remove the order from fundraiser tables
      db_query("DELETE FROM {fundraiser_recurring} WHERE order_id = %d", $arg1->order_id);
      break;
  }
}

/**
 * Implemenation of hook_mail_alter().
 *
 * Change the from address and subject for donation receipt emails.
 */
function fundraiser_mail_alter(&$message){
	$parts = explode("/",$_GET['q']);
	$nid = $parts[1];
	$node = node_load($nid);
	
	if ($message['id'] == 'uc_order_action-mail') {
		$message['headers']['From'] = $headers['Sender'] = $headers['Return-Path'] = $headers['Errors-To'] = $node->confirmation_email_from_name . ' <' .$node->confirmation_email_from_email . '>';
    $bcc = variable_get('fundraiser_receipt_bcc', '');
    if (!empty($bcc)) {
      $message['headers']['Bcc'] = $bcc;
    }

		$message['from'] = $node->confirmation_email_from_name . ' <' .$node->confirmation_email_from_email . '>';
		$message['subject'] = $node->confirmation_email_subject;
	}
}

 /**
 * Implementation of hook_preprocess_uc_order().
 *
 * Adds additional variables for use in donation receipt emails.
 *
 */
function fundraiser_preprocess_uc_order(&$variables) {
  switch ($variables['op']) {
    case 'checkout-mail':
      $nid = $variables['order']->products[0]->nid;
      $message = db_result(db_query("SELECT confirmation_email_message FROM {fundraiser_gateway} WHERE nid = %d", $nid));
      $variables['fundraiser_message'] = $message;
      break;
  }
}

function _credit_card_expirations() {
	// create a string of years for select options
	$years = '';
	$this_year = date("Y");
	for($i = $this_year; $i<= $this_year + 5; $i++) {
		$years .= $i .'|'. $i ."\n";
	}
	return $years;
}

function array_flatten($array, $preserve_keys = 1, &$newArray = Array()) {
  foreach ($array as $key => $child) {
    if (is_array($child)) {
      $newArray =& array_flatten($child, $preserve_keys, $newArray);
    } elseif ($preserve_keys + is_string($key) > 1) {
      $newArray[$key] = $child;
    } else {
      $newArray[] = $child;
    }
  }
  return $newArray;
}

function _validate_email($mail) {
	return eregi("^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,6}$", $mail);
	//return preg_match("^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,6}$", $mail);
}

function _get_cc_type($cardnumber) {
	$cardtype = "UNKNOWN";
	$len = strlen($cardnumber);
	if ( $len == 15 && substr($cardnumber, 0, 1) == '3' ) { $cardtype = "amex"; }
	elseif ( $len == 16 && substr($cardnumber, 0, 4) == '6011' ) { $cardtype = "discover"; }
	elseif ( $len == 16 && substr($cardnumber, 0, 1) == '5' ) { $cardtype = "mc"; }
	elseif ( ($len == 16 || $len == 13) && substr($cardnumber, 0, 1) == '4' ) { $cardtype = "visa"; }
	return ( $cardtype );
}

/*
 * Support for cloning via the node clone module
 */
function fundraiser_clone_node_alter(&$node, $original_node, $method) {
	if ($method == 'prepopulate') {
		$node->internal_name = 'Clone of ' . $original_node->internal_name;
	}
}

/**
 * Implemenation of queue_report_item_name().
 */
function fundraiser_queue_report_item_title_alter(&$row) {
	if ($row['type'] == 'donation' || $row['type'] == 'recurring_donation') {
		$title = 'Order ' . $row['oid'];
		$row['title'] = $title;
	}
}

/** 
 * Version of _profile_get_fields that includes hidden profile fields by default
 */
function _fundraiser_profile_get_fields($category) {
  $sql = "SELECT * FROM {profile_fields} WHERE LOWER(category) = LOWER('%s') ORDER BY category, weight";
  return db_query($sql, $category);
}

/** 
 * Version of profile_save_profile that includes hidden profile fields 
 */
function _fundraiser_profile_save_profile(&$edit, &$user, $category) {
  $result = _fundraiser_profile_get_fields($category);
  while ($field = db_fetch_object($result)) {
    if (_profile_field_serialize($field->type)) {
      $edit[$field->name] = serialize($edit[$field->name]);
    }
    db_query("DELETE FROM {profile_values} WHERE fid = %d AND uid = %d", $field->fid, $user->uid);
    db_query("INSERT INTO {profile_values} (fid, uid, value) VALUES (%d, %d, '%s')", $field->fid, $user->uid, $edit[$field->name]);
    // Mark field as handled (prevents saving to user->data).
    $edit[$field->name] = NULL;
  }
}

/******************************************************************************
 * TRIGGERS
 *****************************************************************************/

/**
 * Implementation of hook_hook_info(). 
 */
function fundraiser_hook_info() {
	return array(
		'fundraiser' => array(
			'fundraiser' => array(
				'sustainer_payment_declined' => array(
					'runs when' => t('A sustainer\'s credit card payment is declined'),
				),
		  ),
		),
	);
}

/**
 * Implementation of hook_fundraiser().
 */
function fundraiser_fundraiser($op, $order) {
  $aids = _trigger_get_hook_aids('fundraiser', $op);
  $context = array(
    'hook' => 'fundraiser',
    'op' => $op,
    'order' => $order,
  );
	$dummy = new stdClass();
  actions_do(array_keys($aids), $dummy, $context);
}

/**
 * Implementation of hook_drupal_alter().
 */
function fundraiser_action_info_alter(&$info) {
  if (isset($info['token_actions_send_email_action']['hooks']['fundraiser'])) {
    array_merge($info['token_actions_send_email_action']['hooks']['fundraiser'], array('sustainer_payment_declined'));
  }
  else {
    $info['token_actions_send_email_action']['hooks']['fundraiser'] = array('sustainer_payment_declined');
  }
}
/**
 * Implemenation of hook_webform_select_options_info().
 */
function fundraiser_webform_select_options_info() {
  $items = array();
  include 'includes/fundraiser.options.inc';
  return _fundraiser_webform_select_options_info();
}

/**
 * Loads the recurring donation processor key.
 *
 * @return FALSE if no key is found or the key domain does not match the current domain.
 */
function fundraiser_processor_key_match() {
  static $key;

  if (!empty($key)) {
    return ($key == $_SERVER['HTTP_HOST']);
  }

  $dir = variable_get('uc_credit_encryption_path', t('Not configured, see below.'));
  if (!empty($dir) && $dir !== t('Not configured, see below.')) {
    $filename = rtrim($dir, '/\\') .'/sustainer.key';

    if (file_exists($filename)) {
      if (!$file = fopen($filename, 'r')) {
        return FALSE;
      }

      $key = fread($file, filesize($filename));
      if (trim($key) != trim($_SERVER['HTTP_HOST'])) {
        return FALSE;
      }
      fclose($file);
    }
    else {
      return FALSE;
    }
  }
  else {
    return FALSE;
  }

  return TRUE;
}