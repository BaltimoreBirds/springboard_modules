<?php
// $Id$

/**
 * @file
 * Page Wrappers Feature
 *
 * Adds the ability for users to create custom page templates that can be assigned to specific nodes
 * in order the change their appearance.
 */

// include feature
include_once('page_wrappers.features.inc');

/**
 * Implementation of hook_menu().
 */
function page_wrappers_menu() {
  $items['admin/settings/page-wrappers'] = array(
    'title' => t('Page wrapper settings'),
    'description' => t('Configure page wrapper settings.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('page_wrappers_settings_form'),
    'access arguments' => array('administer page wrappers'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'page_wrappers.admin.inc',
  );
  
  return $items;
}

/**
 * Implementation of hook_perm().
 */
function page_wrappers_perm() {
  return array('administer page wrappers');
}

/**
 * Implementation of hook_theme_registry_alter().
 */
function page_wrappers_theme_registry_alter(&$theme_registry) {
  // tell the theme registry to look in this module's directory for theme files
  $theme_registry['page']['theme paths'][] = drupal_get_path('module', 'page_wrappers') . '/theme';
}

/**
 * Implementation of hook_preprocess_page().
 */
function page_wrappers_preprocess_page(&$vars) {
  // TODO: Check to see if this node has a page template assigned to it.
  if ($vars['node']->type == 'donation_form') {
    $vars['template_file'] = 'page-fancy-page';     
  }
}

/**
 * Implementation of hook_nodeapi().
 */
function page_wrappers_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  // only response to page wrappers
  if ($node->type == 'page_wrapper') {
    switch ($op) {
      case 'insert':
      case 'update':
        _page_wrappers_create_template($node);
        break;
    }
  }
}

function _page_wrappers_create_template($node) {
  // get the full path to the wrappers directory
  $base_path = $_SERVER['DOCUMENT_ROOT'] . '/' . drupal_get_path('module', 'page_wrappers') . '/theme';
  
  // create a template file name based on title
  $filename = 'page-' . strtolower(str_replace(' ', '-', $node->title)) . '.tpl.php'; // TODO: Better filename creator
  $full_path = $base_path . '/' . $filename;
  
  // open the file for writing
  $file = fopen($full_path, 'w');
  fputs($file, $node->body);
  
  fclose($file);
}
