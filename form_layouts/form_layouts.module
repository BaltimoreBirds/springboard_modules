<?php
/**
 * @file
 * Provide options for form layouts in webforms.
 */

/**
 * Implements hook_theme().
 *
 * Add a theme function for each template found.
 */
function form_layouts_theme($existing, $type, $theme, $path) {
  $templates = form_layouts_info();
  $theme = array();
  foreach ($templates as $template) {
    $theme[$template['theme']] = array(
      'render element' => 'element',
      'template' => $template['template'],
      'path' => isset($template['path']) ? $template['path'] : $path . '/templates/',
      'pattern' => $template['pattern'],
    );
  }

  return $theme;
}

/**
 * Implements hook_form_BASE_FORM_ID_alter() for node_form().
 *
 * Adds a form layout select field to node add/edit forms where form layouts
 * are enabled..
 */
function form_layouts_form_node_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['#node']) && form_layouts_type_is_layouts_enabled($form['#node']->type)) {
    $templates = form_layouts_info();

    // Some layouts are exclusive to fundraiser enabled types or petition
    // enabled types.
    $fundraiser_enabled = fundraiser_is_donation_type($form['#node']->type);
    if (module_exists('springboard_petition')) {
      $petition_enabled = springboard_petition_is_petition_type($form['#node']->type);
    }
    else {
      $petition_enabled = FALSE;
    }

    $options = array();
    foreach ($templates as $template) {
      // Only show compatible layouts.
      if (($fundraiser_enabled && $template['type'] == 'fundraiser') || ($petition_enabled && $template['type'] == 'petition') || ($template['type'] == 'webform')) {
        $options[$template['theme']] = $template['name'];
      }
    }

    $template = isset($form['nid']['#value']) ? form_layouts_get_node_template($form['nid']['#value']) : array();
    $theme = '';
    if (!empty($template)) {
      $theme = $template['theme'];
    }
    $form['form_layouts'] = array(
      '#type' => 'fieldset',
      '#title' => t('Form layout settings'),
      '#description' => t('Select the form layout for this content. Defaults to one-column layout.'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#group' => 'additional_settings',
    );
    $form['form_layouts']['form_layouts'] = array(
      '#type' => 'select',
      '#title' => t('Form layout'),
      '#options' => $options,
      '#default_value' => $theme,
      '#weight' => -4,
    );
  }
}

/**
 * Implements hook_node_load().
 *
 * Make sure the layout gets loaded.
 */
function form_layouts_node_load($nodes, $types) {
  foreach ($nodes as $nid => $node) {
    if (form_layouts_type_is_layouts_enabled($node->type)) {
      $template = form_layouts_get_node_template($nid);
      $nodes[$nid]->form_layouts = $template['theme'];
    }
  }
}

/**
 * Implements hook_node_insert().
 */
function form_layouts_node_insert($node) {
  form_layouts_node_update($node);
}

/**
 * Implements hook_node_update().
 *
 * Save the layout name to the DB table.
 */
function form_layouts_node_update($node) {
  if (form_layouts_type_is_layouts_enabled($node->type) && isset($node->form_layouts)) {

    $layout = new FormLayout($node->nid);
    if (!is_null($layout->getNid())) {
      $layout->update($node->form_layouts);
    }
    else {
      $layout->create($node->nid, $node->form_layouts);
    }
  }
}

/**
 * Implements hook_node_delete().
 */
function form_layouts_node_delete($node) {
  $layout = new FormLayout($node->nid);
  $layout->delete();
}

/**
 * Implements hook_node_view().
 *
 * If we have a general webform or petition layout, change the node theme.
 * Otherwise it's a fundraiser only layout and so change the webform theme.
 */
function form_layouts_node_view($node, $view_mode, $langcode) {
  if (form_layouts_type_is_layouts_enabled($node->type) && isset($node->form_layouts)) {
    $template = form_layouts_get_node_template($node->nid);
    if (form_layouts_template_themes_webform($template)) {
      $node->content['webform']['#theme'] = array($template['theme'] . '_' . $node->nid, $template['theme']);
    }
    else {
      $node->content['#theme'] = $node->form_layouts;
    }
  }
}

/**
 * Implements hook_form_layouts_info().
 *
 * Adds some basic form layouts for fundraiser enabled types, petition enabled
 * types, and generic webforms.
 */
function form_layouts_form_layouts_info() {
  $templates = array();

  $templates['one_column'] = array(
    'name' => t('One column'),
    'type' => 'webform',
    'theme' => 'one_column',
    'pattern' => 'one_column_\'0-9\'+',
    'template' => 'one-column',
    'path' => drupal_get_path('module', 'form_layouts') . '/templates',
  );

  $templates['two_column_donation'] = array(
    'name' => t('Two column: donation form'),
    'type' => 'fundraiser',
    'theme' => 'two_column_donation',
    'pattern' => 'two_column_donation_\'0-9\'+',
    'template' => 'two-column-donation',
    'path' => drupal_get_path('module', 'form_layouts') . '/templates',
  );

  $templates['two_column_webform_form_left'] = array(
    'name' => t('Two column: webform with the form on the left'),
    'type' => 'webform',
    'theme' => 'two_column_webform_form_left',
    'pattern' => 'two_column_webform_form_left_\'0-9\'+',
    'template' => 'two-column-webform-form-left',
    'path' => drupal_get_path('module', 'form_layouts') . '/templates',
  );

  $templates['two_column_webform_form_right'] = array(
    'name' => t('Two column: webform with the form on the right'),
    'type' => 'webform',
    'theme' => 'two_column_webform_form_right',
    'pattern' => 'two_column_webform_form_right_\'0-9\'+',
    'template' => 'two-column-webform-form-right',
    'path' => drupal_get_path('module', 'form_layouts') . '/templates',
  );

  $templates['one_column_webform_form_top'] = array(
    'name' => t('One column: webform with the form on the top'),
    'type' => 'webform',
    'theme' => 'one_column_webform_form_top',
    'pattern' => 'one_column_webform_form_top_\'0-9\'+',
    'template' => 'one-column-webform-form-top',
    'path' => drupal_get_path('module', 'form_layouts') . '/templates',
  );

  $templates['two_column_petition_form_left'] = array(
    'name' => t('Two column: petition with the form on the left'),
    'type' => 'petition',
    'theme' => 'two_column_petition_form_left',
    'pattern' => 'two_column_petition_form_left_\'0-9\'+',
    'template' => 'two-column-petition-form-left',
    'path' => drupal_get_path('module', 'form_layouts') . '/templates',
  );

  $templates['two_column_petition_form_right'] = array(
    'name' => t('Two column: petition with the form on the right'),
    'type' => 'petition',
    'theme' => 'two_column_petition_form_right',
    'pattern' => 'two_column_petition_form_right_\'0-9\'+',
    'template' => 'two-column-petition-form-right',
    'path' => drupal_get_path('module', 'form_layouts') . '/templates',
  );

  $templates['one_column_petition_form_top'] = array(
    'name' => t('One column: petition with the form on the top'),
    'type' => 'petition',
    'theme' => 'one_column_petition_form_top',
    'pattern' => 'one_column_petition_form_top_\'0-9\'+',
    'template' => 'one-column-petition-form-top',
    'path' => drupal_get_path('module', 'form_layouts') . '/templates',
  );

  $templates['two_column_hybrid_donation'] = array(
    'name' => t('Hybrid two column: donation form'),
    'type' => 'fundraiser',
    'theme' => 'two_column_hybrid_donation',
    'pattern' => 'two_column_hybrid_donation_\'0-9\'+',
    'template' => 'two-column-hybrid-donation',
    'path' => drupal_get_path('module', 'form_layouts') . '/templates/',
  );

  $templates['two_column_left_right'] = array(
    'name' => t('Two column: left-right fieldsets'),
    'type' => 'fundraiser',
    'theme' => 'two_column_left_right',
    'pattern' => 'two_column_left_right_\'0-9\'+',
    'template' => 'two-column-left-right',
    'path' => drupal_get_path('module', 'form_layouts') . '/templates/',
  );

  return $templates;
}

/**
 * Returns the template array that contains which layout the webform uses.
 *
 * @param int $nid
 *   The node id for the template to look up.
 */
function form_layouts_get_node_template($nid) {
  $layout = new FormLayout($nid);
  $theme = $layout->getName();
  $templates = form_layouts_info();

  return $templates[$theme];
}

/**
 * Returns a list of available webform, fundraiser, and petition templates.
 *
 * @see form_layouts_form_layouts_info()
 */
function form_layouts_info() {
  static $templates;
  if (empty($templates)) {
    $templates = module_invoke_all('form_layouts_info');
    drupal_alter('form_layouts_info', $templates);
  }

  return $templates;
}

/**
 * Implements hook_preprocess_HOOK() for two-column-left-right.tpl.php.
 */
function form_layouts_preprocess_two_column_left_right(&$vars) {
  form_layouts_fundraiser_preprocess($vars);
}

/**
 * Implements hook_preprocess_HOOK() for two-column-donation.tpl.php.
 */
function form_layouts_preprocess_two_column_donation(&$vars) {
  form_layouts_fundraiser_preprocess($vars);
}

/**
 * Implements hook_preprocess_HOOK() for two-column-hybrid-donation.tpl.php.
 */
function form_layouts_preprocess_two_column_hybrid_donation(&$vars) {
  form_layouts_fundraiser_preprocess($vars);
}

/**
 * Preprocess function that breaks a fundraiser form into its fieldsets.
 */
function form_layouts_fundraiser_preprocess(&$vars) {
  if (isset($vars['element']['#form']['submitted']['donation'])) {
    $vars['donation_fieldset'] = drupal_render($vars['element']['#form']['submitted']['donation']);
    $vars['donor_information_fieldset'] = drupal_render($vars['element']['#form']['submitted']['donor_information']);
    $vars['billing_information_fieldset'] = drupal_render($vars['element']['#form']['submitted']['billing_information']);
    $vars['payment_information_fieldset'] = drupal_render($vars['element']['#form']['submitted']['payment_information']);
    // Do Not Loop This Process.
    // We don't want to keep trying to render this theme.
    unset($vars['element']['#theme']);
    // Place in a location the end template can pick up.
    $vars['form'] = $vars['element'];
  }
}

/**
 * Determines if the given content type is enabled for form layouts.
 *
 * @param int $type
 *   The machine name of a content type.
 *
 * @return bool
 *   TRUE if the content type is form layouts enabled.
 */
function form_layouts_type_is_layouts_enabled($type) {
  return (bool) variable_get('form_layouts_' . $type, 0);
}

/**
 * Determine if a template is meant to theme the webform or the entire node.
 *
 * @param array $template
 *   The template array.  Just need the type.
 *
 * @return bool
 *   TRUE if the template is meant to theme the webform and not the whole node.
 */
function form_layouts_template_themes_webform($template) {
  if (isset($template['type']) && $template['type'] == 'fundraiser') {
    return TRUE;
  }

  return FALSE;
}

/**
 * Implements hook_form_alter() for node_type_form().
 *
 * Alter content type settings to add "Enable form layouts?" checkbox.
 */
function form_layouts_form_node_type_form_alter(&$form, &$form_state) {

  if (isset($form['type'])) {
    $form['form_layouts'] = array(
      '#type' => 'fieldset',
      '#title' => t('Form layout settings'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#group' => 'additional_settings',
    );

    if (!empty($form['#node_type']->type)) {
      $default_value = form_layouts_type_is_layouts_enabled($form['#node_type']->type);
    }
    else {
      $default_value = FALSE;
    }

    $form['form_layouts']['form_layouts'] = array(
      '#type' => 'checkbox',
      '#title' => t('Enable form layouts'),
      '#default_value' => $default_value,
      '#description' => t('Allow selection of predefined webform templates for this content type. If checked this content type will be webform enabled if it is not already.'),
    );

    $form['#submit'][] = 'form_layouts_form_node_type_form_submit';
  }
}

/**
 * Submit handler for the node type form.
 *
 * If form layouts are enabled, ensure webform is also enabled.
 */
function form_layouts_form_node_type_form_submit($form, $form_state) {
  $type = $form_state['values']['type'];

  if ($form_state['values']['form_layouts']) {
    // Enable webform for this type if it's not enabled..
    $webform_types = webform_variable_get('webform_node_types');
    $webform_key = array_search($type, $webform_types);
    if ($webform_key === FALSE) {
      $webform_types[] = $type;
      variable_set('webform_node_types', $webform_types);
      drupal_set_message('Webform has been enabled for this content type.');
    }
  }
}

/**
 * Implements hook_node_type_delete().
 *
 * Remove this node type from being form layouts enabled.
 */
function form_layouts_node_type_delete($info) {
  variable_del('form_layouts_' . $info->type);
}

/**
 * Implements hook_page_alter().
 */
function form_layouts_page_alter(&$page) {

  // Define the module path for use below.
  $mod_path = drupal_get_path('module', 'form_layouts');

  // Global node.
  $node = menu_get_object();

  // Not admin path.
  if (!path_is_admin(current_path())) {
    // Only if form layouts is enabled.
    if (form_layouts_type_is_layouts_enabled($node->type)) {

      // Custom form layout css.
      $form_layouts_css = array(
        '#attached' => array(
          'css' => array(
            $mod_path . '/css/form-layouts.css' => array(
              'group' => CSS_THEME,
              'weight' => 9999,
            ),
          ),
        ),
      );
      drupal_render($form_layouts_css);
    }
  }

}

/**
 * Implements hook_preprocess_page().
 */
function form_layouts_preprocess_page(&$vars) {

  // Global node.
  $node = menu_get_object();
  if (!path_is_admin(current_path())) {
    // Only if form layouts is enabled.
    if (form_layouts_type_is_layouts_enabled($node->type)) {
      // Unset the page title, we set it in the form layout template.
      $vars['title'] = '';
    }
  }

}

/**
 * Implements hook_preprocess_two_column_webform_form_left().
 */
function form_layouts_preprocess_two_column_webform_form_left(&$vars) {
  // Dig the title out and create a var to render it in the template.
  $vars['element']['title'] = $vars['element']['#node']->title;
}

/**
 * Implements hook_preprocess_two_column_webform_form_right().
 */
function form_layouts_preprocess_two_column_webform_form_right(&$vars) {
  // Dig the title out and create a var to render it in the template.
  $vars['element']['title'] = $vars['element']['#node']->title;
}

/**
 * Implements hook_preprocess_one_column_webform_form_top().
 */
function form_layouts_preprocess_one_column_webform_form_top(&$vars) {
  // Dig the title out and create a var to render it in the template.
  $vars['element']['title'] = $vars['element']['#node']->title;
}

/**
 * Implements hook_preprocess_two_column_petition_form_left().
 */
function form_layouts_preprocess_two_column_petition_form_left(&$vars) {
  // Dig the title out and create a var to render it in the template.
  $vars['element']['title'] = $vars['element']['#node']->title;
}

/**
 * Implements hook_preprocess_two_column_petition_form_right().
 */
function form_layouts_preprocess_two_column_petition_form_right(&$vars) {
  // Dig the title out and create a var to render it in the template.
  $vars['element']['title'] = $vars['element']['#node']->title;
}

/**
 * Implements hook_preprocess_one_column_petition_form_top().
 */
function form_layouts_preprocess_one_column_petition_form_top(&$vars) {
  // Dig the title out and create a var to render it in the template.
  $vars['element']['title'] = $vars['element']['#node']->title;
}
