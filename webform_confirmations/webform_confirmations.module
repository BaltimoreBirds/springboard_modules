<?php

/**
 * @file
 * Provides the ability to re-title a confirmation page differently from
 * the webform that generated it. Also enables the use of node and related
 * tokens for use on the confirmation page, where not already provided by
 * webform.
 */


/**
 * Implements hook_menu_alter
 * Webform 4's access is too strict for anon submissions, so we need to override
 * This will allow us to pull the access checking code out of the preprocess function below
 * where it lived for webform 3
 */
function webform_confirmations_menu_alter(&$items) {
  $items['node/%webform_menu/done']['access callback'] = 'webform_confirmations_confirmation_page_access';
}

/**
 * Menu Access callbock for confirmation pages
 * Taken from webform module
 */

function webform_confirmations_confirmation_page_access($node) {
  global $user;

  // Make sure SID is a positive integer.
  $sid = (!empty($_GET['sid']) && (int) $_GET['sid'] > 0) ? (int) $_GET['sid'] : NULL;

  if ($sid) {
    module_load_include('inc', 'webform', 'includes/webform.submissions');
    $submission = webform_get_submission($node->nid, $sid);
  }
  else {
    $submission = NULL;
  }

  if ($submission) {
    // Logged-in users.
    if ($user->uid) {
      // User's own submission.
      if ($submission->uid === $user->uid && node_access('view', $node)) {
        return TRUE;
      }
      // User has results access to this submission.
      elseif (webform_submission_access($node, $submission)) {
        return TRUE;
      }
    }

    // Anonymous user for their own submission. Hash of submission data must
    // match the hash in the query string.

    //Springboard alteration is here:
    elseif (((int) $user->uid === 0 && (int) $submission->uid === 0) || ((int) $user->uid === 0 && $user->hostname == $submission->remote_addr)) {
      $hash_query = !empty($_GET['token']) ? $_GET['token'] : NULL;
      $hash = md5($submission->submitted . $submission->sid . drupal_get_private_key());
      $sub = $submission->submitted;
      $now = time();
      //expire the page after 10 minutes for anonymous
      $elapsed = $now - $sub;
      if ($hash_query === $hash && $elapsed < 600) {
        return TRUE;
      }
    }
  }

  return FALSE;
}

/**
 * Implements hook_preprocess_webform_confirmation().
 * Overrides the template during preprocess to insert correct token values on display.
 * Replace any webform component tokens before displaying confirmation page.
 */
function webform_confirmations_preprocess_webform_confirmation(&$vars) {
  if (isset($vars['node']->nid) && _webform_confirmations_is_configured($vars['node'])) {
    // Reprocess the message. Webform properly uses a strip_tag here that will kill all HTML.
    // So for our purposes, we need to reprocess the set message to get the correct values.
    $vars['confirmation_message'] = check_markup($vars['node']->webform['confirmation'], $vars['node']->webform['confirmation_format'], '', TRUE);
    // We get check_markup() from filter.module.
    // Set title if available from configurations.
    if (!empty($vars['node']->confirmation_page_title)) {
      drupal_set_title($vars['node']->confirmation_page_title);
    }
    // Replace webform tokens for the submission.
    module_load_include('inc', 'webform', 'includes/webform.submissions');
    $submission = webform_get_submission($vars['node']->nid, $vars['sid']);
    // Replace drupal tokens for the submission.
    $token_set = array('node' => node_load($vars['node']->nid));
    if ($submission) {
      $token_set['webform-submission'] = $submission;
    }
    drupal_alter('webform_confirmations_token_replace', $token_set, $vars['sid']);
    $vars['confirmation_message'] = token_replace($vars['confirmation_message'], $token_set, array('clear' => true, 'sanitize' => TRUE));
  }
}


/**
 * Implements hook_form_FORM_ID_alter().
 *
 *  Conditionally add send on order success checkbox to webform email configuration forms.
 */
function webform_confirmations_form_webform_email_edit_form_alter(&$form, $form_state, $form_id) {
  if (module_exists('email_wrappers') && fundraiser_is_donation_type($form['#node']->type)) {

    $node = $form['#node'];
    $send_default = _webform_confirmation_send_on_settings($form_state);
    $send_options = array(
      0 => t('Always'),
      1 => t('Donation succeeds'),
      2 => t('Donation fails'),
    );
    // TODO: correctly set default on this form element based on prior settings.
    $form['send_on_settings'] = array(
      '#type' => 'radios',
      '#title' => t('Send when'),
      '#description' => t('Only send a copy of this email if the selected condition is met.'),
      '#options' => $send_options,
      '#default_value' => $send_default,
      '#weight' => -49,
    );
    $form['template']['tokens'] = array(
      '#type' => 'fieldset',
      '#title' => t('Available tokens'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#weight' => 9,
    );
    $token_set = array('node');
    // Then add any other token set as needed.
    drupal_alter('webform_confirmations_token_info', $token_set, $node);
    $form['template']['tokens']['tokens'] = array(
      '#type' => 'item',
      '#title' => t('Drupal tokens'),
      '#description' => theme('token_tree', array('token_types' => $token_set, 'recursion_limit' => 2, 'click_insert' => FALSE)),
    );
    $form['template']['tokens']['webform_tokens'] = array(
      '#type' => 'item',
      '#title' => t('Webform tokens'),
      '#description' => theme('webform_token_help', array()),
    );
    $form['#validate'][] = '_webform_confirmations_email_edit_validate';
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function webform_confirmations_form_webform_configure_form_alter(&$form, &$form_state, $form_id) {
  // On webform configuration forms, provide override for the Page title and notice re: token support.
  $node = node_load($form['nid']['#value']);
  // Webform tokens for use in the custom URL redirect are implemented
  // in webform/includes/webform.pages.inc:
  // Tokens for the page text - are NOT implemented in normal webform.
  // So we also need to tweak the token display message to say we'll support it.
  $form['submission']['confirmation']['confirmation_page_title'] = array(
    '#type' => 'textfield',
    '#title' => t('Page title'),
    '#weight' => 0,
    '#default_value' => isset($node->confirmation_page_title) ? $node->confirmation_page_title : '',
  );
  $form['submission']['help'] = array(
    '#type' => 'fieldset',
    '#title' => t('Available tokens'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );
  $token_set = array('node');
  // Then add any other token set as needed. (Here is where donation, donation user etc get put in.)
  drupal_alter('webform_confirmations_token_info', $token_set, $node);
  $form['submission']['help']['tokens'] = array(
    '#type' => 'item',
    '#title' => t('Drupal tokens'),
    '#description' => theme('token_tree', array('token_types' => $token_set, 'recursion_limit' => 2, 'click_insert' => FALSE)),
  );
  $webform_token_help = theme('webform_token_help', array());
  $webform_token_help = str_replace('%post', '%value', $webform_token_help);
  $webform_token_help = str_replace('POST ', '', $webform_token_help);
  $form['submission']['help']['webform_tokens'] = array(
    '#type' => 'item',
    '#title' => t('Webform tokens'),
    '#description' => $webform_token_help,
  );
  // Tweak display messages.
  $form['submission']['confirmation']['#description'] .= ' ' . t('The message supports Drupal tokens and Webform token replacements. ' .
    '(See tokens below).');
  $form['submission']['redirection']['#description'] = t('Choose where to redirect the user upon successful submission. The Custom URL ' .
    'option supports Webform token replacements. (See tokens below).');
  // Shuffle things to display later in the form, there may be a better way to reorg the array. Check later.
  $total_submit_limit = $form['submission']['total_submit_limit'];
  $submit_limit = $form['submission']['submit_limit'];
  $status = $form['submission']['status'];
  unset($form['submission']['total_submit_limit']);
  unset($form['submission']['submit_limit']);
  unset($form['submission']['status']);
  $form['submission']['total_submit_limit'] = $total_submit_limit;
  $form['submission']['submit_limit'] = $submit_limit;
  $form['submission']['status'] = $status;
  // Add submit.
  $form['#submit'][] = '_webform_confirmations_submit';
}

/**
 * Submit handler for webform configuration form.
 */
function _webform_confirmations_submit($form, &$form_state) {
  $confirmation['nid'] = $form_state['values']['nid'];
  $confirmation['confirmation_page_title'] = check_plain($form_state['values']['confirmation']['confirmation_page_title']);
  _webform_confirmations_update($confirmation);
}

/**
 * Implements hook_fundraiser_donation_success().
 *
 * Send templated confirmation emails when a donation is successful.
 */
function webform_confirmations_fundraiser_donation_success($donation) {
  if (module_exists('email_wrappers')) {
    $settings = email_wrappers_load_settings($donation->nid, NULL);

    if ($settings) {
      foreach ($settings as $mail_config) {

        if (isset($mail_config['extra']['send_on_donation_success']) && $mail_config['extra']['send_on_donation_success'] === TRUE) {
          _webform_confirmation_send_confirmation_mail($mail_config, $donation);
        }
      }
    }
  }
}


/**
 * Implements hook_fundraiser_donation_decline().
 *
 * If
 */
function webform_confirmations_fundraiser_donation_decline($donation) {
  if (module_exists('email_wrappers')) {
    $settings = email_wrappers_load_settings($donation->nid, NULL);
    if ($settings) {
      foreach ($settings as $mail_config) {
        if (isset($mail_config['extra']['send_on_donation_decline']) && $mail_config['extra']['send_on_donation_decline'] === TRUE) {
          _webform_confirmation_send_confirmation_mail($mail_config, $donation);
        }
      }
    }
  }
}

/**
 * Implements hook_node_load().
 */
function webform_confirmations_node_load($nodes, $types) {
  $webform_confirmations = _webform_confirmations_get_by_nids(array_keys($nodes));
  foreach ($webform_confirmations as $webform_confirmation) {
    $nodes[$webform_confirmation->nid]->webform_confirmations_set = 1;
    $nodes[$webform_confirmation->nid]->confirmation_page_title =
      isset($webform_confirmation->confirmation_page_title) ? $webform_confirmation->confirmation_page_title : '';
  }
}


/**
 * Implements hook_node_insert().
 */
function webform_confirmations_node_insert($node) {
  // Set confirmation page title from the original. Not saved as part of node, cause it's not a node table.
  if (isset($node->clone_from_original_nid)) {
    $confirmation = (array) _webform_confirmations_get_by_nid($node->clone_from_original_nid);
    if (isset($confirmation['nid'])) {
      $confirmation['nid'] = $node->nid;
      _webform_confirmations_update($confirmation);
    }
  }
}

/**
 * Helper function, check if node is configured for confirmations.
 */
function _webform_confirmations_is_configured($node) {
  return isset($node->webform_confirmations_set) ? $node->webform_confirmations_set : FALSE;
}

/**
 * DB Functions.
 */

/**
 * CRUD style DB function for webform_confirmations.
 */
function _webform_confirmations_create($confirmation) {
  // Cast confirmation data just in case.
  $confirmation = (array) $confirmation;
  // Check for old data.
  $confirmation_data = FALSE;
  if (isset($confirmation['nid'])) {
    $confirmation_data = _webform_confirmations_get_by_nid($confirmation['nid']);
  }
  if (!$confirmation_data) {
    $record = $confirmation;
    drupal_write_record('webform_confirmations', $record);
  }
  else {
    _webform_confirmations_update($confirmation);
  }
}

/**
 * CRUD style DB function for webform_confirmations.
 */
function _webform_confirmations_get_by_nid($nid) {
  return db_query('SELECT * FROM {webform_confirmations} WHERE nid = :nid',
    array(':nid' => $nid))->fetchObject();
}

/**
 * CRUD style DB function for webform_confirmations.
 */
function _webform_confirmations_update($confirmation) {
  // Cast confirmation just in case.
  $confirmation = (array) $confirmation;
  // Check for old data.
  $confirmation_data = FALSE;
  if (isset($confirmation['nid'])) {
    $confirmation_data = _webform_confirmations_get_by_nid($confirmation['nid']);
  }
  if (!$confirmation_data) {
    _webform_confirmations_create($confirmation);
  }
  else {
    $record = array_merge((array) $confirmation_data, $confirmation);
    drupal_write_record('webform_confirmations', $record, 'nid');
  }
}

/**
 * CRUD style DB function for webform_confirmations.
 */
function _webform_confirmations_delete($nid) {
  db_delete('webform_confirmations')->condition('nid', $nid)->execute();
}

/**
 * DB function for webform_confirmations.
 */
function _webform_confirmations_get_by_nids($nids) {
  return db_query('SELECT * FROM {webform_confirmations} WHERE nid IN (:nids)',
    array(':nids' => $nids));
}

/**
 * Additional validation for webform email forms, required for conditional integration with Email Wrappers.
 */
function _webform_confirmations_email_edit_validate($form, &$form_state) {

  switch ($form_state['values']['send_on_settings']) {
    case 0:
      $form_state['extra']['send_on_donation_success'] = FALSE;
      $form_state['extra']['send_on_donation_decline'] = FALSE;
      $form_state['extra']['send_on_submission'] = TRUE;
      break;
    case 1:
      $form_state['extra']['send_on_donation_success'] = TRUE;
      $form_state['extra']['send_on_donation_decline'] = FALSE;
      $form_state['extra']['send_on_submission'] = FALSE;
      break;

    case 2:
      $form_state['extra']['send_on_donation_success'] = FALSE;
      $form_state['extra']['send_on_donation_decline'] = TRUE;
      $form_state['extra']['send_on_submission'] = FALSE;
      break;
  }
}

/**
 * Retrieve send on defaults from saved settings.
 */
function _webform_confirmation_send_on_settings($form_state) {
  $default = 1;

  if (isset($form_state['build_info']['args'][1]['eid'])) {
    $nid = $form_state['build_info']['args'][1]['nid'];
    $eid = $form_state['build_info']['args'][1]['eid'];
    $settings = email_wrappers_load_settings($nid, $eid);
    $extra = $settings['extra'];
    if (isset($extra['send_on_submission']) && $extra['send_on_submission']) {
      $default = 0;
    }
    elseif (isset($extra['send_on_donation_success']) && $extra['send_on_donation_success']) {
      $default = 1;
    }
    elseif (isset($extra['send_on_donation_decline']) && $extra['send_on_donation_decline']) {
      $default = 2;
    }
  }

  return $default;
}

/**
 * Send confirmation mail.
 *
 * @param $settings
 * Email Wrappers settings array.
 *
 * @param $donation
 * Fundraiser donation object.
 */
function _webform_confirmation_send_confirmation_mail($settings, $donation) {
  $nid = $settings['nid'];
  $eid = $settings['eid'];
  $account = $donation->user;

  // Pull the deferred mail queue in and see if we have any pending mails to send.
  $mail_queue = &drupal_static('email_wrappers_mail_queue');

  if (isset($mail_queue[$nid][$eid])) {
    $params = $mail_queue[$nid][$eid]['params'];
    $message = $params['message'];

    // Email Wrappers handles webform token replacement so all we need to do is pick off order tokens.
    $token_set = array(
      'node' => node_load($nid),
      'donation' => $donation,
    );
    $params['settings']['html_message'] = token_replace($params['settings']['html_message'], $token_set);
    $params['settings']['text_message'] = token_replace($params['settings']['text_message'], $token_set);

    drupal_mail('email_wrappers', 'wf_submission', $message['to'], user_preferred_language($account), $params);
    unset($mail_queue[$nid][$eid]);
  }
}
