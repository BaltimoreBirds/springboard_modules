<?php

/**
 * @file
 * Provide options for form layouts in donation forms.
 */

/**
 * Implements hook_permission().
 */
function form_layout_permission() {
  return array(
    'administer form layouts' => array(
      'title' => t('Administer Form layouts'),
      'description' => t('Configure default form layouts for donation forms.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function form_layout_menu() {
  $items = array();

  $base_path = form_layout_menu_base_path();
  $arg = form_layout_menu_base_path_arg_position();

  $items[$base_path] = array(
    'title' => 'Form layouts',
    'page callback' => 'form_layout_list',
    'access arguments' => array('administer form layouts'),
    'file' => 'form_layout.pages.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 100,
  );

  $items[$base_path . '/add'] = array(
    'title' => 'Add form layout',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('form_layout_add'),
    'access arguments' => array('administer form layouts'),
    'file' => 'form_layout.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items[$base_path . '/%form_layout/edit'] = array(
    'title' => 'Edit form layout',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('form_layout_edit', $arg),
    'access arguments' => array('administer form layouts'),
    'file' => 'form_layout.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items[$base_path . '/%form_layout/delete'] = array(
    'title' => 'Delete form layout',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('form_layout_delete_confirm', $arg),
    'access arguments' => array('administer form layouts'),
    'file' => 'form_layout.pages.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * A base path for which to provide menu items.
 *
 * @return string
 *   The path to form_layout including the module name excluding the last slash.
 */
function form_layout_menu_base_path() {
  return 'admin/config/system/fundraiser/form_layout';
}

/**
 * The arg() position where the form layout machine name will be.
 *
 * This is for the edit and delete operations.
 * If we change the base path also change this.
 *
 * @return int
 *   The posiiton of the form layout wildcard.
 */
function form_layout_menu_base_path_arg_position() {
  return 5;
}

/**
 * Load a single form layout or all form layouts.
 *
 * @param string|null $name
 *   The machine name.  Leave NULL to get all layouts.
 *
 * @return array|boolean
 *   Single layout array, or all layouts, or FALSE
 */
function form_layout_load($name = NULL) {
  $layouts = variable_get('form_layout', array());
  if (is_null($name)) {
    return $layouts;
  }
  elseif (isset($layouts[$name])) {
    return $layouts[$name];
  }

  return FALSE;
}

/**
 * Save a form layout.
 *
 * If the machine name already exists it will be overwritten.
 *
 * @param string $machine_name
 *   The identifier string for the form layout.
 *
 * @param array $layout
 *   The layout array with name and layout definition.
 */
function form_layout_save($machine_name, $layout) {
  $layouts = form_layout_load();
  $layouts[$machine_name] = $layout;

  variable_set('form_layout', $layouts);
}

/**
 * Delete a form layout.
 *
 * @param string $machine_name
 *   Identifier string for the form layout.
 */
function form_layout_delete($machine_name) {
  $layouts = form_layout_load();
  unset($layouts[$machine_name]);

  variable_set('form_layout', $layouts);
}

/**
 * Implements hook_fundraiser_field_info().
 *
 * Provides the additional regions fields.
 */
function form_layout_fundraiser_field_info() {
  $fields = array();

  $fields['top_region'] = array(
    '#title' => t('Top region'),
    '#type' => 'fieldset',
    '#required' => 0,
    '#display_callback' => 'form_layout_top_region_display',
  );

  $fields['left_region'] = array(
    '#title' => t('Left region'),
    '#type' => 'fieldset',
    '#required' => 0,
    '#display_callback' => 'form_layout_left_region_display',
  );

  $fields['right_region'] = array(
    '#title' => t('Right region'),
    '#type' => 'fieldset',
    '#required' => 0,
    '#display_callback' => 'form_layout_right_region_display',
  );

  $fields['bottom_region'] = array(
    '#title' => t('Bottom region'),
    '#type' => 'fieldset',
    '#required' => 0,
    '#display_callback' => 'form_layout_bottom_region_display',
  );

  return $fields;
}

/**
 * Implements hook_fundraiser_field_info_alter().
 *
 * When the fields are being created, use the layout to rearrange the fieldsets.
 *
 * The layout selected is stored in a session here because I can't figure out
 * another way to get at it from the node_form when the node is being created.
 * @todo Is there a better way to get this value here?
 */
function form_layout_fundraiser_field_info_alter(&$info) {
  if (isset($_SESSION['form_layout']) && $_SESSION['form_layout'] != 'none') {

    $layout = form_layout_load($_SESSION['form_layout']);

    foreach ($layout['layout'] as $region => $content) {
      foreach ($content as $fieldset) {
        // Place the fieldset into the correct region.
        $info[$region][$fieldset] = $info[$fieldset];
        // Remove the original fieldset.
        unset($info[$fieldset]);
      }
    }
  }

  // Remove the session var.
  unset($_SESSION['form_layouts']);
}

/**
 * Implements hook_theme().
 *
 */
function form_layout_theme() {
  return array(
    'form_layout_region' => array(
      'render element' => 'element',
    ),
  );
}

/**
 * Theme wrapper for regions.
 *
 * Replaces region fieldset tags with divs.
 */
function theme_form_layout_region($variables) {
  $element = $variables['element'];

  element_set_attributes($element, array('id'));

  $output = '<div' . drupal_attributes($element['#attributes']) . '>';
  if (!empty($element['#title'])) {
    $output .= '<div class="div-title">' . $element['#title'] . '</div>';
  }
  if (!empty($element['#description'])) {
    $output .= '<div class="div-description">' . $element['#description'] . '</div>';
  }
  $output .= $element['#children'];
  if (isset($element['#value'])) {
    $output .= $element['#value'];
  }
  $output .= "</div>\n";
  return $output;
}

/**
 * Display callback for the top region.
 *
 * Does some bootstrap formatting and removes the title.
 *
 * @return array
 *   The modified field array.
 */
function form_layout_top_region_display($form, $form_state, $field) {
  // Note that we're intentionally removing other classes here.
  $field['#attributes']['class'] = array('span12');
  $field['#title'] = '';
  $field['#prefix'] = '<div class="row">';
  $field['#suffix'] = '</div>';
  $field['#weight'] = -50;
  $field['#theme_wrappers'][] = 'form_layout_region';
  return $field;
}

/**
 * Display callback for the left region.
 *
 * Does bootstrap formatting and removes the title.
 *
 * @return array
 *   The modified field array.
 */
function form_layout_left_region_display($form, $form_state, $field) {
  // Note that we're intentionally removing other classes here.
  $field['#attributes']['class'] = array('span6');
  $field['#title'] = '';

  // This div gets closed after the right region.
  $field['#prefix'] = '<div class="row">';

  $field['#weight'] = -49;

  $field['#theme_wrappers'][] = 'form_layout_region';
  return $field;
}

/**
 * Display callback for the right region.
 *
 * Does bootstrap formatting and removes the title.
 *
 * @return array
 *   The modified field array.
 */
function form_layout_right_region_display($form, $form_state, $field) {
  // Note that we're intentionally removing other classes here.
  $field['#attributes']['class'] = array('span6');
  $field['#title'] = '';

  // This div was opened before the left region.
  $field['#suffix'] = '</div>';

  $field['#weight'] = -48;

  $field['#theme_wrappers'][] = 'form_layout_region';
  return $field;
}

/**
 * Display callback for the bottom region.
 *
 * Does bootstrap formatting and removes the title.
 *
 * @return array
 *   The modified field array.
 */
function form_layout_bottom_region_display($form, $form_state, $field) {
  // Note that we're intentionally removing other classes here.
  $field['#attributes']['class'] = array('span12');
  $field['#title'] = '';
  $field['#prefix'] = '<div class="row">';
  $field['#suffix'] = '</div>';
  $field['#weight'] = -47;

  $field['#theme_wrappers'][] = 'form_layout_region';
  return $field;
}

/**
 * Implements hook_form_BASE_FORM_ID_alter() for node_form().
 *
 * Adds a fieldset and select list to choose layout options
 * on donation forms.
 */
function form_layout_form_node_form_alter(&$form, &$form_state, $form_id) {
  if (fundraiser_is_donation_type($form['#node']->type)) {
    $form['form_layout'] = array(
      '#type' => 'fieldset',
      '#title' => t('Form Layout'),
      '#description' => t('Select the form layout for this form.'),
      '#collapsible' => TRUE,
      '#collapsed' => FALSE,
    );

    $options = form_layout_get_layout_options();
    $default_value = 'none';

    if (!empty($form['#node']->form_layout) && in_array($form['#node']->form_layout, array_keys($options))) {
      $default_value = $form['#node']->form_layout;
    }

    $form['form_layout']['form_layout'] = array(
      '#type' => 'select',
      '#title' => t('Layout'),
      '#options' => $options,
      '#default_value' => $default_value,
      '#description' => 'Choose a layout for the form.',
    );
  }
  $form['#submit'][] = 'form_layout_node_form_submit';
}

/**
 * Provides machine name and layout name for select form elements.
 *
 * @return array
 *   array(machine_name => layout name, ...)
 */
function form_layout_get_layout_options() {
  $options = array();
  $options['none'] = t('None/No Change');
  $layouts = form_layout_load();

  foreach ($layouts as $id => $layout) {
    $options[$id] = $layout['name'];
  }

  return $options;
}

/**
 * Provides an array with region name and pretty values.
 *
 * @return array
 *   array(region form key => region name, ...)
 */
function form_layout_get_region_options() {
  return array(
    'top_region' => 'Top',
    'left_region' => 'Left',
    'right_region' => 'Right',
    'bottom_region' => 'Bottom',
  );
}

/**
 * Submit handler for the node form.
 *
 * If this is a new node, set a session var to change the layout
 * in form_layouts_fundraiser_field_info_alter().
 * We do this because we don't have fields attached
 * until the node has been saved.
 *
 * Unfortunately we can't do the same thing for editing an existing node.
 * So we'll just change things now by directly modifying the webform components
 * in $form_state['values'],
 * It will all get saved later on as part of being an entity.
 */
function form_layout_node_form_submit($form, &$form_state) {
  $layout_name = $form_state['values']['form_layout'];
  if ($layout_name == 'none') {
    // Don't make a change.
    return;
  }

  if (is_null($form_state['values']['nid'])) {
    // New node, so rearrange fieldsets later.
    $_SESSION['form_layout'] = $layout_name;
  }
  else {
    // Existing node, so rearrange fieldsets now.
    form_layout_update_layout($form_state['values']['webform']['components'], $layout_name);
  }
}

/**
 * Rearrange webform components to match the layout selected.
 *
 * @param array &$components
 *   Webform components, as in $node->webform['components']
 *
 * @param string $layout_name
 *   Machine name of the form layout.
 */
function form_layout_update_layout(&$components, $layout_name) {
  $cids = form_layout_key_cids_by_form_key($components);

  $layout = form_layout_load($layout_name);

  foreach ($layout['layout'] as $region => $content) {
    foreach ($content as $fieldset) {
      $cid = $cids[$fieldset];
      $components[$cid]['pid'] = $cids[$region];
    }
  }
}

/**
 * Takes webform components keyed by cid and keys them by form_key.
 *
 * @param array $components
 *   As given in $node->webform['components']
 *
 * @return array
 *   array(form_key => cid, ...)
 */
function form_layout_key_cids_by_form_key($components) {
  $return = array();
  foreach ($components as $cid => $component) {
    $return[$component['form_key']] = $cid;
  }
  return $return;
}

/**
 * Implements hook_node_insert().
 *
 * Save the form layout.
 */
function form_layout_node_insert($node) {
  form_layout_node_update($node);
}

/**
 * Implements hook_node_load().
 */
function form_layout_node_load($nodes, $types) {
  foreach ($nodes as $node) {
    if (fundraiser_is_donation_type($node->type)) {
      $nodes[$node->nid]->form_layout = form_layout_get_node_layout($node->nid);
    }
  }
}

/**
 * Implements hook_node_update().
 */
function form_layout_node_update($node) {
  if (fundraiser_is_donation_type($node->type) && !empty($node->form_layout)) {
    form_layout_save_node_layout($node->nid, $node->form_layout);
  }
}

/**
 * Implements hook_node_delete().
 */
function form_layout_node_delete($node) {
  if (fundraiser_is_donation_type($node->type)) {
    form_layout_delete_node_layout($node->nid);
  }
}

/**
 * Saves the layout machine name to the DB
 *
 * @param integer $nid
 *   Node ID.
 * @param string $layout
 *   Layout machine name.
 *
 * @return bool|int
 *   FALSE on failure, SAVED_NEW or SAVED_UPDATED on success.
 */
function form_layout_save_node_layout($nid, $layout) {
  $record = array(
    'nid' => $nid,
    'form_layout' => $layout,
  );

  $node_layout = form_layout_get_node_layout($nid);

  if ($node_layout == '') {
    // new record
    return drupal_write_record('form_layout_node', $record);
  }
  else {
    // update record
    return drupal_write_record('form_layout_node', $record, 'nid');
  }
}

/**
 * Deletes a form layout record for the given node.
 *
 * @param $nid
 *   Node ID.
 *
 * @return DatabaseStatementInterface
 */
function form_layout_delete_node_layout($nid) {
  return db_delete('form_layout_node')
    ->condition('nid', $nid)
    ->execute();
}

/**
 * Gets the layout machine name for a node.
 *
 * @param integer $nid
 *   Node ID.
 *
 * @return string
 *   Layout machine name.
 */
function form_layout_get_node_layout($nid) {
  $result = db_query("SELECT form_layout FROM {form_layout_node} WHERE nid = :nid",
    array(':nid' => $nid)
  );

  if ($result->rowCount() > 0) {
    return $result->fetchField();
  }

  // Default value.
  return '';
}
