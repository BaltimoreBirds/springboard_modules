<?php

/**
 * @file
 * Module file for Social Actions module.
 */

/**
 * Implements hook_node_info().
 */
function sba_social_action_node_info() {
  return array(
    'sba_social_action' => array(
      'name' => t('Springboard Social Action'),
      'base' => 'sba_social_action',
      'description' => t('Social Action conten type'),
      'title_label' => t('Social Action'),
      'locked' => TRUE,
    ),
  );
}

/**
 * Implements hook_form().
 */
function sba_social_action_form($node, $form_state) {
  return node_content_form($node, $form_state);
}

/**
 * Implements hook_preprocess_node().
 *
 * Define theme wrappers for non-form-layouts nodes.
 * So they can have a "layout".
 *
 * Insert webform goals widget.
 */
function sba_social_action_preprocess_node(&$vars) {

  if ($vars['node']->type == 'sba_social_action') {
    // Add theme wrappers for non-form-layout layouts.
    $vars['use_layouts'] = !empty($vars['form_layouts']) ? TRUE : FALSE;
    if (empty($vars['use_layouts'])) {
//      $vars['content']['webform']['#theme_wrappers'][] = 'message_action_webform_wrapper';
//      $vars['content']['webform']['#form']['submitted']['#theme_wrappers'][] = 'message_action_submitted_wrapper';
//      $vars['content']['webform']['#form']['sba_messages']['#theme_wrappers'][] = 'message_action_messages_wrapper';

      $vars['participants'] = '';
      $view = views_get_view('recent_action_participants');
      $view->set_display('block_1');
      $view->set_arguments(array(arg(1)));
      $view->pre_execute();
      $view->execute();
      if (isset($view->result) && count($view->result)) {
        $table = $view->preview('block_1');
        $vars['participants'] = $table;
      }

      // Insert webform goals.
      if (module_exists('webform_goals')) {
        $goals = webform_goal_load_multiple($vars['node']->nid);
        // Get the most recently enabled goal.
        $goal = array_pop($goals);
        if (!empty($goal)) {
          $vars['goal'] = '<div class="wg-goal" style="display: none;" data-gid="' . $goal['gid'] . '"></div>';
        }
      }
    }
  }
}

