<?php
/**
 * @file
 * Provides content type and config for message actions.
 */

/**
 * Implements hook_node_insert
 * 
 * Adds some custom fields to new webforms.
 */
function sba_message_action_node_insert($node) {
  if($node->type == 'sba_message_action') {
    module_load_include('inc', 'webform', 'includes/webform.components');

    //add custom fields for the messages
    $fields[] = array(
      'nid' => $node->nid,
      'form_key' => 'sba_phone',
      'pid' => 0,
      'name' => t('Phone Number'),
      'type' => 'textfield',
      'mandatory' => 1,
      'weight' => 13,
      'email' => 1,
      'extra' => array(
      'description' => t(''),
      ),
    );

    //limit the state field to US states
    $fields[] = array(
        'nid' => $node->nid,
        'form_key' => 'sbp_state',
        'pid' => 0,
        'name' => t('State'),
        'type' => 'select',
        'mandatory' => 1,
        'weight' => 12,
        'email' => 1,
        'extra' => array(
        'options_source' => 'united_states', //may have to remove some.
        'aslist' => 'Y',
        'multiple' => 0,
      ),
    );
    $fields[] = array(
        'nid' => $node->nid,
        'form_key' => 'sbp_zip',
        'pid' => 0,
        'name' => t('Zip Code'),
        'type' => 'textfield',
        'mandatory' => 1,
        'weight' => 13,
        'email' => 1,
        'extra' => array(
        'maxlength' => 5,
      ),
    );

    // Add the component to the Webform.

    foreach ($fields as $field) {
      $cid = webform_component_insert($field);
      //user map the state field
      if ($field['form_key'] == 'sbp_state' || $field['form_key'] == 'sbp_zip') {
            $map = array(
            'nid' => $node->nid,
            'cid' => $cid,
            'map_id' => $field['form_key'],
          );
          drupal_write_record('webform_user_component_map', $map);
      }
    }
  }
}

/**
 * Implements hook_webform_user_profile_fields_alter
 *
 */
function sba_message_action_webform_user_profile_fields_alter(&$fields, $node) {
  if($node->type == 'sba_message_action') {
    foreach ($fields as $index => $profile_field) {
      //make all fields except address2 mandatory
      if ($profile_field['name'] != 'sbp_address_line_2'){
        $fields[$index]['mandatory'] = 1;
      }
      //setup removal of non-US provinces
      if ($profile_field['name'] == 'sbp_state'){
        unset($fields[$index]);
      }
      //remove zip
      if ($profile_field['name'] == 'sbp_zip'){
        unset($fields[$index]);
      }
      //move email field lower
      if ($profile_field['name'] == 'mail'){
        $fields[$index]['weight'] = 14;
      }
    } 
  }
}

/**
 * Implements hook_form_layouts_info().
 */
function sba_message_action_form_layouts_info() {
  $templates = array();

  $templates['two_column_message_right'] = array(
    'name' => t('Two column: message right, CTA & Image top.'),
    'types' => array('sba_message_action'),
    'theme' => 'two_column_message_right',
    'pattern' => 'two_column_message_right\'0-9\'+',
    'template' => 'two-column-message-right',
    'path' => drupal_get_path('module', 'sba_message_action') . '/templates/form_layouts',
    'hide title' => FALSE,
  );

  return $templates;
}

function sba_message_action_preprocess_two_column_message_right(&$vars) {
  $vars['message_call_to_action'] = drupal_render($vars['element']['body']);
  $vars['message_image'] = drupal_render($vars['element']['field_message_action_img']);
  $vars['message_fieldset'] = drupal_render($vars['element']['submitted']['message_fieldset']);
  $vars['form'] = $vars['element'];
}


