<?php
/**
 * @file
 * Drupal needs this blank file.
 */

/**
 * Implements hook_menu().
 */
function springboard_advocacy_menu() {
  $items['admin/config/springboard/advocacy'] = array(
    'title' => 'Springboard Advocacy Settings',
    'description' => 'Configuration settings for Springboard advocacy features.',
    'page callback' => 'springboard_advocacy_settings_page',
    'access arguments' => array('administer springboard advocacy'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/springboard_advocacy.admin.inc',
  );

  $items['admin/config/springboard/advocacy/index'] = array(
    'title' => 'Springboard Advocacy',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );

  $items['admin/springboard/advocacy/alerts'] = array(
    'title' => 'Advocacy',
    'page arguments' => array('alerts'),
  ) + springboard_advocacy_menu_common();

  $items['admin/springboard/advocacy/alerts/all'] = array(
    'title' => 'Advocacy',
    'page arguments' => array('alerts/all'),
  ) + springboard_advocacy_menu_common();

   $items['admin/springboard/advocacy/custom-targets'] = array(
    'title' => 'Advocacy',
    'page arguments' => array('custom-targets'),
  ) + springboard_advocacy_menu_common();

  return $items;
}

/**
 * Defines common values for advocacy menu items.
 * Including a themed page callback for advocacy admin views.
 */
function springboard_advocacy_menu_common() {
  return array(
    'page callback' => 'springboard_advocacy_dashboard',
    'file' => 'springboard_advocacy.admin.inc',
    'file path' => drupal_get_path('module', 'springboard_advocacy') . '/includes',
    'access arguments' => array('administer springboard advocacy'),
    'type' => MENU_NORMAL_ITEM
    );
}

/**
 * Implements hook_permission().
 */
function springboard_advocacy_permission() {
  return array(
    'administer springboard advocacy' => array(
      'title' => t('Administer Springboard advocacy'),
      'description' => t('Perform administration tasks for Springboard advocacy.'),
    ),
  );
}

/**
 * Implements hook_libraries_info().
 *
 * Define the advocacy php sdk
 */
function springboard_advocacy_libraries_info() {
  $libraries['springboard_advocacy'] = array(
    'name' => 'Springboard Advocacy',
    'vendor url' => 'https://github.com/JacksonRiver/springboard-sdk-php',
    'download url' => 'https://github.com/JacksonRiver/springboard-sdk-php',
    'version callback' => 'springboard_advocacy_library_version',
    'path' => 'advocacy',
    'files' => array(
      'php' => array(
        'SpringboardAdvocacyAPIClient.php',
      ),
    ),
  );
  return $libraries;
}

/**
 * Version callback for hook_libraries_info().
 */
function springboard_advocacy_library_version($library) {
  return '1';
}

/**
* Implements hook_views_api().
*/
function springboard_advocacy_views_api() {
  return array(
    'api' => 3.0,
  );
}


/**
 * Implements hook_node_insert
 *
 * Saves a UUID for alert nodes.
 *
 * @param $node
 */
function springboard_advocacy_node_insert($node) {
  $types = variable_get('springboard_advocacy_alert_types', array());
  if(in_array($node->type, $types)) {
    $uuid = array(
      'nid' => $node->nid,
      'advocacy_id' => uniqid(variable_get('site_name', 'Drupal') . '-'),
    );
    drupal_write_record('springboard_advocacy_alert_id', $uuid);
  }
}

/**
  *
  * Implements hook_node_load
  *
  * @param $nodes
  *   An array of the nodes being loaded, keyed by nid.
  * @param $types
  *   An array containing the node types present in $nodes.
  *
  * Add the unique form_id and message entity references to alert nodes.
  *
  */
function springboard_advocacy_node_load($nodes, $types) {
  $alert_types = variable_get('springboard_advocacy_alert_types', array());

  if (count(array_intersect($alert_types, $types))) {
    $uuids = db_query(
      'SELECT advocacy_id, nid FROM {springboard_advocacy_alert_id} WHERE nid IN (:nids)', 
       array(':nids' => array_keys($nodes))
     );
    foreach ($uuids as $uuid) {
      $nodes[$uuid->nid]->advocacy_id = $uuid->advocacy_id;
    }

    $message_ids = db_query(
      'SELECT entity_id, field_sba_alert_id_target_id FROM {field_data_field_sba_alert_id} WHERE field_sba_alert_id_target_id IN (:nids)',
      array(':nids' => array_keys($nodes)));
    foreach ($message_ids as $message_id) {
      $nodes[$message_id->field_sba_alert_id_target_id]->message_ids[] = $message_id->entity_id;
    }
  }
}

/**
 * Implements hook_form_alter
 * @param $form
 * @param $form_state
 * @param $form_id
 *
 * Add alert UUIDs and Message IDs to hidden fields on the alert form.
 * Define a custom submit handler for alert node types.
 */
function springboard_advocacy_form_alter(&$form, &$form_state, $form_id) {
  module_load_include('inc', 'springboard_advocacy', 'includes/springboard_advocacy.webform');

  $types = variable_get('springboard_advocacy_alert_types', array());

  if (isset($form['#node']) && in_array($form['#node']->type, $types)) {
    //springboard_advocacy_form_vertical_nav($form);
    $node = $form['#node'];

    if (isset($form['form_id'])) {

      $pos = strpos($form['form_id']['#value'], 'webform_client_form');

      if (!empty($node->message_ids) && $pos !== FALSE) {
        $form['messages']['#tree'] = TRUE;
        foreach ($node->message_ids as $id) {
          $form['messages'][$id] = array(
            '#type' => 'hidden',
            '#value' => $id,
          );
        }
      }

      if (!empty($node->advocacy_id) && $pos !== FALSE) {
        $form['advocacy_id'] = array('#type' => 'hidden', '#value' => $node->advocacy_id);
        $form['#submit'][] = 'springboard_advocacy_webform_submit';
      }

    }
  }
}

/**
 * Implements hook_form_FORMID_alter
 *
 * Add ajax functionality to views exposed form to enable district lookups by state.
 *
 * @param $form
 * @param $form_state
 * @param $form_id
 */
function springboard_advocacy_form_views_exposed_form_alter(&$form, &$form_state, $form_id)
{

  if ($form_id == 'views_exposed_form' && $form_state['view']->name == 'targets') {
    $districted = array('views-exposed-form-targets-page-1', 'views-exposed-form-targets-block-2');
//    if(isset($form['search_role_1'])) {
//      $form['search_role_1']['#type'] = 'checkboxes';
//    }


    if (isset($form['search_district_name']) && in_array($form['#id'], $districted)) {
      $form['#after_build'][] = 'springboard_advocacy_views_exposed_form_ajax_enable';

      $form['search_district_name']['#prefix'] = '<div id="district">';
      $form['search_district_name']['#suffix'] = '</div>';

      $form['search_state']['#ajax'] = array(
        'callback' => 'springboard_advocacy_update_districts_field_callback',
        'wrapper' => 'district',
        'method' => 'replace',
        'effect' => 'fade',
      );
      if (empty($form_state['values']['search_state']) && $form_state['input']['search_state'] == 'All') {
        $form['search_district_name']['#disabled'] = TRUE;
      }
      if (!empty($form_state['values']['search_state']) && $form_state['values']['search_state'] == 'All') {
        $form['search_district_name']['#disabled'] = TRUE;
      }
      $form['search_district_name']['#options'] = springboard_advocacy_update_districts_field_options($form, $form_state);

    }
  }
}

/**
 * Ajax callback for views exposed form
 *
 * @param $form
 * @param $form_state
 * @return mixed
 */
function springboard_advocacy_update_districts_field_callback($form, $form_state) {
  return $form['search_district_name'];
}

/**
 * Build the "districts" options array for views exposed form
 *
 * @param $form
 * @param $form_state
 * @return mixed
 */
function springboard_advocacy_update_districts_field_options($form, $form_state)
{
  if (!empty($form_state['values']['search_state']) || $form_state['input']['search_state'] != 'All') {
    if (!empty($form_state['values']['search_state'])) {
      // lookup districts by  $form_state['values']['search_state']
      $options = springboard_advocacy_get_districts($form_state['values']['search_state']);
      return $options;
    } else {
      // lookup districts by  $form_state['input']['search_state']
      // or retrieve from a cache
      $options = springboard_advocacy_get_districts($form_state['input']['search_state']);
      return $options;
    }
  } else {
    return $form['search_district_name']['#options'];
  }
}

function springboard_advocacy_get_districts($state) {
    $loader = new AdvocacyApiClientLoader();
    $client = $loader->getClient();
    $response = $client->getDistrictsByState($state);
    if (isset($response->data)) {
      $options = array('All' => '-Any-');
      foreach ($response->data as $district) {
        $options[$district->DistrictDesc] = $district->DistrictDesc;
      }
      return $options;
    }
}


/**
 * Checks whether the exposed form will use ajax and passes required
 * form information removed in views_form_views_exposed_form_alter().
 *
 * Taken from patch at https://www.drupal.org/node/1183418
 */
function springboard_advocacy_views_exposed_form_ajax_enable(&$form, &$form_state) {
  // In order for Ajax to work, we need the form build info. Here we
  // check if #ajax has been added to any form elements, and if so,
  // pass this info as settings via Javascript, which get attached to
  // the submitted form on Ajax form submissions.
  // #ajax property can be set not only for the first level of the form,
  // so we look for it in the whole form.
  $ajax_info = array();
  $ajax_elements = springboard_advocacy_views_exposed_form_ajax_lookup_recursive($form);
  // Determine if form is being processed.
  $triggering_element_name = '';
  if (!empty($form_state['input']['_triggering_element_name'])) {
    $triggering_element_name = $form_state['input']['_triggering_element_name'];
  }
  // When we have multiple elements with #ajax set on exposed form
  // we need to pass only triggering element name to Javascript.
  // Otherwise #ajax will work only for the first element.
  if (!empty($triggering_element_name) && !empty($ajax_elements)) {
    // Check if element has #ajax property set.
    if (in_array($triggering_element_name, $ajax_elements)) {
      $ajax_elements = array(
        $triggering_element_name => $triggering_element_name,
      );
    }
    else {
      $ajax_elements = array();
    }
  }
  if (!empty($ajax_elements)) {
    $form_info = array(
      'form_id' => $form['#form_id'],
      'form_build_id' => $form['#build_id'],
    );
    // Anonymous users don't get a token.
    if (!empty($form['#token'])) {
      $form_info['form_token'] = $form['#token'];
    }
    foreach ($ajax_elements as $element_name) {
      $ajax_info[$element_name] = $form_info;
    }
    drupal_add_js(array('AdvocacyViewsExposedFormInfo' => $ajax_info), 'setting');

    // Add the javascript behavior that will handle this data.
    $form['#attached']['js'][] = array(
      'weight' => 100,
      'data' => drupal_get_path('module', 'springboard_advocacy') . '/js/exposed-form-ajax.js',
    );
  }
  return $form;
}

/**
 * Recursively looks for the #ajax property for every form elemet.
 * @param $elements
 *   The element array to look for #ajax property.
 *
 * @return
 *   Array of the elements names where #ajax was found.
 *
 * From patch at https://www.drupal.org/node/1183418
 */
function springboard_advocacy_views_exposed_form_ajax_lookup_recursive($elements) {
  $ajax_elements = array();
  foreach (element_children($elements) as $key) {
    if (!empty($elements[$key]['#name']) && !empty($elements[$key]['#ajax'])) {
      $ajax_elements[$elements[$key]['#name']] = $elements[$key]['#name'];
    }
    // Recursive call to look for #ajax in element's childrens.
    $ajax_elements += springboard_advocacy_views_exposed_form_ajax_lookup_recursive($elements[$key]);
  }
  return $ajax_elements;
}


/**
 * Implements hook_theme().
 *
 * Wraps various views in a common theme template
 */
function springboard_advocacy_theme($existing, $type, $theme) {
  $path = drupal_get_path('module', 'springboard_advocacy');

  $templates = array(
    'springboard_advocacy_dashboard' => array(
      'variables' => array('views' => array()),
      'template' => drupal_get_path('theme', $theme) . '/templates/springboard-advocacy-dashboard',
    ),
  );

  // Look for theme templates in springboard_advocacy.
  $templates += drupal_find_theme_functions($existing, array($theme));
  $templates += drupal_find_theme_templates($existing, '.tpl.php', $path);

  return $templates;
}
