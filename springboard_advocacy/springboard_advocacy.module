<?php
/**
 * @file
 * Drupal needs this blank file.
 */

/**
 * Implements hook_menu().
 */
function springboard_advocacy_menu() {
  $items['admin/config/springboard/advocacy'] = array(
    'title' => 'Springboard Advocacy Settings',
    'description' => 'Configuration settings for Springboard advocacy features.',
    'page callback' => 'springboard_advocacy_settings_page',
    'access arguments' => array('administer springboard advocacy'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/springboard_advocacy.admin.inc',
  );

  $items['admin/config/springboard/advocacy/index'] = array(
    'title' => 'Springboard Advocacy',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );

  $items['admin/springboard/advocacy/alerts'] = array(
    'title' => 'Advocacy',
    'page arguments' => array('alerts'),
  ) + springboard_advocacy_menu_common();

  $items['admin/springboard/advocacy/alerts/all'] = array(
    'title' => 'Advocacy',
    'page arguments' => array('alerts/all'),
  ) + springboard_advocacy_menu_common();

   $items['admin/springboard/advocacy/custom-targets'] = array(
    'title' => 'Advocacy',
    'page arguments' => array('custom-targets'),
  ) + springboard_advocacy_menu_common();

  return $items;
}

function springboard_advocacy_menu_common() {
  return array(
    'page callback' => 'springboard_advocacy_dashboard',
    'file' => 'springboard_advocacy.admin.inc',
    'file path' => drupal_get_path('module', 'springboard_advocacy') . '/includes',
    'access arguments' => array('administer springboard advocacy'),
    'type' => MENU_NORMAL_ITEM
    );
}

/**
 * Implements hook_permission().
 */
function springboard_advocacy_permission() {
  return array(
    'administer springboard advocacy' => array(
      'title' => t('Administer Springboard advocacy'),
      'description' => t('Perform administration tasks for Springboard advocacy.'),
    ),
  );
}

/**
 * Implements hook_libraries_info().
 */
function springboard_advocacy_libraries_info() {
  $libraries['springboard_advocacy'] = array(
    'name' => 'Springboard Advocacy',
    'vendor url' => 'https://github.com/JacksonRiver/springboard-sdk-php',
    'download url' => 'https://github.com/JacksonRiver/springboard-sdk-php',
    'version callback' => 'springboard_advocacy_library_version',
    'path' => 'advocacy',
    'files' => array(
      'php' => array(
        'SpringboardAdvocacyAPIClient.php',
      ),
    ),
  );
  return $libraries;
}

/**
 * Version callback for hook_libraries_info().
 */
function springboard_advocacy_library_version($library) {
  return '1';
}

/**
* Implements hook_views_api().
*/
function springboard_advocacy_views_api() {
  return array(
    'api' => 3.0,
  );
}


function springboard_advocacy_node_insert($node) {
  $types = variable_get('springboard_advocacy_alert_types', array());
  if(in_array($node->type, $types)) {
    $uuid = array(
      'nid' => $node->nid,
      'advocacy_id' => uniqid(variable_get('site_name', 'Drupal') . '-'),
    );
    drupal_write_record('springboard_advocacy_alert_id', $uuid);

    if (!empty($node->target_groups)) {

    }

  }
}

function springboard_advocacy_node_update($node) {
  $types = variable_get('springboard_advocacy_alert_types', array());
  if(in_array($node->type, $types)) {
    if (!empty($node->target_groups)) {
      
    }
  }  
}

/**
  *
  * Implements hook_node_load
  *
  * @param $nodes
  *   An array of the nodes being loaded, keyed by nid.
  * @param $types
  *   An array containing the node types present in $nodes. Allows for an early
  *   return for modules that only support certain node types. However, if your
  *   module defines a content type, you can use hook_load() to respond to
  *   loading of just that content type.
  *
  * Add the unique form_id and messages references to node.
  *
  */
function springboard_advocacy_node_load($nodes, $types) {
  $alert_types = variable_get('springboard_advocacy_alert_types', array());
  if (count(array_intersect($alert_types, $types))) {
    $form_ids = db_query(
      'SELECT advocacy_id, nid FROM {springboard_advocacy_alert_id} WHERE nid IN (:nids)', 
       array(':nids' => array_keys($nodes))
     );
    foreach ($form_ids as $form_id) {
      $nodes[$form_id->nid]->advocacy_id = $form_id->advocacy_id;
    }

    $entity_ids = db_query(
      'SELECT entity_id, field_sba_alert_id_target_id FROM {field_data_field_sba_alert_id} WHERE field_sba_alert_id_target_id IN (:nids)',
      array(':nids' => array_keys($nodes)));
    foreach ($entity_ids as $entity_id) {
      $nodes[$entity_id->field_sba_alert_id_target_id]->message_ids[] = $entity_id->entity_id;
    }
  }
}

/**
 * Implemenets hook_form_alter
 * @param $form
 * @param $form_state
 * @param $form_id
 */
function springboard_advocacy_form_alter(&$form, &$form_state, $form_id) {
  module_load_include('inc', 'springboard_advocacy', 'includes/springboard_advocacy.webform');

  $types = variable_get('springboard_advocacy_alert_types', array());

  if (isset($form['#node']) && in_array($form['#node']->type, $types)) {
    //springboard_advocacy_form_vertical_nav($form);
    $node = $form['#node'];

    if (isset($form['form_id'])) {

      $pos = strpos($form['form_id']['#value'], 'webform_client_form');

      if (!empty($node->message_ids) && $pos !== FALSE) {
        $form['messages']['#tree'] = TRUE;
        foreach ($node->message_ids as $id) {
          $form['messages'][$id] = array(
            '#type' => 'hidden',
            '#value' => $id,
          );
        }
      }

      if (!empty($node->advocacy_id) && $pos !== FALSE) {
        $form['advocacy_id'] = array('#type' => 'hidden', '#value' => $node->advocacy_id);
        $form['#submit'][] = 'springboard_advocacy_webform_submit';
      }

    }
  }
}


/**
 * Returns default options for views field configuration
 * Here in the main module because might be used by multiple
 * submodules.
 */
function springboard_advocacy_target_type() {
  $value_options = array(
    'Target' => t('Custom Target'), 
    'Legislator' => t('Legislator'), 
    'group' => t('Group')
    );
  return $value_options;
}

/**
 * Returns default options for views field configuration
 */
function springboard_advocacy_target_level() {
  $value_options = array(
    'SR|SS' => t('State'), 
    'FR|FS' => t('Federal'), 
  );
  return $value_options;
}

/**
 * Returns default options for views field configuration
 */
function springboard_advocacy_target_branch() {
  $value_options = array(
    'executive' => t('Executive'), 
    'legislative' => t('Legislative'), 
  );
  return $value_options;
}

/**
 * Returns default options for views field configuration
 */
function springboard_advocacy_target_party() {
  $value_options = array(
    'D' => t('Democrat'), 
    'R' => t('Republican'), 
    'I' => t('Independent'), 
    'O' => t('Other'),  
  );
  return $value_options;
}

/**
 * Returns default options for views field configuration
 */
function springboard_advocacy_target_state() {
  $value_options = array(
    'AL' => 'Alabama',
    'AK' => 'Alaska',
    'AZ' => 'Arizona',
    'AR' => 'Arkansas',
    'CA' => 'California',
    'CO' => 'Colorado',
    'CT' => 'Connecticut',
    'DE' => 'Delaware',
    'DC' => 'District Of Columbia',
    'FL' => 'Florida',
    'GA' => 'Georgia',
    'HI' => 'Hawaii',
    'ID' => 'Idaho',
    'IL' => 'Illinois',
    'IN' => 'Indiana',
    'IA' => 'Iowa',
    'KS' => 'Kansas',
    'KY' => 'Kentucky',
    'LA' => 'Louisiana',
    'ME' => 'Maine',
    'MD' => 'Maryland',
    'MA' => 'Massachusetts',
    'MI' => 'Michigan',
    'MN' => 'Minnesota',
    'MS' => 'Mississippi',
    'MO' => 'Missouri',
    'MT' => 'Montana',
    'NE' => 'Nebraska',
    'NV' => 'Nevada',
    'NH' => 'New Hampshire',
    'NJ' => 'New Jersey',
    'NM' => 'New Mexico',
    'NY' => 'New York',
    'NC' => 'North Carolina',
    'ND' => 'North Dakota',
    'OH' => 'Ohio',
    'OK' => 'Oklahoma',
    'OR' => 'Oregon',
    'PA' => 'Pennsylvania',
    'RI' => 'Rhode Island',
    'SC' => 'South Carolina',
    'SD' => 'South Dakota',
    'TN' => 'Tennessee',
    'TX' => 'Texas',
    'UT' => 'Utah',
    'VT' => 'Vermont',
    'VA' => 'Virginia',
    'WA' => 'Washington',
    'WV' => 'West Virginia',
    'WI' => 'Wisconsin',
    'WY' => 'Wyoming',
  );
  return $value_options;
}

/**
 * Returns default options for views field configuration
 */
function springboard_advocacy_target_gender() {
  $value_options = array(
    'M' => 'Male',
    'F' => 'Female'
  );
  return $value_options;
}

/**
 * Implements hook_theme().
 */
function springboard_advocacy_theme($existing, $type, $theme) {
  $path = drupal_get_path('module', 'springboard_advocacy');

  $templates = array(
    'springboard_advocacy_dashboard' => array(
      'variables' => array('views' => array()),
      'template' => drupal_get_path('theme', $theme) . '/templates/springboard-advocacy-dashboard',
    ),
  );

  // Look for theme templates in springboard_advocacy.
  $templates += drupal_find_theme_functions($existing, array($theme));
  $templates += drupal_find_theme_templates($existing, '.tpl.php', $path);

  return $templates;
}
