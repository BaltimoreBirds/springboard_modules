<?php
// $Id: gm_ogone_ecommerce.module,v 1.0.0.0 2011/04/13 21:27:56 pcave Exp $

/**
 * @file
 * A test version of the Ogone ecommerce payment gateway.
 *
 */
 
/**
 * Implementation of hook_menu().
 */
function gm_ogone_ecommerce_menu() {
  $items['ogone/post/%uc_order'] = array(
    'title' => t('Ogone e-commerce'),
    'page callback' => 'gm_ogone_ecommerce_build_form',
    'page arguments' => array(2),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  
  return $items;
}

function gm_ogone_ecommerce_build_form($order) {
  drupal_add_js(drupal_get_path('module', 'gm_ogone_ecommerce') . '/gm_ogone_ecommerce.js');
  return drupal_get_form('gm_ogone_ecommerce_post_form', $order);
}

function gm_ogone_ecommerce_post_form(&$form_state, $order) {
  $url = 'https://secure.ogone.com/ncol/test/orderstandard.asp';
  
  $form['#action'] = $url;
  $form['#id'] = 'ogone-ecommerce-post';
  
  $form['PSPID'] = array(
    '#type' => 'hidden',
    '#value' => 'brockbolandcommerce',
  );
  
  $form['orderID"'] = array(
    '#type' => 'hidden',
    '#value' => 101, //$order->order_id,
  );
  
    $form['amount'] = array(
      '#type' => 'hidden',
      '#value' => $order->order_total,
    );

    $form['currency'] = array(
      '#type' => 'hidden',
      '#value' => 'USD',
    );
    $form['language'] = array(
      '#type' => 'hidden',
      '#value' => 'en_US',
    );

    $form['CN'] = array(
      '#type' => 'hidden',
      '#value' => $order->billing_first_name . ' ' . $order->billing_last_name,
    );

    $form['EMAIL"'] = array(
      '#type' => 'hidden',
      '#value' => $order->primary_email,
    );

    $form['ownerZIP'] = array(
      '#type' => 'hidden',
      '#value' => $order->billing_postal_code,
    );

    $form['owneraddress'] = array(
      '#type' => 'hidden',
      '#value' => $order->billing_street1,
    );


    $form['ownercty'] = array(
      '#type' => 'hidden',
      '#value' => $order->billing_country,
    );

    $form['ownertown'] = array(
      '#type' => 'hidden',
      '#value' => $order->billing_city,
    );

  return $form;
}

/*******************************************************************************
 * Hook Functions (Ubercart)
 ******************************************************************************/

function gm_ogone_ecommerce_payment_gateway_managed() {
  $gateways[] = array(
    'id' => 'ogone_ecommerce',
    'title' => t('Ogone Ecommerce'),
    'description' => t('Process payments using Ogone\'s e-commerce payment method.'),
    'credit' => 'ogone_ecommerce_charge',
  );

  return $gateways;
}

function ogone_ecommerce_charge($order_id, $amount, $data) {
  //global $user;
  //$order = uc_order_load($order_id);
  
  drupal_goto('ogone/post/' . $order_id);
}