<?php
/**
 * @file
 *
 * @todo Ability to lock editing of specific fields.
 * @todo Pager on submission results table
 */

/**
 * Implements hook_menu().
 */
function webform_ui_menu() {
  $items['admin/config/content/webform-ui'] = array(
    'title' => 'Webform UI',
    'description' => 'Settings for the Webform UI user interface enhancements',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('webform_ui_settings_form'),
    'access arguments' => array('configure webform ui'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'webform_ui.admin.inc',
  );
  return $items;
}


/**
 * Implements hook_permission().
 */
function webform_ui_permission() {
  return array(
    'configure webform ui' => array(
      'title' => t('Configure  Webform UI user interface enhancements.'),
      'description' => t('Manage Webform UI settings.'),
    ),
  );
}

function webform_ui_form_webform_components_form_alter(&$form, &$form_state, $form_id) {
  if (variable_get('webform_ui_hide_hidden', 'FALSE')) {
    $form['#attached']['js'][] = array(
      'weight' => 100,
      'data' => drupal_get_path('module', 'webform_ui') . '/js/remove-tabledrag.js',
    );
    foreach ($form['components'] as $cid => $component) {
      if ($form['#node']->webform['components'][$cid]['type'] == 'hidden') {
//        $form['#node']->webform['components'][$cid]['weight'] = 998;
//        $form['components'][$cid]['weight']['#default_value'] = 998;
//        $form['components'][$cid]['weight']['#disabled'] = TRUE;
      }
    }
    $form['add']['weight']['#default_value'] = 999;
    $form['add']['weight']['#disabled'] = TRUE;
  }
}

function webform_ui_form_webform_configure_form_alter(&$form, &$form_state) {
  $form['role_control']['#collapsed'] = TRUE;
  $form['#after_build'][] = 'webform_ui_form_webform_configure_afterbuild';
  $form['#attached']['js'][] = array(
    'weight' => 100,
    'data' => drupal_get_path('module', 'webform_ui') . '/js/confirm-settings.js',
  );
  $form['#attached']['css'][] = drupal_get_path('module', 'webform_ui') . '/css/webform_ui.css';

}

function webform_ui_form_webform_configure_afterbuild($form, $form_state) {
  $form['submission']['help']['#weight'] = 0;
  return $form;
}

function webform_ui_menu_alter(&$items) {
  if (variable_get('webform_ui_use_alternate_submission', FALSE)) {
    $items['node/%webform_menu/webform-results']['page callback'] = 'webform_ui_submission_results';
    $items['node/%webform_menu/webform-results']['page arguments'] = array(1);
  }
  if (variable_get('webform_ui_hide_clear_all', FALSE)) {
    $items['node/%webform_menu/webform-results/clear']['access callback'] = 'webform_ui_submission_access';
  }
  if (variable_get('webform_ui_use_alternate_submission', FALSE)) {
    $items['node/%webform_menu/webform-results/table']['access callback'] = 'webform_ui_submission_access';
  }

}

function webform_ui_submission_results($node) {

  $view = views_get_view('webform_submissions');

  if (empty($view)) {
    return t('The webform submissions view could not be found.');
  }

  if (isset($view->display['block_1'])) {
    $view->set_display('block_1');
  }
  else {
    return t('The webform submissions display block could not be found. You may need to revert the view to restore the deleted block.');
  }

  if (!empty($node->nid)) {
    $view->set_arguments(array($node->nid));
  }

  $view->pre_execute();

  $view->execute();

  if ($view->access('block_1')) {
    return $view->preview();
  }
  else {
    return t("access denied");
  }
}

function webform_ui_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
  if (arg(2) == 'webform-results') {
    $form['#attached']['css'][] = drupal_get_path('module', 'webform_ui') . '/css/webform_ui.css';
  }
 }

function webform_ui_submission_access($node) {
  return FALSE;
}

/**
 * Implements hook_action_info
 */
function webform_ui_action_info() {
  return array(
    'webform_ui_submission_delete' => array(
      'type' => 'node',
      'label' => t('Delete Webform submission'),
      'description' => t('Delete Webform submission'),
      'configurable' => FALSE,
      'triggers' => array(
        'any' => TRUE,
      ),
    ),
  );
}

/**
 * Implementation of a Drupal action
 *
 * @param object $object
 * @param array $context
 */
function webform_ui_submission_delete(&$node, $context = array()) {
  $sid = current($context['rows'])->sid;
  $submission = webform_menu_submission_load($sid, $node->nid);
  if ($submission) {
    webform_submission_delete($node, $submission);
  }
}

/**
 * Action config form(inside the view).
 */
function webform_ui_submission_delete_views_bulk_operations_form($options) {
  $options = db_select('webform_component', 'webform_component')
    ->fields('webform_component', array('cid', 'name'))
    ->execute()
    ->fetchAllKeyed(0, 1);

  $form['field'] = array(
    '#title' => t('Confirmation field'),
    '#type' => 'select',
    '#options' => $options,
    '#description' => t('The field to display on the confirmation field.'),
    '#default_value' => isset($options['field']) ? $options['field'] : '',
  );
  return $form;
}

/**
 * Perform alterations on the VBO form before it is rendered.
 *
 * @param $form
 *  A step of the VBO form to be altered.
 * @param $form_state
 *  Form state. Contains the name of the current step in $form_state['step'].
 * @param $vbo
 *   The VBO views field. Contains a reference to the view in $vbo->view.
 */
function webform_ui_views_bulk_operations_form_alter(&$form, &$form_state, $vbo) {
  //$form['select']['#access'] = FALSE;;
 if($vbo->definition['handler'] = 'webform_ui_bulk_operations_handler_field_operations') {
    if ($form_state['step'] == 'views_bulk_operations_confirm_form') {
      $variables = array(
        'items' => array(),
        'title' => t('Are you sure you want to delete the following submissions')
      );
      module_load_include('inc', 'webform', 'includes/webform.submissions');
      foreach ($form_state['values']['views_bulk_operations'] as $key => $status) {
        if ($status) {
          $field = $vbo->options['vbo_operations'][$form_state['values']['operation']]['settings']['field'];
          $field = $field ? $field : 'remote_addr';
          $submission = current(webform_get_submissions(array('sid' => $vbo->view->result[$key]->sid)));
          $variables['items'][] = "{$submission->sid} : {$submission->data[$field]['value'][0]}";
        }
      }
      $form['description']['#markup'] = theme('item_list', $variables);
    }
  }
}

/**
 * Implements hook_views_api().
 */
function webform_ui_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'webform_ui') . '/views',
  );
}
