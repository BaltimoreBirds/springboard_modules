<?php

function springboard_m2t_menu() {
  $items = array();

  $items['admin/config/system/m2t'] = array(
    'title' => 'Message to Target',
    'description' => '',
    'access arguments' => array('administer site configuration'),
    'page arguments' => array('springboard_m2t_admin'),
    'page callback' => 'drupal_get_form',
  );

  $items['smartylookup'] = array(
    'title' => 'Get district info from smarty streets',
    'description' => '',
    'type' => MENU_CALLBACK,
    'page callback' => '_springboard_mt2_smarty_lookup',
    'access callback' => TRUE,
  );

  return $items;
}

function springboard_m2t_webform_user_profile_fields_alter(&$fields, $node) {
  if($node->type == 'springboard_m2t') {
    foreach ($fields as $index => $profile_field) {
      if ($profile_field['name'] != 'sbp_address_line_2'){
        $fields[$index]['mandatory'] = 1;
      }
      if ($profile_field['name'] == 'sbp_state'){
        unset($fields[$index]);
      }
      if ($profile_field['name'] == 'mail'){
        $fields[$index]['weight'] = 14;
      }
    } 
  }
}

function springboard_m2t_node_insert($node) {
  if($node->type == 'springboard_m2t') {
    module_load_include('inc', 'webform', 'includes/webform.components');

    $fields[] = array(
      'nid' => $node->nid,
      'form_key' => 'springboard_m2t_phone',
      'pid' => 0,
      'name' => t('Phone Number'),
      'type' => 'textfield',
      'mandatory' => 1,
      'weight' => 13,
      'email' => 1,
      'extra' => array(
      'description' => t(''),
      ),
    );

    $fields[] = array(
        'nid' => $node->nid,
        'form_key' => 'springboard_m2t_message',
        'pid' => 0,
        'name' => t('Message'),
        'type' => 'textarea',
        'mandatory' => 1,
        'weight' => 18,
        'email' => 1,
        'extra' => array(
        'description' => t('Customize your message'),
      ),
    );

    $fields[] = array(
        'nid' => $node->nid,
        'form_key' => 'sbp_state',
        'pid' => 0,
        'name' => t('State/Province'),
        'type' => 'select',
        'mandatory' => 1,
        'weight' => 12,
        'email' => 1,
        'extra' => array(
        'options_source' => 'united_states', //may have to remove some.
        'aslist' => 'Y',
        'multiple' => 0,
      ),
    );

    // Add the component to the Webform.
    foreach ($fields as $field) {
      $cid = webform_component_insert($field);
      if ($field['name'] == 'State') {
            $map = array(
            'nid' => $node->nid,
            'cid' => $cid,
            'map_id' => $field['name'],
          );
          drupal_write_record('webform_user_component_map', $map);
      }
    }
  }
}

function springboard_m2t_form_alter(&$form, &$form_state, $form_id) {
  if(isset($form['#node'])) {
    $node = $form['#node'];
    if($node->type == 'springboard_m2t') {
      $form['#submit'][] = 'springboard_m2t_submit';
      $form['#attributes']['class'][] = 'geocode-form';
      $form['#attributes']['class'][] = 'geocode-form';
      // if (variable_get('springboard_m2t_geocoder', '') == 'googlej') {
      //   $form['#attached']['js'][]  = array('data' => 'https://maps.googleapis.com/maps/api/js?sensor=false', 'type' => 'external');
      // }
      $form['#attached']['js'][] = array('data' => drupal_get_path('module', 'springboard_m2t') . '/js/m2t.js'); 
      $form['#attached']['js'][] = array(
        'data' => array(
          'springboard_m2t' => array(
              'geocoder' => variable_get('springboard_m2t_geocoder', ''),
            ),
          ),
        'type' => 'setting',
      );
    }
  }
}

function _springboard_mt2_smarty_lookup() {
  
  $responses = array();
  $address = $_POST['address'];
  
  $query =  array(
    //'street' => '49 Hall Rd, Canaan, NH 03741', //$address,
    'street' => urlencode($address['submitted[sbp_address']),
    'city' => urlencode($address['submitted[sbp_city']),
    'state' => urlencode($address['submitted[sbp_state']),
    'zipcode' => urlencode($address['submitted[sbp_zip']),
    'auth-id' => variable_get('springboard_m2t_smarty_authid',''),
    'auth-token' => variable_get('springboard_m2t_smarty_authtoken',''),

  );
 
  if (!empty($address)) {

    //setcookie('m2t_user_coords', $latitude . ' ' . $longitude);
    
    $url = url('https://api.smartystreets.com/street-address', array('query' => $query));

    $response = drupal_http_request($url);

    if (!isset($response->status_message) || $response->status_message != 'OK') {
      return drupal_json_output(array('error' => 'Server returned invalid response'));
    }
    if (!empty($response->data)) {
      $data = json_decode($response->data);
      if(!empty($data)) {
        $geo = array();
        $geo['zip'] = isset($data[0]->components->zipcode) ? $data[0]->components->zipcode : '';
        $geo['plus'] = isset($data[0]->components->plus4_code) ? $data[0]->components->plus4_code : '';
        //$district = $data[0]->metadata->congressional_district;
        $geo['latitude'] = isset($data[0]->metadata->latitude) ? $data[0]->metadata->latitude : '';
        $geo['longitude'] = isset($data[0]->metadata->longitude) ? $data[0]->metadata->longitude : '';
        $_SESSION['m2t_geo'] = $geo;
      }
    }
  }
  else {
    return drupal_json_output(array('error' => 'address not supplied'));
  }
}


function springboard_m2t_admin() {
  
  $form = array();

  $form['geo'] = array(
    '#type' => 'fieldset',
    '#title' => t('Geocoding configuration'),
  );
  $options = array(
    //'googlej' => 'Google Javascript API (Free, no rate limit, Requires Sunlight API key for district lookups)',
   // 'geocodio' => 'Geocod.io (Free, 2,000 requests per day, api key is required)',
    //'smartystreets' => 'SmartyStreets Javascript API (Pay, API key is required)',
    'smartystreets_rest' => 'SmartyStreets REST API (Pay, API key is required)',
  );

  $form['geo']['springboard_m2t_geocoder'] = array(
    '#type' => 'radios',
    '#title' => t('Active Geocoding service'),
    '#options' => $options,
    '#description' => t('Choose the geocoding service to use. All but Google Javascript API require an API Key'),
    '#default_value' => variable_get('springboard_m2t_geocoder', ''),
  );
  
  $form['geo']['smarty'] = array(
    '#type' => 'fieldset',
    '#title' => t('Smarty Streets configuration'),
  );

  $form['geo']['smarty']['springboard_m2t_smarty_authid'] = array(
    '#type' => 'textfield',
    '#title' => t('Smarty Streets Auth ID'),
    '#description' => t(''),
    '#default_value' => variable_get('springboard_m2t_smarty_authid', ''),
  );

  $form['geo']['smarty']['springboard_m2t_smarty_authtoken'] = array(
    '#type' => 'textfield',
    '#title' => t('Smarty Streets Auth Token'),
    '#description' => t(''),
    '#default_value' => variable_get('springboard_m2t_smarty_authtoken', ''),
  );

  $form['geo']['smarty']['springboard_m2t_smarty_htmltoken'] = array(
    '#type' => 'textfield',
    '#title' => t('Smarty Streets HTML token'),
    '#description' => t(''),
    '#default_value' => variable_get('springboard_m2t_smarty_htmltoken', ''),
  );

  return system_settings_form($form);
}

function springboard_m2t_submit($form, $form_state) {

}

function springboard_m2t_webform_submission_insert($node, $submission) {
  if(isset($_SESSION['m2t_geo']) && $node->type == 'springboard_m2t') {
    $data = array(
      'nid' => $submission->nid,
      'sid' => $submission->sid,
      'uid' => $submission->uid,
      'zip' => $_SESSION['m2t_geo']['zip'],
      'plus4' => $_SESSION['m2t_geo']['plus'],
      'lat' => $_SESSION['m2t_geo']['latitude'],
      'lon' => $_SESSION['m2t_geo']['longitude'],
    );
    drupal_write_record('springboard_m2t_location', $data);
    unset($_SESSION['m2t_geo']);
  };
}

