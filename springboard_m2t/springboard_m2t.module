<?php

function springboard_m2t_menu() {
  $items = array();

  $items['admin/config/system/m2t'] = array(
    'title' => 'Message to Target',
    'description' => '',
    'type' => MENU_CALLBACK,
    'access arguments' => array('administer site configuration'),
    'page arguments' => array('springboard_m2t_admin'),
    'page callback' => 'drupal_get_form',
  );

  $items['sunlightlookup'] = array(
    'title' => 'Get district info from sunlight',
    'description' => '',
    'type' => MENU_CALLBACK,
    'page callback' => '_springboard_mt2_sunlight_lookup',
    'access arguments' => array(1),
  );
  return $items;
}

function springboard_m2t_webform_user_profile_fields_alter(&$fields, $node) {
  if($node->type == 'springboard_m2t') {
    foreach ($fields as $index => $profile_field) {
      if ($profile_field['name'] != 'sbp_address_line_2'){
        $fields[$index]['mandatory'] = 1;
      }
      if ($profile_field['name'] == 'sbp_state'){
        unset($fields[$index]);
      }
      if ($profile_field['name'] == 'mail'){
        $fields[$index]['weight'] = 14;
      }
    } 
  }
}

function springboard_m2t_node_insert($node) {
  module_load_include('inc', 'webform', 'includes/webform.components');
  $fields[] = array(
    'nid' => $node->nid,
    'form_key' => 'springboard_m2t_phone',
    'pid' => 0,
    'name' => t('Phone Number'),
    'type' => 'textfield',
    'mandatory' => 1,
    'weight' => 13,
    'email' => 1,
    'extra' => array(
    'description' => t(''),
    ),
  );

  $fields[] = array(
      'nid' => $node->nid,
      'form_key' => 'springboard_m2t_message',
      'pid' => 0,
      'name' => t('Message'),
      'type' => 'textarea',
      'mandatory' => 1,
      'weight' => 18,
      'email' => 1,
      'extra' => array(
      'description' => t('Customize your message'),
    ),
  );
  $fields[] = array(
      'nid' => $node->nid,
      'form_key' => 'sbp_state',
      'pid' => 0,
      'name' => t('State'),
      'type' => 'select',
      'mandatory' => 1,
      'weight' => 12,
      'email' => 1,
      'extra' => array(
      'options_source' => 'united_states', //may have to remove some.
      'aslist' => 'Y',
      'multiple' => 0,
    ),
  );

  // Add the component to the Webform.
  foreach ($fields as $field) {
    $cid = webform_component_insert($field);
    if ($field['name'] == 'sbp_state') {
          $map = array(
          'nid' => $node->nid,
          'cid' => $cid,
          'map_id' => $field['name'],
        );
        drupal_write_record('webform_user_component_map', $map);
    }
  }
}

function springboard_m2t_form_alter(&$form, &$form_state, $form_id) {
  if(isset($form['#node'])) {
    $node = $form['#node'];
    if($node->type == 'springboard_m2t') {
      $form['#attributes']['class'][] = 'geocode-form';
      $form['#attached']['js'][]  = array('data' => 'https://maps.googleapis.com/maps/api/js?sensor=false', 'type' => 'external');
      $form['#attached']['js'][] = array('data' => drupal_get_path('module', 'springboard_m2t') . '/js/m2t.js'); 
    }
  }
}

function _springboard_mt2_sunlight_lookup() {
  //legislators/geo/?lat=latitude&long=longitude
  //districts/locate?latitude=42.96&longitude=-108.09

  $coords = $_POST['coords'];
  $latitude = $coords[0];
  $longitude = $coords[1]; 
  $apikey = variable_get('springboard_m2t_apikey', '');

  $query =  array(
   'latitude' => $latitude,
   'longitude' => $longitude,
   'apikey' => '4b2253f313de4a019071b633b9df542f',
  );

  $url = url('https://congress.api.sunlightfoundation.com/districts/locate', array('query' => $query));
  $response = drupal_http_request($url);
  return drupal_json_output($response);
}

function springboard_m2t_admin() {
  $form = array();
  $form['springboard_m2t_apikey'] = array(
    '#type' => 'textfield',
    '#title' => t('Sunlight API Key'),
    '#description' => t(''),
    '#default_value' => variable_get('springboard_m2t_apikey', ''),
  );

  return system_settings_form($form);
}

