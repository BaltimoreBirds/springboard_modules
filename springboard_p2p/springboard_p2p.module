<?php
/**
 * @file
 * Code for the Springboard peer to peer feature.
 */

include_once 'springboard_p2p.features.inc';

define('SPRINGBOARD_P2P_ROLE', 'Springboard P2P campaigner');

/**
 * Implements hook_ctools_plugin_directory().
 */
function springboard_p2p_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'ctools' && ($plugin_type == 'content_types')) {
    return 'plugins/' . $plugin_type;
  }
}

/**
 * Implements hook_permission().
 */
function springboard_p2p_permission() {
  return array(
    'administer springboard p2p' => array(
      'title' => t('Administer springboard peer to peer.'),
    ),
    'register for springboard p2p' => array(
      'title' => t('Register for springboard peer to peer.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function springboard_p2p_menu() {
  $items = array();

  $items['admin/springboard/p2p'] = array(
    'title' => 'Springboard peer to peer',
    'page callback' => 'springboard_p2p_dashboard',
    'file' => 'springboard_p2p.admin.inc',
    'file path' => drupal_get_path('module', 'springboard_p2p') . '/includes',
    'access arguments' => array('administer springboard p2p'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/springboard/p2p/dashboard'] = array(
    'title' => 'Dashboard',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'access arguments' => array('administer springboard p2p'),
  );

  $items['admin/springboard/p2p/settings'] = array(
    'title' => 'Settings',
    'type' => MENU_LOCAL_TASK,
    'access arguments' => array('administer springboard p2p'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('springboard_p2p_admin_settings'),
    'file' => 'springboard_p2p.admin.inc',
    'file path' => drupal_get_path('module', 'springboard_p2p') . '/includes',
  );

  // P2P Rules administration page.
  if (module_exists('rules')) {
    $items['admin/springboard/p2p/rules'] = array(
      'title' => 'Rules',
      'type' => MENU_LOCAL_TASK,
      'description' => 'Enable and configure P2P rule configurations.',
      'page callback' => 'springboard_p2p_rules_admin_page',
      'access arguments' => array('administer springboard p2p'),
      'file' => 'springboard_p2p.rules_admin.inc',
      'file path' => drupal_get_path('module', 'springboard_p2p') . '/includes',
    );

    // Add the menu items for the various Rules forms.
    $controller = new RulesUIController();
    $items += $controller->config_menu('admin/springboard/p2p/rules');

    $items['admin/springboard/p2p/rules/add'] = array(
      'title' => 'Add a P2P rule',
      'description' => 'Adds an additional P2P rule configuration.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('springboard_p2p_add_rule_form', 'admin/springboard/p2p/rules'),
      'access arguments' => array('administer springboard p2p'),
      'file path' => drupal_get_path('module', 'rules_admin'),
      'file' => 'rules_admin.inc',
    );
  }

  $items['springboard_p2p/register'] = array(
    'title' => 'Register',
    'type' => MENU_CALLBACK,
    'access arguments' => array('register for springboard p2p'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('springboard_p2p_register_page'),
    'file' => 'springboard_p2p.register.inc',
    'file path' => drupal_get_path('module', 'springboard_p2p') . '/includes',
  );

  if (module_exists('fboauth')) {
    $items['springboard_p2p/fb'] = array(
      'title' => 'Facebook',
      'type' => MENU_CALLBACK,
      'access arguments' => array('register for springboard p2p'),
      'page callback' => 'springboard_p2p_fb_page',
      'file' => 'springboard_p2p.fboauth.inc',
      'file path' => drupal_get_path('module', 'springboard_p2p') . '/includes',
    );
  }

  $items['user/%user/complete-p2p-profile'] = array(
    'title' => 'Complete your profile',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('springboard_p2p_complete_profile_form', 1),
    'access callback' => 'springboard_p2p_complete_profile_form_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
    'file path' => drupal_get_path('module', 'springboard_p2p') . '/includes',
    'file' => 'springboard_p2p.profile.inc',
  );

  $items['springboard_p2p/password/%user'] = array(
    'title' => 'Password reset email',
    'page callback' => 'springboard_p2p_request_password_reset_page',
    'page arguments' => array(2),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    'file' => 'springboard_p2p.password.inc',
    'file path' => drupal_get_path('module', 'springboard_p2p') . '/includes',
  );

  $items['springboard_p2p/set_password/%/%/%'] = array(
    'title' => 'Set password',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('springboard_p2p_set_password_form', 2, 3, 4),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    'file' => 'springboard_p2p.password.inc',
    'file path' => drupal_get_path('module', 'springboard_p2p') . '/includes',
  );

  $items['user/%user/personal-campaigns'] = array(
    'title' => 'My Campaigns',
    'page callback' => 'springboard_p2p_personal_dashboard',
    'page arguments' => array(1),
    'access callback' => 'springboard_p2p_personal_dashboard_view_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'file' => 'springboard_p2p.pages.inc',
    'file path' => drupal_get_path('module', 'springboard_p2p') . '/includes',
  );

  return $items;
}

/**
 * Implements hook_theme().
 */
function springboard_p2p_theme() {
  return array(
    'springboard_p2p_admin_settings' => array(
      'render element' => 'form',
      'file' => 'springboard_p2p.admin.inc',
      'path' => drupal_get_path('module', 'springboard_p2p') . '/includes',
    ),
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Remove the Save button from the View.
 */
function springboard_p2p_form_views_form_p2p_user_approval_page_alter(&$form, &$form_state, $form_id) {
  unset($form['actions']['submit']);
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Remove the Save button from the View and add a submit function so it will
 * redirect back to the admin dashboard.
 */
function springboard_p2p_form_views_form_p2p_user_approval_dashboard_page_alter(&$form, &$form_state, $form_id) {
  unset($form['actions']['submit']);
  $form['#submit'][] = 'springboard_p2p_form_views_form_p2p_user_approval_dashboard_page_submit';
}

/**
 * Submit handler for the approval queue View to go back to the dashboard.
 */
function springboard_p2p_form_views_form_p2p_user_approval_dashboard_page_submit($form, &$form_state) {
  $form_state['redirect'] = 'admin/springboard/p2p';
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Remove the Save button from the View.
 */
function springboard_p2p_form_views_form_p2p_user_approval_block_alter(&$form, &$form_state, $form_id) {
  unset($form['actions']['submit']);
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function springboard_p2p_form_p2p_campaign_node_form_alter(&$form, &$form_state, $form_id) {
  $language = $form['language']['#value'];
  if (springboard_p2p_form_is_node_create($form)) {
    $ajax_trigger = 'field_p2p_category';
    $ajax_wrapper = 'p2p-category-ajax-wrapper';

    $lang_code = $form['#node']->language;

    $form[$ajax_trigger][$lang_code]['#ajax'] = array(
      'callback' => 'springboard_p2p_ajax',
      'wrapper' => $ajax_wrapper,
      'effect' => 'fade',
    );

    // Set ajax target div.
    $form['#prefix'] = '<div id="' . $ajax_wrapper . '">';
    $form['#suffix'] = '</div>';

    // If we're ajaxing from the category selection and it's a non-empty
    // category value.
    if (isset($form_state['triggering_element']['#field_name']) && $form_state['triggering_element']['#field_name'] == $ajax_trigger && isset($form_state['input'][$ajax_trigger][$lang_code]) && is_numeric($form_state['input'][$ajax_trigger][$lang_code])) {
      $category = node_load($form_state['input'][$ajax_trigger][$lang_code]);

      $checkboxes = array(
        'field_p2p_personal_intro_edit',
        'field_p2p_images_edit',
        'field_p2p_video_embed_edit',
      );

      foreach ($checkboxes as $checkbox) {
        unset($form_state['input'][$checkbox][$lang_code]);
        $form[$checkbox][$lang_code]['#default_value'] = $category->{$checkbox}[$lang_code][0]['value'];
      }

      $textareas = array(
        'field_p2p_personal_intro',
        'field_p2p_org_intro',
      );

      foreach ($textareas as $field_name) {
        if (isset($category->{$field_name}[$lang_code][0])) {
          $content = $category->{$field_name}[$lang_code][0];
          unset($form_state['input'][$field_name][$lang_code][0]['value']);
          $form[$field_name][$lang_code][0]['#default_value'] = $content['value'];
          unset($form_state['input'][$field_name][$lang_code][0]['format']);
          $form[$field_name][$lang_code][0]['#format'] = $content['format'];
        }
      }

      if (isset($category->field_p2p_campaign_banner[$lang_code][0])) {
        $form_header = $category->field_p2p_campaign_banner[$lang_code][0];
        unset($form_state['input']['field_p2p_campaign_banner'][$lang_code][0]);
        $form['field_p2p_campaign_banner'][$lang_code][0]['#default_value']['fid'] = $form_header['fid'];
      }

      if (isset($category->field_p2p_video_embed[$lang_code][0])) {
        $video_embed = $category->field_p2p_video_embed[$lang_code][0];
        unset($form_state['input']['field_p2p_video_embed'][$lang_code][0]);
        $form['field_p2p_video_embed'][$lang_code][0]['video_url']['#default_value'] = $video_embed['video_url'];
      }

      // Personal campaign default images.
      // Has multiple values.
      if (isset($category->field_p2p_images[$lang_code]) && count($category->field_p2p_images[$lang_code] > 1)) {
        $category_images = $category->field_p2p_images[$lang_code];

        // Remove the "upload a new file" row.
        array_pop($category_images);

        unset($form_state['input']['field_p2p_images']);

        // Get the "upload a new file" row before destroying everything.
        $children_keys = element_children($form['field_p2p_images'][$lang_code]);
        $max = max($children_keys);
        $upload_row = $form['field_p2p_images'][$lang_code][$max];

        // In #default_value
        // set the fid, uid, filename
        // remove display, description
        // add uri, filemime, filesize, status, timestamp, rdf mapping
        //
        // Set #weight to $delta
        // remove #file_upload_delta, #theme, #theme_wrappers, #process, #title,
        // #description, #field_name, #language, #display_field,
        // #file_upload_title, #file_upload_description, #after_build,
        // #field_parents
        $image_row = $upload_row;
        unset($image_row['#default_value']);
        unset($image_row['#weight']);
        // unset($image_row['#file_upload_delta']);
        // unset($image_row['#theme']);
        // unset($image_row['#theme_wrappers']);
        // unset($image_row['#process']);
        // unset($image_row['#title']);
        // unset($image_row['#description']);
        // unset($image_row['#field_name']);
        // unset($image_row['#language']);
        // unset($image_row['#display_field']);
        // unset($image_row['#file_upload_title']);
        // unset($image_row['#file_upload_description']);
        // unset($image_row['#after_build']);
        foreach ($category_images as $delta => $image) {
          $form['field_p2p_images'][$lang_code][$delta] = $image_row;
          $form['field_p2p_images'][$lang_code][$delta]['#default_value'] = $image;
          $form['field_p2p_images'][$lang_code][$delta]['#weight'] = $delta;
        }

        // Put the last row back on.
        $last_delta = count($form['field_p2p_images'][$lang_code]);
        $form['field_p2p_images'][$lang_code][$last_delta] = $upload_row;
      }
    }
  }
  // Attach show/hide states to the private campaign error message field.
  $form['field_p2p_private_access_message'][$language][0]['value']['#states'] = array(     // Hide the settings when the cancel notify checkbox is disabled.
    'invisible' => array(
      ':input[name="field_p2p_campaigns_approval[' . $language . ']"]' => array('checked' => FALSE),
    ),
  );
}

/**
 * AJAX callback for prefilling content when a category is selected.
 */
function springboard_p2p_ajax($form, $form_state) {
  return $form;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function springboard_p2p_form_p2p_personal_campaign_node_form_alter(&$form, &$form_state, $form_id) {

  if (springboard_p2p_form_is_node_create($form)) {
    $campaign = isset($_GET['p2p_cid']) ? $_GET['p2p_cid'] : FALSE;
    $ajax = FALSE;
    if (isset($form_state['parent_campaign'])) {
      $campaign = $form_state['parent_campaign'];
      $ajax = TRUE;
    }
    $form_state['campaign'] = $campaign;
    $language = $form['language']['#value'];
    $campaign_node = FALSE;

    // Someone has accidentally stumbled onto the personal campaign add form
    // without a campaign id in the url.
    if (!$campaign || !is_numeric($campaign)) {
      // Prefix added as a formality so ajax events have something to target.
      // Ajax callback redirects to form with campaign id in url.
      $form['#prefix'] = '<div id="personal-campaign-wrapper">';
      $form['#suffix'] = '</div>';
      $form['field_p2p_campaign'][$language]['#ajax'] = array(
        'callback' => 'springboard_p2p_personal_campaign_ajax',
        'wrapper' => 'personal-campaign-wrapper',
      );
    }
    else {
      $form_state['parent_campaign'] = $campaign;
    }

    // If a campaign node id is available in the url, fill in form with defaults
    // from the campaign.
    if ($campaign && is_numeric($campaign)) {
      global $user;
      $campaign_node = node_load($campaign);
      // If campaign_node is not a valid campaign node type, revert to blank
      // form.
      if (!isset($campaign_node->type) || (isset($campaign_node->type) && $campaign_node->type != 'p2p_campaign')) {
        // TODO: throw visible error? Watchdog?
        drupal_goto('node/add/p2p-personal-campaign');
      }
      $language = $campaign_node->language;
      $private_campaign = springboard_p2p_campaign_is_private($campaign_node);
      // If a user attempts to create a personal campaign from a private
      // campaign that they have not been granted access to,
      // replace form with message and action button.
      if ($private_campaign && !springboard_p2p_private_campaign_user_is_authorized($campaign_node->nid, $user->uid)) {
        $node = $form['#node'];
        $parents = $form['#parents'];
        $tree = $form['#tree'];
         $form = array(
           '#parents' => $parents,
           '#node' => $node,
           '#tree' => $tree,
           '#array_parents' => array(),
         );
        $form_state['process_input'] = FALSE;
        // TODO: add link to request access.
        $form['unauthorized'] = array(
          '#markup' => isset($campaign_node->field_p2p_private_access_message[$language][0]['value']) ? $campaign_node->field_p2p_private_access_message[$language][0]['value'] : '',
        );
        return;
      }
      // Campaign name, default from parent campaign.
      $form['title']['#default_value'] = $campaign_node->title;
      // Campaign intro, default from parent campaign, display disabled content
      // preview if edit is disabled.
      if (isset($campaign_node->field_p2p_personal_intro[$language][0]['value'])) {
        $form['body'][$language][0]['#default_value'] = $campaign_node->field_p2p_personal_intro[$language][0]['value'];
      }
      else {
        // No intro is set on the parent campaign so we need to make sure body is editable.
        $campaign_node->field_p2p_personal_intro_edit[$language][0]['value'] = TRUE;
      }

      // Hide campaign select box if campaign has been provided in the url.
      $form['field_p2p_campaign'][$language]['#default_value'] = $campaign_node->nid;
      $form['field_p2p_campaign'][$language]['#access'] = FALSE;

      // Images, default values from parent campaign, hide if edit is disabled.
      if (!$ajax) {
        $empty_image = $form['field_p2p_campaign_images'][$language][0];
        $images_editable = $campaign_node->field_p2p_images_edit[$language][0]['value'] ? TRUE : FALSE;
        foreach($campaign_node->field_p2p_images[$language] as $index => $image) {
          if (!isset($form['field_p2p_campaign_images'][$language][$index])) {
            $form['field_p2p_campaign_images'][$language][$index] = $form['field_p2p_campaign_images'][$language][0];
          }
          $form['field_p2p_campaign_images'][$language][$index]['#default_value']['fid'] = $image['fid'];
          $form['field_p2p_campaign_images'][$language][$index]['#default_value']['display'] = TRUE;
        }
        $form['field_p2p_campaign_images'][$language][$index + 1] = $empty_image;
      }
      // Embedded video, default values from parent campaign, hide if edit
      // is disabled.
      $video_editable = $campaign_node->field_p2p_video_embed_edit[$language][0]['value'] ? TRUE : FALSE;
      if (isset($campaign_node->field_p2p_video_embed[$language])) {
        $form['field_p2p_video_embed'][$language][0]['video_url']['#default_value'] = $campaign_node->field_p2p_video_embed[$language][0]['video_url'];
      }
    }
  }
  else {
    // Node edit of some variety. We'll need to load the original campaign
    // node to control visibility of conditionally editable fields.
    $language = $form['language']['#value'];
    $campaign_node = node_load($form['field_p2p_campaign'][$language]['#default_value'][0]);

  }
  // Hide uneditable fields
  if ($campaign_node) {
    // Manage personal campaign goal fields.
    $goal_type = springboard_p2p_get_goal_type_from_campaign($campaign_node);

    switch ($goal_type) {
      case 'amount':
        $form['field_p2p_personal_submit_goal']['#access'] = FALSE;
        break;

      case 'submissions':
        $form['field_p2p_personal_campaign_goal']['#access'] = FALSE;
        break;
      default:
        break;
    }
    $video_editable = $campaign_node->field_p2p_video_embed_edit[$language][0]['value'] ? TRUE : FALSE;
    $images_editable = $campaign_node->field_p2p_images_edit[$language][0]['value'] ? TRUE : FALSE;
    $can_edit_body = $campaign_node->field_p2p_personal_intro_edit[$language][0]['value'];
    // Hide the campaign select box.
    $form['field_p2p_campaign'][$language]['#access'] = FALSE;
    if (!$can_edit_body) {
      $form['body'][$campaign_node->language]['#access'] = FALSE;
      $form['body']['display'] = array(
        '#title' => $form['body'][$campaign_node->language][0]['#title'],
        '#type' => 'textarea',
        '#default_value' => $form['body'][$campaign_node->language][0]['#default_value'],
        '#disabled' => TRUE,
      );
    }
    $form['field_p2p_campaign_images']['#access'] = $images_editable;
    $form['field_p2p_video_embed']['#access'] = $video_editable;
  }
  // Hide revision UI
  $form['revision_information']['#access'] = FALSE;
  // Hide progress fields
  $form['field_p2p_campaign_progress']['#access'] = FALSE;
  $form['#validate'][] = 'springboard_p2p_personal_campaign_validate';
}

/**
 * Validate handler for the personal campaign node form.
 */
function springboard_p2p_personal_campaign_validate(&$form, $form_state) {
  // Validate campaign url alias for uniqueness.
  $language = $form_state['values']['language'];
  $alias = isset($form_state['values']['field_personal_campaign_url'][$language][0]['value']) ? $form_state['values']['field_personal_campaign_url'][$language][0]['value'] : FALSE;
  if ($alias && $path = drupal_lookup_path('source', $alias)) {
    // We only want to throw a validation error if the campaign url is in use
    // by some other path.
    if (isset($form_state['node']) && $path != 'node/' . $form_state['node']->nid) {
      form_set_error('field_personal_campaign_url', t('This url is already in use.'));
    }
  }
}

/**
 * Redirect to personal campaign node add form with campaign in url.
 */
function springboard_p2p_personal_campaign_ajax(&$form, &$form_state) {
  $language = $form_state['values']['language'];
  $campaign = $form_state['values']['field_p2p_campaign'][$language][0]['target_id'];
  ctools_include('ajax');
  ctools_add_js('ajax-responder');
  $options = array(
    'query' => array(
      'campaign' => $campaign,
    ),
  );
  $commands[] = ctools_ajax_command_redirect('node/add/p2p-personal-campaign', 0, $options);
  print ajax_render($commands);
  exit;
}

/**
 * Implements hook_node_insert().
 */
function springboard_p2p_node_insert($node) {
  if ($node->type == 'p2p_personal_campaign') {
    // manage url alias for personal campaign node type
    $alias = isset($node->field_personal_campaign_url[$node->language][0]['value']) ? $node->field_personal_campaign_url[$node->language][0]['value'] : FALSE;
    // Discard existing alias settings if the node is being cloned.
    if ($alias && !isset($node->clone_from_original_nid)) {
      $path = array(
        'source' => 'node/' . $node->nid,
        'alias' => $alias,
      );
      path_save($path);
    }
  }
}

/**
 * Implements hook_node_update().
 */
function springboard_p2p_node_update($node) {
  // manage url alias for personal campaign node type
  if ($node->type == 'p2p_personal_campaign') {
    $alias = FALSE;
    if (isset($node->field_personal_campaign_url[$node->language]) && is_array($node->field_personal_campaign_url[$node->language])) {
      $alias = count($node->field_personal_campaign_url[$node->language]) ? $node->field_personal_campaign_url[$node->language][0]['value'] : FALSE;
    }
    if ($alias) {
      $path = array(
        'source' => 'node/' . $node->nid,
        'alias' => $alias,
      );
      // Force an update if path settings already exist for this node.
      if (isset($node->path['pid']) && $node->path['pid']) {
        $path['pid'] = $node->path['pid'];
      }
      path_save($path);
    }
  }
  // Propagate changes to campaign fields to personal campaigns when fields are
  // flagged "uneditable" by personal campaign owners.
  if ($node->type == 'p2p_campaign') {
    $update_settings = array();
    $language = $node->language;
    // campaign intro
    if (!$node->field_p2p_personal_intro_edit[$language][0]['value']) {
      $update_settings['body'] = $node->field_p2p_personal_intro[$language][0]['value'];
    }
    // images
    if (!$node->field_p2p_images_edit[$language][0]['value']) {
      $update_settings['field_p2p_campaign_images'] = $node->field_p2p_images[$language];
    }
    // video
    if (!$node->field_p2p_video_embed_edit[$language][0]['value']) {
      $update_settings['field_p2p_video_embed'] = $node->field_p2p_video_embed[$language][0];
    }
    if (count($update_settings)) {
      $associated_private_campaigns = springboard_p2p_get_personal_campaigns($node->nid);
      foreach($associated_private_campaigns as $nid => $private_campaign) {
        $private_campaign = (array) $private_campaign;
        $node_changed = FALSE;
        foreach ($update_settings as $field_key => $field_settings) {
          switch ($field_key) {
            // Intentional fallthrough, both fields structure data similarly.
            case 'body':
            case 'field_p2p_video_embed':
              if (!isset($private_campaign[$field_key][$language][0]['value']) || $private_campaign[$field_key][$language][0]['value'] != $field_settings) {
                $private_campaign[$field_key][$language][0]['value'] = $field_settings;
                $node_changed = TRUE;
              }
              break;
            case 'field_p2p_campaign_images':
              if ($private_campaign['field_p2p_campaign_images'][$language] != $field_settings) {
                $private_campaign['field_p2p_campaign_images'][$language] = $field_settings;
                $node_changed = TRUE;
              }
              break;
          }
        }
        if ($node_changed) {
          node_save((object) $private_campaign);
          $link = l(t($private_campaign['title']), 'node/' . $private_campaign['nid']);
          drupal_set_message(t('Updated private campaign: !link', array('!link' => $link)));
        }
      }
    }
  }
}

/**
 * Checks campaign for user authorization to create a personal campaign.
 *
 * @param int $nid
 *   Node id of the campaign.
 *
 * @param int $uid
 *   User id.
 *
 * @return bool
 *   Returns TRUE if the user account is authorized for this campaign,
 *   FALSE otherwise.
 */
function springboard_p2p_private_campaign_user_is_authorized($nid, $uid) {
  $result = db_query('SELECT status FROM {springboard_p2p_private_campaign_approval} WHERE uid = :uid AND nid = :nid', array(':uid' => $uid, ':nid' => $nid));
  $status = $result->fetchField();
  return $status == 'approved' ? TRUE : FALSE;
}

/**
 * Determine if the form we're altering is a node create (and not edit) form.
 *
 * @param array $form
 *   The forms api array.
 *
 * @return bool
 *   TRUE if this is node create, not node edit, and not a preview.
 */
function springboard_p2p_form_is_node_create($form) {
  return empty($form['nid']['#value']) && (!isset($form['#node']->op));
}

/**
 * Get all campaigns that are set to require approval.
 *
 * @return array
 *   The loaded campaign entities, keyed by nid.
 */
function springboard_p2p_get_private_campaigns() {
  $campaign_items = array();

  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'p2p_campaign')
    ->propertyCondition('status', 1)
    ->fieldCondition('field_p2p_campaigns_approval', 'value', 1, '=')
    ->propertyOrderBy('title', 'ASC');

  $result = $query->execute();

  if (isset($result['node'])) {
    $campaign_items_nids = array_keys($result['node']);
    $campaign_items = entity_load('node', $campaign_items_nids);
  }

  return $campaign_items;
}

/**
 * Get the personal campaigns related to a given campaign.
 *
 * @param int $nid
 *   The nid of the p2p Campaign.
 *
 * @return array
 *   The loaded personal campaign entities, keyed by nid.
 */
function springboard_p2p_get_personal_campaigns($nid) {
  $campaign_items = array();

  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'p2p_personal_campaign')
    ->fieldCondition('field_p2p_campaign', 'target_id', $nid, '=')
    ->propertyOrderBy('created', 'DESC');

  $result = $query->execute();

  if (isset($result['node'])) {
    $campaign_items_nids = array_keys($result['node']);
    $campaign_items = entity_load('node', $campaign_items_nids);
  }

  return $campaign_items;
}

/**
 * Checks if any content types have been enabled for p2p campaign goals.
 *
 * @return bool
 *   TRUE if no content types are enabled for p2p goals.
 */
function springboard_p2p_no_content_types_enabled() {

  $fundraiser = variable_get('springboard_p2p_fundraiser_items', array());
  $webform_user = variable_get('springboard_p2p_webform_user_items', array());

  return (empty($fundraiser) && empty($webform_user));
}

/**
 * Get the enabled goal type from a campaign.
 *
 * @param object $campaign
 *   The campaign node.
 *
 * @return string
 *   'submissions' or 'amount'
 */
function springboard_p2p_get_goal_type_from_campaign($campaign) {
  $goal = springboard_p2p_get_goal_from_campaign($campaign);
  return $goal['goal_type'];
}

/**
 * Get the goal value for the enabled goal from a campaign.
 *
 * @param object $campaign
 *   The campaign node.
 *
 * @return int
 *   Dollar amount or number of submissions.
 */
function springboard_p2p_get_goal_value_from_campaign($campaign) {
  $goal = springboard_p2p_get_goal_from_campaign($campaign);
  return $goal['goal_value'];
}

/**
 * Get the enabled goal data from a campaign.
 *
 * @param object $campaign
 *   The campaign node.
 *
 * @return array
 *   An array with 'goal_type' and 'goal_value" keys, and optionally other
 *   goal data.
 *
 * @todo This only handles a single enabled goal.
 */
function springboard_p2p_get_goal_from_campaign($campaign) {
  $goal_set_id = $campaign->field_p2p_campaign_goals[$campaign->language][0]['goal_set_id'];
  $goals_field = new SpringboardP2pCampaignGoalsField();
  $goals = $goals_field->load($goal_set_id);
  foreach ($goals as $goal) {
    if ($goal['enabled']) {
      return $goal;
    }
  }

  // Somewhat safe default.
  return array(
    'goal_type' => 'submissions',
    'goal_value' => 0,
  );
}

/**
 * Formats the goal progress according to its goal type.
 *
 * @param array|number $progress
 *   An array with 'submissions' and 'amount' keys and their goal values.
 *   Or a single value.
 * @param string $type
 *   The goal type.
 * @param bool $include_units
 *   Whether to include a prefix/suffix with the goal units.
 *
 * @return string
 *   The formatted value.
 */
function springboard_p2p_format_progress($progress, $type, $include_units = TRUE) {
  $output = '';

  // If only a value is passed in.
  if (!is_array($progress)) {
    $progress = array(
      $type => $progress,
    );
  }

  switch ($type) {
    case 'submissions':
      $output .= number_format($progress['submissions']);
      if ($include_units) {
        $output .= ' submissions';
      }
      break;

    case 'amount':
      if ($include_units) {
        $output .= '$ ';
      }
      $output .= number_format($progress['amount'], 2);
      break;
  }

  return $output;
}

/**
 * Formats the percent complete of a goal.
 *
 * @param int $progress
 *   The number of submissions/amount of the current progress.
 * @param int $goal
 *   The goal value.
 *
 * @return string
 *   The formatted integer value with a percent sign.
 */
function springboard_p2p_format_percent($progress, $goal) {
  if ($goal > 0) {
    return (int) ($progress / $goal * 100) . ' %';
  }

  return '0 %';
}

/**
 * Access handler for personal campaign pages.
 *
 * @see user_view_access($account)
 */
function springboard_p2p_personal_dashboard_view_access($account) {
  return springboard_p2p_complete_profile_form_access($account);
}

/**
 * Implements hook_fboauth_user_presave().
 *
 * Change the username to the email address.  Also save a random password
 * if one doesn't exist.
 */
function springboard_p2p_fboauth_user_presave(&$edit, $fbuser) {
  if (!empty($edit['mail'])) {
    $edit['name'] = $edit['mail'];
  }

  if (empty($edit['pass'])) {
    $edit['pass'] = user_password();
  }
}

/**
 * Access callback for the complete profile form.
 */
function springboard_p2p_complete_profile_form_access($account) {
  if (empty($account->uid)) {
    return FALSE;
  }
  elseif (user_access('administer users')) {
    return TRUE;
  }
  else {
    return $GLOBALS['user']->uid == $account->uid;
  }
}

/**
 * Check if the entity has empty required fields.
 *
 * @param object $entity
 *   The user object.
 *
 * @return bool
 *   TRUE if the user has empty fields that are required.
 */
function springboard_p2p_complete_profile_user_has_empty_required_fields($entity) {
  $entity_type = 'user';

  list(, , $bundle) = entity_extract_ids($entity_type, $entity);
  $instances = field_info_instances($entity_type, $bundle);

  $required_fields = springboard_p2p_get_required_registration_fields();

  foreach ($instances as $field_name => $instance) {
    // Only check required fields.
    if (!empty($required_fields[$field_name])) {
      // Check if the required field is empty.
      if (springboard_p2p_complete_profile_field_is_empty($entity_type, $entity, $instance['field_name'])) {
        // Check that the user can actually edit their missing field.
        if (field_access('edit', field_info_field($instance['field_name']), $entity_type, $entity, $entity)) {
          return TRUE;
        }
      }
    }
  }

  return FALSE;
}

/**
 * Check if a field module field is empty.
 *
 * @param string $entity_type
 *   Should be 'user' for our purposes.
 * @param object $entity
 *   The user object.
 * @param string $field_name
 *   The name of the field to check.
 *
 * @return bool
 *   TRUE if the field is empty.
 */
function springboard_p2p_complete_profile_field_is_empty($entity_type, $entity, $field_name) {
  if (!isset($entity->{$field_name})) {
    return TRUE;
  }

  if ($items = field_get_items($entity_type, $entity, $field_name)) {
    // @todo Do we need to run filtering on values?
    // $field = field_info_field($field_name);
    // $items = _field_filter_items($field, $items);
    return empty($items);
  }

  return TRUE;
}

/**
 * Get the values for a drupal_goto() to the p2p complete profile page.
 *
 * @return array
 *   An array with path and options keys for use in drupal_goto().
 */
function springboard_p2p_complete_profile_get_redirect() {
  $redirect = array();
  $redirect['path'] = 'user/' . $GLOBALS['user']->uid . '/complete-p2p-profile';
  $redirect['options'] = array('query' => array());

  $destination = drupal_get_destination();
  // Unset the global destination since we don't want drupal_goto() to read
  // it and since we're passing the destination into the query string again.
  unset($_GET['destination']);
  $redirect['options']['query'] += $destination;

  return $redirect;
}

/**
 * Get only the reg fields that have been enabled in the p2p settings.
 *
 * @return array
 *   The enabled profile fields.
 */
function springboard_p2p_get_enabled_registration_fields() {
  $fields = variable_get('springboard_p2p_registration_fields', array());

  foreach ($fields as $key => $field) {
    if (!$field['enabled']) {
      unset($fields[$key]);
    }
  }

  return $fields;
}

/**
 * Get only the reg fields that are enabled and required in the p2p settings.
 *
 * @return array
 *   The required profile fields.
 */
function springboard_p2p_get_required_registration_fields() {
  $fields = springboard_p2p_get_enabled_registration_fields();

  foreach ($fields as $key => $field) {
    if (!$field['required']) {
      unset($fields[$key]);
    }
  }

  return $fields;
}

/**
 * Make a registration field on the p2p register page required or not.
 *
 * The registration fields are nested and weird, so I try to do this in a very
 * general way to handle custom user profile fields.
 *
 * @param array $form
 *   The form array for the p2p register page.
 * @param string $field_name
 *   The name of the field to make required.
 * @param bool $required
 *   The value for #required.
 */
function springboard_p2p_set_registration_field_required(&$form, $field_name, $required = TRUE) {
  $field_language = $form[$field_name]['#language'];
  $form[$field_name][$field_language]['#required'] = $required;
  $keys = element_children($form[$field_name][$field_language]);
  foreach ($keys as $key) {
    $form[$field_name][$field_language][$key]['#required'] = $required;
    if (isset($form[$field_name][$field_language][$key]['value'])) {
      $form[$field_name][$field_language][$key]['value']['#required'] = $required;
    }
  }
}

/**
 * Add the campaign ID value form element and submit handler to a form.
 *
 * The submit handler should happen last because it sets the redirect and should
 * override any other redirects.  So call this near the end of the form.
 *
 * @param array $form
 *   The form array to insert the element into.
 */
function springboard_p2p_campaign_id_form_element(&$form) {
  $form['springboard_p2p_campaign_nid'] = array(
    '#type' => 'value',
    '#value' => springboard_p2p_get_campaign_id_from_request(),
  );

  // This handler changes the redirect.
  $form['#submit'][] = 'springboard_p2p_set_redirect';
}

/**
 * Gets a campaign ID from the URL.
 *
 * @return int|null
 *   The campaign ID, or NULL if one can't be found.
 */
function springboard_p2p_get_campaign_id_from_request() {
  if (isset($_GET['p2p_cid']) && is_numeric($_GET['p2p_cid'])) {
    return $_GET['p2p_cid'];
  }

  return NULL;
}

/**
 * Submit handler.
 *
 * Saves the campaign approval status and changes the redirect.
 */
function springboard_p2p_set_redirect($form, &$form_state) {

  if (!empty($form_state['uid'])) {
    $uid = $form_state['uid'];
  }
  elseif (!empty($form_state['user']->uid)) {
    $uid = $form_state['user']->uid;
  }
  else {
    // Bail!
    return;
  }

  // Default destination if nothing else works.
  $form_state['redirect'] = 'user/' . $uid . '/personal-campaigns';

  if (!empty($form_state['values']['springboard_p2p_campaign_nid'])) {
    $campaign_id = $form_state['values']['springboard_p2p_campaign_nid'];
    $campaign = node_load($campaign_id);
    if (is_object($campaign) && $campaign->type == 'p2p_campaign') {
      $private = springboard_p2p_campaign_is_private($campaign);

      $approval = new SpringbaordP2pPrivateCampaignApproval($uid, $campaign_id);

      if ($private) {
        $approval->request();
        drupal_set_message('You have been added to the approval queue for ' . $campaign->title);
        $form_state['redirect'] = 'user/' . $uid . '/personal-campaigns';

        $account = user_load($uid);

        $event = new SpringboardP2pEvents();
        $event->userRequestsApprovalForPrivateCampaign($account, $campaign);
      }
      else {
        $approval->approve();
        drupal_set_message('You can now create a personal campaign in ' . $campaign->title);

        $form_state['redirect'] = array(
          'node/add/p2p-personal-campaign',
          array(
            'query' => array(
              'p2p_cid' => $campaign_id,
            ),
          ),
        );

      }
    }
  }
}

/**
 * Determines if a p2p campaign node is private (approval required).
 *
 * @param object $campaign
 *   The campaign node object.
 *
 * @return bool
 *   TRUE if the campaign is private.
 */
function springboard_p2p_campaign_is_private($campaign) {
  if (!empty($campaign->field_p2p_campaigns_approval[$campaign->language][0]['value'])) {
    return (bool) $campaign->field_p2p_campaigns_approval[$campaign->language][0]['value'];
  }

  return FALSE;
}

/**
 * Is the user registered for p2p.
 *
 * @param int $uid
 *   User ID.
 *
 * @return bool
 *   TRUE if the user is registered for p2p.
 */
function springboard_p2p_user_is_registered_for_p2p($uid) {
  $account = user_load($uid);
  $role = user_role_load_by_name(SPRINGBOARD_P2P_ROLE);

  return in_array($role->rid, array_keys($account->roles));
}

/**
 * Registers user for p2p.
 *
 * @param int $uid
 *   User ID.
 */
function springboard_p2p_register_user_for_p2p($uid) {
  $role = user_role_load_by_name(SPRINGBOARD_P2P_ROLE);
  $account = user_load($uid);
  $roles = $account->roles + array($role->rid => $role->name);
  // For efficiency manually save the original account before applying
  // any changes.
  $account->original = clone $account;
  user_save($account, array('roles' => $roles));
}

/**
 * Implements hook_mail().
 *
 * @todo Should we move the password reset email to rules?
 */
function springboard_p2p_mail($key, &$message, $params) {
  switch ($key) {
    case 'password_reset':
      springboard_p2p_password_reset_mail($message, $params);
      break;

  }
}

/**
 * Mail template to send to a user who needs a password reset.
 *
 * @see springboard_p2p_mail()
 */
function springboard_p2p_password_reset_mail(&$message, $params) {
  $options = array(
    'langcode' => $message['language']->language,
  );

  $message['subject'] = t('P2P password reset', $options);
  $message['body'][] = t('Here is your password reset link.', $options);
  $message['body'][] = springboard_p2p_set_password_url($params['account']);
}

/**
 * Provides a custom url for setting a password in the context of p2p.
 *
 * @param object $account
 *   The user that needs to set a password.
 *
 * @return string
 *   The URL to the P2P set password page for the account.
 */
function springboard_p2p_set_password_url($account) {
  $url = user_pass_reset_url($account);
  return str_replace('user/reset/', 'springboard_p2p/set_password/', $url);
}

/**
 * Verify the email address will be a valid username.
 *
 * Returns email specific error messages.
 *
 * @param string $mail
 *   The email address to check.
 *
 * @return string|NULL
 *   The email specific error, or NULL for no errors.
 *
 * @see user_validate_name()
 */
function springboard_p2p_validate_email_as_username($mail) {
  if (strpos($mail, '  ') !== FALSE) {
    return t('The e-mail address cannot contain multiple spaces in a row.');
  }
  if (preg_match('/[^\x{80}-\x{F7} a-z0-9@_.\'-]/i', $mail)) {
    return t('The e-mail address contains an illegal character.');
  }
  // Non-printable ISO-8859-1 + NBSP.
  if (preg_match('/[\x{80}-\x{A0}' .
    // Soft-hyphen.
    '\x{AD}' .
    // Various space characters.
    '\x{2000}-\x{200F}' .
    // Bidirectional text overrides.
    '\x{2028}-\x{202F}' .
    // Various text hinting characters.
    '\x{205F}-\x{206F}' .
    // Byte order mark.
    '\x{FEFF}' .
    // Full-width latin.
    '\x{FF01}-\x{FF60}' .
    // Replacement characters.
    '\x{FFF9}-\x{FFFD}' .
    // NULL byte and control characters.
    '\x{0}-\x{1F}]/u',
    $mail)) {
    return t('The e-mail address contains an illegal character.');
  }
  if (drupal_strlen($mail) > USERNAME_MAX_LENGTH) {
    return t('The e-mail address %name is too long: it must be %max characters or less.', array('%name' => $mail, '%max' => USERNAME_MAX_LENGTH));
  }

}

/**
 * Implements hook_forms().
 *
 * For the add rules form, call the rules admin form.
 *
 * @see commerce_payment_ui_forms()
 */
function springboard_p2p_forms($form_id, $args) {
  $forms = array();

  $forms['springboard_p2p_add_rule_form'] = array(
    'callback' => 'rules_admin_add_reaction_rule',
  );

  return $forms;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * @see commerce_payment_ui_form_commerce_payment_ui_add_payment_rule_form_alter()
 * @see commerce_payment_ui_add_payment_rule_form_submit()
 * @see rules_admin_add_reaction_rule()
 */
function springboard_p2p_form_springboard_p2p_add_rule_form_alter(&$form, &$form_state) {
  unset($form['settings']['help']);

  // Only show P2P events.
  $form['settings']['event']['#options'] = $form['settings']['event']['#options']['Springboard P2P'];

  // Add a default tag.
  $form['settings']['tags']['#default_value'] = 'Springboard P2P';

  $form['submit']['#suffix'] = l(t('Cancel'), 'admin/springboard/p2p/rules');
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function springboard_p2p_menu_local_tasks_alter(&$data, $router_item, $root_path) {
  // Add action link 'admin/springboard/p2p/rules/add' on
  // 'admin/springboard/p2p/rules'.
  if ($root_path == 'admin/springboard/p2p/rules') {
    $item = menu_get_item('admin/springboard/p2p/rules/add');
    if ($item['access']) {
      $data['actions']['output'][] = array(
        '#theme' => 'menu_local_action',
        '#link' => $item,
      );
    }
  }
}

/**
 * Implements hook_form_alter().
 *
 * Adds extra data to a p2p enabled form if a personal campaign ID is passed in.
 */
function springboard_p2p_form_alter(&$form, &$form_state, $form_id) {
  if (isset($_GET['p2p_pcid']) && is_numeric($_GET['p2p_pcid']) && strpos($form_id, 'webform_client_form_') !== FALSE && !empty($form['#node'])) {
    $type = $form['#node']->type;
    $personal_campaign_id = $_GET['p2p_pcid'];

    $is_fundraiser_type = fundraiser_is_donation_type($type);
    $is_webform_user_type = _webform_user_is_webform_user_node_type($type);
    if ($is_fundraiser_type || $is_webform_user_type) {

      $personal_campaign = node_load($personal_campaign_id);

      if ($personal_campaign->type == 'p2p_personal_campaign') {

        $campaign_id = $personal_campaign->field_p2p_campaign[$personal_campaign->language][0]['target_id'];

        $form['#submit'][] = 'springboard_p2p_webform_client_form_submit';

        if ($is_fundraiser_type) {
          $action_type = 'fundraiser';
        }
        else {
          $action_type = 'webform_user';
        }

        $form['springboard_p2p_personal_campaign_action'] = array(
          '#type' => 'fieldset',
          '#title' => 'P2P',
          '#tree' => TRUE,
          'action_type' => array(
            '#type' => 'value',
            '#value' => $action_type,
          ),
          'category_nid' => array(
            '#type' => 'value',
            '#value' => '',
          ),
          'campaign_nid' => array(
            '#type' => 'value',
            '#value' => $campaign_id,
          ),
          'personal_campaign_nid' => array(
            '#type' => 'value',
            '#value' => $personal_campaign->nid,
          ),
          'personal_campaign_uid' => array(
            '#type' => 'value',
            '#value' => $personal_campaign->uid,
          ),
          'form_nid' => array(
            '#type' => 'value',
            '#value' => $form['#node']->nid,
          ),
        );

        $form['springboard_p2p_personal_campaign_action']['show_name'] = array(
          '#type' => 'checkbox',
          '#title' => t('Show my name on the campaign page'),
        );

        $form['springboard_p2p_personal_campaign_action']['comment'] = array(
          '#type' => 'textarea',
          '#title' => t('Comment'),
        );

        drupal_set_title($personal_campaign->title);

        $owner = user_load($personal_campaign->uid);
        $owner_name = springboard_p2p_format_user_full_name($owner);

        $campaign = node_load($campaign_id);
        if (!empty($campaign) && $campaign->type == 'p2p_campaign') {

          $category_id = $campaign->field_p2p_category[$campaign->language][0]['target_id'];
          $form['springboard_p2p_personal_campaign_action']['category_nid']['#value'] = $category_id;

          // @todo Confirm that this donation form nid is selected from the
          // campaign goals.
          // $header = springbaord_p2p_format_campaign_form_header($campaign);
          // if (count($header)) {
          // $form['submitted']['springboard_p2p']['header'] = $header;
          // }
          $goal_type = springboard_p2p_get_goal_type_from_campaign($campaign);
          $formatted_progress = springboard_p2p_format_progress($personal_campaign->field_p2p_campaign_progress[$personal_campaign->language][0], $goal_type);
          $formatted_goal = springboard_p2p_format_progress($personal_campaign->field_p2p_personal_campaign_goal[$personal_campaign->language][0]['value'], $goal_type);
          $form['submitted']['springboard_p2p'] = array(
            '#type' => 'container',
            '#tree' => TRUE,
            '#weight' => -200,
            'owner' => array(
              '#markup' => '<h2>' . $owner_name . '</h2>',
            ),
            'progress' => array(
              '#prefix' => '<div>' . t('Progress') . ' ',
              '#markup' => $formatted_progress,
              '#suffix' => '</div>',
            ),
            'goal' => array(
              '#prefix' => '<div>' . t('Goal') . ' ',
              '#markup' => $formatted_goal,
              '#suffix' => '</div>',
            ),
          );
        }
      }
    }
  }
}

/**
 * Submit function for the p2p enabled form.
 *
 * Increments the submissions counter for the personal campaign. We do this here
 * instead of in the post_submit below so we can count submissions on
 * non-fundraiser forms.
 */
function springboard_p2p_webform_client_form_submit($form, &$form_state) {

  if (!empty($form_state['values']['springboard_p2p_personal_campaign_action'])) {
    $action = $form_state['values']['springboard_p2p_personal_campaign_action'];
    if ($action['action_type'] == 'webform_user') {
      springboard_p2p_submit_personal_campaign_action($action);
    }
  }
}

/**
 * Implements hook_fundraiser_donation_post_submit().
 *
 * Adds the initial donation amount to the personal campaign progress.
 */
function springboard_p2p_fundraiser_donation_post_submit($form, $form_state, $donation) {

  if (!empty($donation->recurring) && ($donation->recurring->master_did != $donation->did)) {
    return;
  }

  if (!$donation->result['success']) {
    return;
  }

  if (!empty($form_state['values']['springboard_p2p_personal_campaign_action'])) {
    $action = $form_state['values']['springboard_p2p_personal_campaign_action'];
    if ($action['action_type'] == 'fundraiser') {
      springboard_p2p_submit_personal_campaign_action($action, $donation);
    }
  }

}

function springboard_p2p_format_user_full_name($account) {
  $language = !empty($account->language) ? $account->language : 'und';
  $full_name = '';
  if (!empty($account->sbp_first_name[$language][0]['safe_value']) && !empty($account->sbp_last_name[$language][0]['safe_value'])) {
    $full_name = $account->sbp_first_name[$language][0]['safe_value'] . ' ' . $account->sbp_last_name[$language][0]['safe_value'];
  }

  return $full_name;
}

/**
 * Increment the personal campaign progress and save the action.
 *
 * @param array $action
 *   The action array as it came from form_state.
 * @param object|null $donation
 *   If this is a fundraiser action, pass in the donation.
 */
function springboard_p2p_submit_personal_campaign_action($action, $donation = NULL) {
  if (!empty($action['personal_campaign_nid'])) {
    $personal_campaign = node_load($action['personal_campaign_nid']);

    // Incremenet the submissions progress.
    ++$personal_campaign->field_p2p_campaign_progress[$personal_campaign->language][0]['submissions'];

    // If a donation was passed in then we have a fundraiser action
    // and should increment the amount progress.
    if (!is_null(($donation))) {
      $action['uid'] = $donation->uid;
      $amount = $donation->donation['amount'];
      if (!empty($donation->donation['quantity'])) {
        $amount = $amount * $donation->donation['quantity'];
      }
      $personal_campaign->field_p2p_campaign_progress[$personal_campaign->language][0]['amount'] += $amount;
      $action['amount'] = $amount * 100;
    }
    node_save($personal_campaign);
  }

  springboard_p2p_save_personal_campaign_action($action);
}

/**
 * Saves a new personal campaign action record.
 *
 * @param array $record
 *   The record to write to the table.
 */
function springboard_p2p_save_personal_campaign_action($record) {
  $record = (array) $record;

  if (empty($record['created'])) {
    $record['created'] = REQUEST_TIME;
  }

  drupal_write_record('springboard_p2p_personal_campaign_action', $record);
}

/**
 * Takes a campaign and returns the form element for its header image.
 *
 * @param object $campaign
 *   The campaign node.
 *
 * @return array
 *   The form element for the header image.
 */
function springbaord_p2p_format_campaign_form_header($campaign) {
  if ($campaign->type == 'p2p_campaign' && isset($campaign->field_p2p_campaign_banner) && !empty($campaign->field_p2p_campaign_banner[$campaign->language])) {

    $display = array(
      'settings' => array(
        'image_link' => 'content',
        'image_style' => 'large',
      ),
    );

    return image_field_formatter_view(
      'p2p_campaign',
      $campaign,
      array(),
      array(),
      $campaign->language,
      $campaign->field_p2p_campaign_banner[$campaign->language],
      $display
    );
  }

  return array();
}

function springboard_p2p_page_alter(&$page) {
  if (isset($_GET['p2p_pcid']) && is_numeric($_GET['p2p_pcid']) && arg(0) == 'node' && is_numeric(arg(1)) && is_null(arg(2))) {
    $personal_campaign_id = $_GET['p2p_pcid'];

    $node = node_load(arg(1));
    $type = $node->type;
    $is_fundraiser_type = fundraiser_is_donation_type($type);
    $is_webform_user_type = _webform_user_is_webform_user_node_type($type);
    if ($is_fundraiser_type || $is_webform_user_type) {
      $personal_campaign = node_load($personal_campaign_id);
      if ($personal_campaign->type == 'p2p_personal_campaign') {

        $campaign_id = $personal_campaign->field_p2p_campaign[$personal_campaign->language][0]['target_id'];
        $campaign = node_load($campaign_id);
        if (!empty($campaign) && $campaign->type == 'p2p_campaign') {

          $page['page_top']['springboard_p2p_banner'] = springbaord_p2p_format_campaign_form_header($campaign);
        }
      }
    }
  }

}

function springboard_p2p_get_personal_campaign_comments($nid) {
  $query = db_query("SELECT action_type, uid, show_name, amount, comment, created FROM {springboard_p2p_personal_campaign_action} WHERE personal_campaign_nid = :nid ORDER BY created DESC", array(':nid' => $nid));
  return $query->fetchAll(PDO::FETCH_ASSOC);
}
