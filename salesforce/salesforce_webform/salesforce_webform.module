<?php

/**
 * @file
 * Manages webform to Salesforce mappings.
 */

/**
 * @defgroup core_drupal_hooks
 * @{
 */

/**
 * Implements hook_entity_info().
 */
function salesforce_webform_entity_info() {
  return array(
    'salesforce_webform_map' => array(
      'label' => t('Salesforce Webform Map'),
      'entity class' => 'Entity',
      'controller class' => 'EntityAPIControllerExportable',
      'base table' => 'salesforce_webform_map',
      'entity keys' => array(
        'id' => 'nid',
      ),
      'fieldable' => FALSE,
      'exportable' => TRUE,
      'module' => 'salesforce_webform',
    ),
  );
}

/**
 * Implements hook_menu().
 */
function salesforce_webform_menu() {
  // %webform_menu returns $node if $node is a webform
  $items['node/%webform_menu/webform/salesforce-map'] = array(
    'title' => 'Salesforce map',
    'page callback' => 'salesforce_webform_map_page',
    'page arguments' => array(1),
    'access callback' => 'salesforce_webform_map_page_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'file' => 'includes/salesforce_webform.map.inc',
  );
  $items['admin/config/content/salesforce-webform'] = array(
    'title' => 'Salesforce Webform Settings',
    'page callback' => 'salesforce_webform_admin_page',
    'description' => 'Configure how the Salesforce integration will work with webform submissions.',
    // I am assuming that if you can configure Salesforce you also understand
    // the best way to configure the Salesforce webform interface
    'access arguments' => array('administer salesforce'),
    'file' => 'includes/salesforce_webform.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function salesforce_webform_permission() {
  return array(
    'map salesforce to webform' => array(
      'title' => t('Map Salesforce objects to webforms'),
      'description' => t('Configure the mapping of Salesforce objects with
        webforms so submissions can sync with Salesforce.'),
    ),
  );
}

/**
 * @} core_drupal_hooks
 */


/**
 * Access callback to reach the mapping page
 *
 * All by its little old self because menu doesn't load the include file until
 * after the access check.
 */
function salesforce_webform_map_page_access($node) {
  if (
       $node !== FALSE // %webform_menu returns FALSE if not valid
       // @TODO: Ensure that 'donation_form' is still accurate in the D6TOD7 port
       && $node->type != 'dontation_form'
       && user_access('map salesforce to webform')
     ) {
    return TRUE;
   }
  return FALSE;
}

/**
 * Implementation of hook_node_load().
 */
function salesforce_webform_node_load($nodes, $types) {
  if (in_array('webform', $types)) {
    foreach ($nodes as $nid => $node) {
      // Add the salesforce_webform_map entity to the node
      $map = salesforce_webform_load_map($nid);
      if (is_object($map)) {
        $node->salesforce_webform_map = $map;
      }
    }
  }
}

/**
 * Implementation of hook_node_delete().
 */
function salesforce_webform_node_delete($node) {
  // delete the salesforce_webform_map entity
  salesforce_webform_delete_map($node->nid);
}

/**
 * Implementation of hook_form_alter().
 */
function salesforce_webform_form_alter(&$form, $form_state, $form_id) {
  // If form is a webform and mapped, add our submit handler
  if (
       isset($form['#node'])
       && $form_id == 'webform_client_form_'. $form['#node']->nid
       && isset($form['#node']->salesforce_webform_map)
       && !empty($form['#node']->salesforce_webform_map->field_map)
     ) {
    if (!isset($form['#submit'])) {
      $form['#submit'] = array();
    }
    $form['#submit'][] = 'salesforce_webform_client_form_submit';
    module_load_include('inc', 'salesforce_webform', 'includes/salesforce_webform.queue');
  }
}


/**
 * @defgroup salesforce_webform_map_crud Made easier with Entity API
 * @{
 */

/**
 * Creates and saves a Salesforce+Webform map
 *
 * @param $map
 *   Can be an array of values or a salesforce_webform_map entity object
 *
 * @return
 *   The new version of the object (such as if you had passed in an array) and
 *   FALSE if what you passed through was incompatible with the save process.
 */
function salesforce_webform_save_map($map) {
  if (is_array($map)) {
    // Allow sending an array and updating an existing entity with the values
    $entity = salesforce_webform_load_map($map['nid']);
    if ($entity) {
      foreach ($map as $key => $value) {
        $entity->$key = $value;
      }
      $map = $entity;
    }
    else {
      // Create a new entity object, but does not yet add to the database
      $map = entity_create('salesforce_webform_map', $map);
    }
  }
  if ($map->entityType() == 'salesforce_webform_map') {
    $map->updated = time();
    // Adds the data to the database
    return entity_save('salesforce_webform_map', $map);
  }
  return FALSE;
}

/**
 * Retreives a Salesforce+Webform map
 *
 * @param $nid
 *   The nid of the webform of whose map we want to load
 *
 * @return
 *   The entity object you requested
 */
function salesforce_webform_load_map($nid) {
  $entities = entity_load('salesforce_webform_map', array($nid));
  if (isset($entities[$nid])) {
    return $entities[$nid];
  }
  return FALSE;
}

/**
 * Deletes a Salesforce+Webform map
 *
 * @param $nid
 *   The nid of the webform of whose map we're deleting
 *
 * @return
 *   FALSE if the delete could be performed
 */
function salesforce_webform_delete_map($nid) {
  return entity_delete('salesforce_webform_map', $nid);
}

/**
 * @} salesforce_webform_map_crud
 */
